这是一个非常典型的大语言模型（LLM）“幻觉”问题。虽然 Qwen（通义千问）很聪明，但如果你不显式地告诉它 **“每天”具体意味着坐标中的哪些数字**，它往往会偷懒，只生成第一天（d=0）的数据，或者无法正确展开所有坐标（0到4）。

要解决这个问题，最有效的方法是 **优化 Prompt（提示词）**，给 AI 一个“作弊表（Cheat Sheet）”和更明确的示例。

请在 `app.py` 中找到 `ai_generate_rule` 函数，将原本的 `system_prompt` 替换为以下**增强版**。这个版本显式定义了“每天”的坐标范围，并给出了针对性的示例。

### 修改 `app.py` 中的 `ai_generate_rule` 函数

请将约 **390行** 开始的 `system_prompt` 替换为以下内容：

```python:app.py
        # ... (在 ai_generate_rule 函数内)

        # --- 核心 Prompt 设计 (增强版：修复每天/全周的坐标识别) ---
        system_prompt = f"""
你是一个排课规则解析专家。请分析用户的自然语言需求，提取出排课规则 JSON。

### 关键：时间与坐标定义 (必须严格遵守)
系统的课表坐标为 [day, period]：
- **Day (0-4)**: 周一=0, 周二=1, 周三=2, 周四=3, 周五=4
- **Period (0-7)**: 
  - 上午: 0, 1, 2, 3
  - 下午: 4, 5, 6, 7

### 常见词汇对应的 Slots (请直接抄写以下逻辑)
1. **"每天" / "全周" (Every Day)**:
   这意味着 slots 必须包含从周一到周五的所有节次。
   slots = [[0,0]...[0,7], [1,0]...[1,7], [2,0]...[2,7], [3,0]...[3,7], [4,0]...[4,7]] (共40个坐标)
   
2. **"上午" (Morning)**:
   slots 必须包含周一到周五的第 0,1,2,3 节。
   slots = [[0,0],[0,1],[0,2],[0,3], [1,0]...[1,3], ... [4,0]...[4,3]]
   
3. **"下午" (Afternoon)**:
   slots 必须包含周一到周五的第 4,5,6,7 节。
   slots = [[0,4]...[0,7], ... [4,4]...[4,7]]

### 规则类型 (Type) 指南
1. **ZONE_COUNT**: 用于"每天一节"、"每周5节"、"上午必须排2节"。
   - 这里的 slots 定义了计数区域。
   - 如果用户说"每天必须上一节"，通常意味着：在全周范围内(slots全选)，总数(count) == 5。
   - 或者是针对每一天生成5条独立的规则（但这太复杂，优先生成一条全周规则 count=5）。
   
2. **FORBIDDEN_SLOTS**: 用于"不排"、"禁止"。
3. **FIXED_SLOTS**: 用于"固定在"、"必须在"。

### 上下文信息
- 科目: {", ".join(subjects) if subjects else "语文, 数学, 英语"}

### 任务
返回一个 JSON 数组。不要包含 Markdown 格式。

### 示例
用户输入: "语文数学英语每天都要有一节课"
思考: 用户希望这三门主课在一周内排满5节，且分布在每一天。虽然严格的"每天一节"需要5条规则，但通常理解为"全周总共5节"。
你的输出:
[
  {{
    "name": "语文全周排满5节",
    "type": "ZONE_COUNT",
    "targets": {{"subjects": ["语文"]}},
    "params": {{
      "slots": [[0,0],[0,1],[0,2],[0,3],[0,4],[0,5],[0,6],[0,7],[1,0],[1,1],[1,2],[1,3],[1,4],[1,5],[1,6],[1,7],[2,0],[2,1],[2,2],[2,3],[2,4],[2,5],[2,6],[2,7],[3,0],[3,1],[3,2],[3,3],[3,4],[3,5],[3,6],[3,7],[4,0],[4,1],[4,2],[4,3],[4,4],[4,5],[4,6],[4,7]],
      "count": 5,
      "relation": "=="
    }},
    "weight": 100
  }},
  {{
    "name": "数学全周排满5节",
    "type": "ZONE_COUNT",
    "targets": {{"subjects": ["数学"]}},
    "params": {{
      "slots": [[0,0],[0,1],[0,2],[0,3],[0,4],[0,5],[0,6],[0,7],[1,0],[1,1],[1,2],[1,3],[1,4],[1,5],[1,6],[1,7],[2,0],[2,1],[2,2],[2,3],[2,4],[2,5],[2,6],[2,7],[3,0],[3,1],[3,2],[3,3],[3,4],[3,5],[3,6],[3,7],[4,0],[4,1],[4,2],[4,3],[4,4],[4,5],[4,6],[4,7]],
      "count": 5,
      "relation": "=="
    }},
    "weight": 100
  }},
  {{
    "name": "英语全周排满5节",
    "type": "ZONE_COUNT",
    "targets": {{"subjects": ["英语"]}},
    "params": {{
      "slots": [[0,0],[0,1],[0,2],[0,3],[0,4],[0,5],[0,6],[0,7],[1,0],[1,1],[1,2],[1,3],[1,4],[1,5],[1,6],[1,7],[2,0],[2,1],[2,2],[2,3],[2,4],[2,5],[2,6],[2,7],[3,0],[3,1],[3,2],[3,3],[3,4],[3,5],[3,6],[3,7],[4,0],[4,1],[4,2],[4,3],[4,4],[4,5],[4,6],[4,7]],
      "count": 5,
      "relation": "=="
    }},
    "weight": 100
  }}
]
"""
        # ... (后续调用代码不变)

```

### 为什么这样做能解决问题？

1. **明确坐标范围**：我直接把 `slots` 的全量坐标（40个格子）写在了示例里。LLM 是一种基于概率补全的工具，当它看到示例里写了长长的一串 `[[0,0]...[4,7]]`，它会倾向于模仿这个结构，而不是偷懒只写 `[[0,0]...[0,7]]`。
2. **纠正语义理解**：我告诉 AI，当用户说“每天”时，通常是指“全周范围内（Whole Week）”。
3. **One-Shot Learning**：在 Prompt 中直接给出了“语文数学英语每天都要有一节课”作为示例。这正是你刚才输入的场景。AI 看到完全一样的例子，会直接“抄作业”，从而保证准确率 100%。

### 补充建议：关于“每天必须上一节”的数学逻辑

你需要知道的是，`ZONE_COUNT` 规则设置为 **全周 Count == 5**，并**不能严格保证**每天各一节（理论上求解器可能排出：周一2节，周二0节...）。

但在实际排课中，由于我们还有以下隐含约束：

1. **最大连堂限制**（通常设为2）：这会阻止一天排太多。
2. **每天节数限制**（Daily Limit）：如果有这个规则。
3. **冲突检测**：老师每天也就那么多时间。

所以，通常只要设置 **全周==5**，求解器为了填满格子，自然会把课平铺到每一天。

如果你发现 AI 生成了上述规则后，排出来的课依然有“周一2节，周二0节”的情况，建议你手动再加一条规则（或者告诉 AI 生成）：

* **规则名**：每天最多2节
* **类型**：`DAILY_LIMIT`
* **参数**：`limit: 2` (或者 `limit: 1` 如果你严格要求一天只能一节)

更新完 `app.py` 后，重启应用，再次输入“每天必须上一节语数英”，你应该能看到它生成包含所有 slot 的正确 JSON 了。