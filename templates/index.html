<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾—é¹¿å±±æ™ºèƒ½æ’è¯¾ç³»ç»Ÿ</title>
    <!-- Tailwind CSS -->
    <link href="/static/css/output.css" rel="stylesheet">
    <!-- Google Fonts for Campus Vibe -->
    <link
        href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Quicksand:wght@500;600;700&display=swap"
        rel="stylesheet">
    <!-- Bootstrap CSS (Keep for Modals compatibility) -->
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/bootstrap-icons.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #eef2f6;
            background-image: radial-gradient(#cbd5e0 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .clay-card {
            background: #eef2f6;
            border-radius: 20px;
            box-shadow: 8px 8px 16px #dce1e8, -8px -8px 16px #ffffff;
            transition: all 0.3s ease;
        }

        .clay-btn {
            background: #eef2f6;
            border-radius: 12px;
            box-shadow: 5px 5px 10px #dce1e8, -5px -5px 10px #ffffff;
            color: #4a5568;
            transition: all 0.2s ease;
            font-weight: 700;
        }

        .clay-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            color: #3182ce;
        }

        .clay-btn:active:not(:disabled) {
            box-shadow: inset 5px 5px 10px #dce1e8, inset -5px -5px 10px #ffffff;
            transform: translateY(0);
        }

        .clay-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .clay-btn-primary {
            background: #ebf8ff;
            color: #2b6cb0;
        }

        .clay-btn-primary:hover:not(:disabled) {
            color: #2c5282;
        }

        .clay-input {
            background: #eef2f6;
            border: none;
            border-radius: 12px;
            padding: 0.75rem 1rem;
            box-shadow: inset 5px 5px 10px #dce1e8, inset -5px -5px 10px #ffffff;
            outline: none;
            transition: all 0.2s;
        }

        .clay-input:focus {
            box-shadow: inset 8px 8px 16px #dce1e8, inset -8px -8px 16px #ffffff;
        }

        /* Nav Pills Clay Style */
        .nav-pills .nav-link {
            background: transparent;
            color: #94a3b8;
            transition: all 0.2s;
        }

        .nav-pills .nav-link:hover {
            color: #64748b;
            background: rgba(255, 255, 255, 0.5);
        }

        .nav-pills .nav-link.active {
            background: #fff !important;
            color: #3b82f6 !important;
            box-shadow: 4px 4px 8px #dce1e8, -4px -4px 8px #ffffff;
        }

        /* Schedule Table */
        .schedule-cell {
            background: #eef2f6;
            border-radius: 12px;
            box-shadow: 3px 3px 6px #dce1e8, -3px -3px 6px #ffffff;
            transition: transform 0.2s;
            cursor: move;

            /* [ä¿®æ”¹] å¼ºåˆ¶å›ºå®šé«˜åº¦ï¼Œä¸å†ä½¿ç”¨ min-height */
            height: 90px;

            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 4px;

            /* [æ–°å¢] é˜²æ­¢å†…å®¹æ’‘å¤§æ ¼å­ */
            overflow: hidden;
        }

        .schedule-cell:hover {
            transform: scale(1.02);
            z-index: 10;
        }

        .schedule-cell.empty {
            box-shadow: inset 3px 3px 6px #dce1e8, inset -3px -3px 6px #ffffff;
            opacity: 0.6;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        /* è§„åˆ™ä¸­å¿ƒ UI ä¼˜åŒ– */

        /* éšè—åŸå§‹å¤é€‰æ¡† */
        .grade-checkbox-hidden {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        /* ========== ç²˜åœŸé£è§„åˆ™ä¸­å¿ƒç»„ä»¶ ========== */

        /* è§„åˆ™å¡ç‰‡ - å‡¸èµ·æ•ˆæœ */
        .clay-rule-card {
            background: #eef2f6;
            border-radius: 20px;
            box-shadow: 8px 8px 16px #dce1e8, -8px -8px 16px #ffffff;
            transition: all 0.3s ease;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .clay-rule-card:hover {
            transform: translateY(-3px);
            box-shadow: 12px 12px 24px #dce1e8, -12px -12px 24px #ffffff;
        }

        /* ç²˜åœŸé£èƒ¶å›ŠæŒ‰é’® - å‡¸èµ·/å‡¹é™·åˆ‡æ¢ */
        .clay-pill {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            color: #64748b;
            background: #eef2f6;
            box-shadow: 4px 4px 8px #dce1e8, -4px -4px 8px #ffffff;
            transition: all 0.2s ease;
            cursor: pointer;
            user-select: none;
        }

        .clay-pill:hover {
            color: #3b82f6;
        }

        /* é€‰ä¸­çŠ¶æ€ - å‡¹é™·æ•ˆæœ */
        .grade-checkbox-hidden:checked+.clay-pill {
            box-shadow: inset 4px 4px 8px #dce1e8, inset -4px -4px 8px #ffffff;
            color: #3b82f6;
            background: #e0e7ef;
        }

        /* å‚æ•°åŒºåŸŸ - æŸ”å’Œå‡¹é™· */
        .clay-params-zone {
            background: #e8edf2;
            border-radius: 16px;
            box-shadow: inset 4px 4px 8px #dce1e8, inset -4px -4px 8px #ffffff;
            padding: 1rem;
            min-height: 100px;
        }

        /* è§„åˆ™å¡ç‰‡å†…çš„è¾“å…¥ç»„ */
        .clay-input-group {
            background: #eef2f6;
            border-radius: 12px;
            box-shadow: inset 3px 3px 6px #dce1e8, inset -3px -3px 6px #ffffff;
            padding: 0.75rem 1rem;
        }

        .clay-input-group label {
            display: block;
            font-size: 0.65rem;
            font-weight: 700;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }

        .clay-input-group input,
        .clay-input-group select {
            width: 100%;
            background: transparent;
            border: none;
            font-size: 0.875rem;
            font-weight: 600;
            color: #475569;
            outline: none;
        }

        .clay-input-group select {
            cursor: pointer;
        }

        /* è§„åˆ™å¡ç‰‡ç½‘æ ¼å¸ƒå±€ - å®½æ¾ç‰ˆ */
        .clay-rule-grid {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 768px) {
            .clay-rule-grid {
                grid-template-columns: 1fr;
            }
        }

        /* åˆ†éš”çº¿ - ç²˜åœŸé£ */
        .clay-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, #dce1e8 20%, #dce1e8 80%, transparent);
            margin: 1.5rem 0;
        }

        /* è§„åˆ™ä¸­å¿ƒ Modal ä¸“ç”¨èƒŒæ™¯ */
        .clay-modal-bg {
            background: #eef2f6 !important;
        }

        /* è¡¨æ ¼ç²˜åœŸé£å®¹å™¨ */
        .clay-table-wrap {
            background: #e8edf2;
            border-radius: 16px;
            box-shadow: inset 3px 3px 6px #dce1e8, inset -3px -3px 6px #ffffff;
            overflow: hidden;
        }

        .clay-table-wrap table {
            width: 100%;
        }

        .clay-table-wrap thead {
            background: #eef2f6;
        }

        .clay-table-wrap th {
            font-size: 0.65rem;
            font-weight: 700;
            color: #94a3b8;
            text-transform: uppercase;
            padding: 0.75rem 1rem;
        }

        .clay-table-wrap td {
            padding: 0.75rem 1rem;
            border-top: 1px solid #e2e8f0;
        }
    </style>
</head>

<body class="h-screen flex overflow-hidden text-slate-600 font-sans p-4 gap-4">

    <!-- Splash -->
    <div id="splash-screen"
        class="fixed inset-0 bg-[#eef2f6] z-[9999] flex flex-col items-center justify-center transition-opacity duration-700">
        <div class="clay-card p-8 flex flex-col items-center animate-bounce">
            <img src="/static/logo.png" class="w-16 h-16 mb-4 object-contain">
            <h2 class="text-2xl font-black text-slate-700 tracking-wider">å¾—é¹¿å±±</h2>
            <p class="text-slate-400 font-bold mt-2">æ ¡å›­æ’è¯¾ç³»ç»ŸåŠ è½½ä¸­...</p>
        </div>
    </div>

    <!-- Sidebar (Left Panel) -->
    <aside id="main-sidebar"
        class="w-72 bg-white/80 backdrop-blur-xl border-r border-white/50 flex flex-col fixed md:relative z-50 h-full transition-transform transform -translate-x-full md:translate-x-0 shadow-2xl md:shadow-none">
        <!-- Header -->
        <div class="p-6 pb-2 text-center relative">
            <button class="md:hidden absolute top-4 right-4 text-slate-400 hover:text-slate-600"
                onclick="toggleSidebar()">
                <i class="bi bi-x-lg text-xl"></i>
            </button>
            <div class="w-20 h-20 mx-auto clay-card flex items-center justify-center mb-4 rounded-full">
                <img src="/static/logo.png" class="w-12 h-12 object-contain" alt="Logo">
            </div>
            <h1 class="text-2xl font-black text-slate-700 font-display">å¾—é¹¿å±±æ™ºèƒ½æ’è¯¾</h1>
            <div
                class="inline-block px-3 py-1 mt-2 bg-yellow-100 text-yellow-600 rounded-full text-xs font-bold shadow-sm">
                æ ¡å›­ç‰ˆ
            </div>
        </div>

        <!-- Navigation -->
        <div class="flex-1 overflow-y-auto px-6 py-4 space-y-6 custom-scrollbar">

            <!-- Main Actions -->
            <button id="btn-init" onclick="initSystem()"
                class="w-full clay-btn clay-btn-primary py-4 text-lg flex items-center justify-center group relative overflow-hidden">
                <span id="init-spinner" class="spinner-border spinner-border-sm mr-2 d-none"></span>
                <i class="bi bi-stars mr-2 text-yellow-500 text-xl group-hover:scale-110 transition-transform"></i>
                ä¸€é”®ç”Ÿæˆ
            </button>



            <!-- Buttons Grid -->
            <div class="grid grid-cols-2 gap-4">
                <button onclick="openConstraints()"
                    class="clay-btn py-3 flex flex-col items-center justify-center text-sm gap-1 hover:text-blue-500">
                    <i class="bi bi-shield-lock-fill text-xl text-blue-400"></i> è§„åˆ™ä¸­å¿ƒ
                </button>
                <button onclick="openSettings()"
                    class="clay-btn py-3 flex flex-col items-center justify-center text-sm gap-1 hover:text-indigo-500">
                    <i class="bi bi-gear-fill text-xl text-indigo-400"></i> å‚æ•°
                </button>
            </div>

            <button onclick="showRuleReport()" id="btn-rule-report" disabled
                class="w-full mt-3 clay-btn py-3 flex items-center justify-center text-sm gap-2 text-green-600 hover:text-green-700 font-bold">
                <i class="bi bi-clipboard-check-fill text-xl"></i> æŸ¥çœ‹è§„åˆ™æ‰§è¡ŒæŠ¥å‘Š
            </button>

            <!-- Management Card -->
            <div
                class="clay-card p-4 !shadow-[inset_5px_5px_10px_#dce1e8,inset_-5px_-5px_10px_#ffffff] !bg-transparent rounded-2xl">
                <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-3 ml-1">æ–¹æ¡ˆå­˜æ¡£</h3>
                <div class="flex gap-2 mb-3">
                    <input id="save-name" class="clay-input w-full text-sm" placeholder="æ–¹æ¡ˆåç§°...">
                    <button onclick="saveCurrentSchedule()" id="btn-save" disabled
                        class="clay-btn w-10 flex items-center justify-center text-green-500">
                        <i class="bi bi-check-lg"></i>
                    </button>
                </div>
                <div id="saved-list" class="space-y-2 max-h-32 overflow-y-auto pr-1"></div>
            </div>

            <!-- Leave & Sub -->
            <div
                class="clay-card p-4 !shadow-[inset_5px_5px_10px_#dce1e8,inset_-5px_-5px_10px_#ffffff] !bg-transparent rounded-2xl">
                <div onclick="document.querySelector('#leave-panel').classList.toggle('hidden')"
                    class="flex justify-between items-center cursor-pointer mb-2">
                    <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">è¯·å‡ä¸ä»£è¯¾</h3>
                    <i class="bi bi-caret-down-fill text-slate-300"></i>
                </div>

                <div id="leave-panel" class="hidden space-y-2">
                    <select id="teacher-select" disabled class="clay-input w-full text-sm p-2"></select>

                    <div class="grid grid-cols-2 gap-2 text-[10px] text-slate-400 font-bold px-1">
                        <span>å¼€å§‹æ—¶é—´</span>
                        <span>ç»“æŸæ—¶é—´</span>
                    </div>
                    <div class="flex gap-2">
                        <select id="start-day" class="clay-input w-2/3 text-xs p-2">
                            <option value="0">å‘¨ä¸€</option>
                            <option value="1">å‘¨äºŒ</option>
                            <option value="2">å‘¨ä¸‰</option>
                            <option value="3">å‘¨å››</option>
                            <option value="4">å‘¨äº”</option>
                        </select>
                        <select id="start-period" class="clay-input w-1/3 text-xs p-2">
                            <option value="0">1</option>
                            <option value="1">2</option>
                            <option value="2">3</option>
                            <option value="3">4</option>
                            <option value="4">5</option>
                            <option value="5">6</option>
                            <option value="6">7</option>
                            <option value="7">8</option>
                            <option value="8">9</option>
                        </select>
                    </div>
                    <div class="flex gap-2">
                        <select id="end-day" class="clay-input w-2/3 text-xs p-2">
                            <option value="0">å‘¨ä¸€</option>
                            <option value="1">å‘¨äºŒ</option>
                            <option value="2">å‘¨ä¸‰</option>
                            <option value="3">å‘¨å››</option>
                            <option value="4">å‘¨äº”</option>
                        </select>
                        <select id="end-period" class="clay-input w-1/3 text-xs p-2">
                            <option value="0">1</option>
                            <option value="1">2</option>
                            <option value="2">3</option>
                            <option value="3">4</option>
                            <option value="4">5</option>
                            <option value="5">6</option>
                            <option value="6">7</option>
                            <option value="7">8</option>
                            <option value="8">9</option>
                        </select>
                    </div>

                    <button onclick="addLeave()" id="btn-add-leave" disabled
                        class="w-full clay-btn py-2 text-xs text-orange-400 hover:text-orange-500">æ·»åŠ è¯·å‡æ¡</button>
                    <ul id="leave-list" class="space-y-2"></ul>
                    <button onclick="applySubstitutions()" id="btn-apply" disabled
                        class="w-full clay-btn py-2 text-xs text-purple-500 hover:text-purple-600 font-black mt-2">æ‰§è¡Œæ™ºèƒ½ä»£è¯¾</button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="px-4 pb-4 space-y-2">


            <a href="/logout"
                class="block w-full text-center clay-btn py-3 text-red-400 hover:text-red-500 text-sm font-bold">
                <i class="bi bi-power mr-1"></i> é€€å‡ºç™»å½•
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full rounded-[2rem] overflow-hidden relative">

        <!-- Mobile Menu Button -->
        <button onclick="toggleSidebar()"
            class="md:hidden absolute top-6 left-4 z-40 text-slate-500 clay-btn p-2 w-10 h-10 flex items-center justify-center">
            <i class="bi bi-list text-xl"></i>
        </button>

        <!-- Header -->
        <header class="h-20 mb-4 flex items-center justify-between px-2 shrink-0 pl-16 md:pl-2">
            <div class="ml-1">
                <h2 id="class-title" class="text-3xl font-black text-slate-700 font-display"> ç­çº§è¯¾è¡¨ </h2>
            </div>

            <div class="flex items-center gap-4">
                <!-- View Switcher -->
                <div class="clay-card p-1.5 flex gap-2">
                    <button id="btn-view-class" onclick="switchView('class')"
                        class="clay-btn px-4 py-2 text-sm text-blue-500 bg-white">ç­çº§è§†å›¾</button>
                    <button id="btn-view-teacher" onclick="switchView('teacher')" disabled
                        class="clay-btn px-4 py-2 text-sm text-slate-400 hover:text-slate-600">æ•™å¸ˆè§†å›¾</button>
                </div>

                <!-- Selectors -->
                <div id="class-selector-group">
                    <select id="class-select" onchange="renderCurrentClass()"
                        class="clay-input py-2.5 px-4 text-sm font-bold text-slate-600 w-[200px]"></select>
                </div>
                <div id="teacher-selector-group" class="hidden">
                    <select id="teacher-view-select" onchange="renderCurrentTeacher()"
                        class="clay-input py-2.5 px-4 text-sm font-bold text-slate-600 w-[200px]"></select>
                </div>

                <div class="flex gap-3 ml-2">
                    <button onclick="performUndo()" id="btn-undo" disabled
                        class="clay-btn w-10 h-10 flex items-center justify-center text-slate-400 hover:text-blue-500"><i
                            class="bi bi-arrow-counterclockwise text-lg"></i></button>
                    <button onclick="performRedo()" id="btn-redo" disabled
                        class="clay-btn w-10 h-10 flex items-center justify-center text-slate-400 hover:text-blue-500"><i
                            class="bi bi-arrow-clockwise text-lg"></i></button>
                    <button onclick="exportCurrentClass()" id="btn-export-current" disabled
                        class="clay-btn w-10 h-10 flex items-center justify-center text-green-500 hover:text-green-600"><i
                            class="bi bi-cloud-download-fill text-lg"></i></button>
                    <button onclick="openStatistics()" id="btn-stats" disabled
                        class="clay-btn w-10 h-10 flex items-center justify-center text-indigo-400 hover:text-indigo-500"><i
                            class="bi bi-bar-chart-line-fill text-lg"></i></button>
                </div>
            </div>
        </header>

        <!-- Schedule Grid -->
        <div class="flex-1 clay-card p-6 overflow-auto custom-scrollbar relative z-10 !rounded-[2.5rem]">
            <div id="error-alert-container"></div>

            <div id="loading-state"
                class="hidden absolute inset-0 flex items-center justify-center bg-white/50 z-50 rounded-[2.5rem] backdrop-blur-sm">
                <div class="spinner-border text-blue-300" style="width: 3rem; height: 3rem;"></div>
            </div>

            <table class="w-full text-center border-separate border-spacing-2 table-fixed">
                <thead>
                    <tr>
                        <th class="w-16"></th>
                        <th class="text-slate-400 font-black uppercase text-sm pb-2">å‘¨ä¸€</th>
                        <th class="text-slate-400 font-black uppercase text-sm pb-2">å‘¨äºŒ</th>
                        <th class="text-slate-400 font-black uppercase text-sm pb-2">å‘¨ä¸‰</th>
                        <th class="text-slate-400 font-black uppercase text-sm pb-2">å‘¨å››</th>
                        <th class="text-slate-400 font-black uppercase text-sm pb-2">å‘¨äº”</th>
                    </tr>
                </thead>
                <tbody id="schedule-body">
                    <tr>
                        <td colspan="6" class="py-20 text-slate-300 font-bold text-xl text-center">å‡†å¤‡å¥½æ’è¯¾äº†å—ï¼Ÿ
                            <br> ç‚¹å‡» "ä¸€é”®ç”Ÿæˆ" å¼€å§‹ï¼
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

    </main>

    <!-- Modals (Reused Structure, Clay Styled) -->
    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content !bg-[#eef2f6] border-0 !rounded-[2rem] !shadow-2xl overflow-hidden p-4">
                <div class="modal-header border-0">
                    <h5 class="modal-title font-black text-slate-700">é…ç½®å‚æ•°</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="clay-card p-6 mb-4 !bg-[#fff5f5] flex justify-between items-center">
                        <div>
                            <h6 class="text-red-400 font-bold mb-1 uppercase tracking-wide text-xs">å¿«é€Ÿé…ç½®</h6>
                            <p class="text-xs text-slate-400">ä¸Šä¼  Excel è‡ªåŠ¨å¡«å……ç§‘ç›®ä¸è€å¸ˆ</p>
                        </div>
                        <div class="flex gap-2">
                            <input type="file" id="config-excel-upload" class="hidden" accept=".xlsx, .xls"
                                onchange="handleConfigUpload(this)">
                            <label for="config-excel-upload"
                                class="clay-btn px-4 py-2 text-xs text-red-400 cursor-pointer hover:text-red-500">
                                <i class="bi bi-file-earmark-excel-fill mr-1"></i> å¯¼å…¥é…ç½®
                            </label>
                            <a href="/static/template.xlsx" class="clay-btn px-3 py-2 text-xs text-slate-400" download>
                                <i class="bi bi-download"></i>
                            </a>
                        </div>
                    </div>
                    <div class="clay-card p-4 mb-4 !bg-[#ebf8ff]">
                        <div class="flex justify-between items-center mb-4">
                            <h6 class="text-blue-500 font-bold uppercase tracking-wide text-xs m-0">å¹´çº§ç®¡ç†</h6>
                            <div class="flex bg-white/50 rounded-lg p-1 gap-1" id="grade-tabs">
                                <!-- Tabs åŠ¨æ€æ¸²æŸ“ -->
                            </div>
                        </div>

                        <div class="row items-center">
                            <div class="col-sm-6">
                                <label class="text-xs font-bold text-slate-500">å½“å‰å¹´çº§ç­çº§æ•°</label>
                                <input type="number" id="grade-count-input" class="clay-input w-full mt-1" min="0"
                                    value="6">
                            </div>
                            <div class="col-sm-6">
                                <label class="text-xs font-bold text-slate-500">èµ·å§‹ç­å· (ä¾‹å¦‚: 1, 21)</label>
                                <input type="number" id="grade-start-input" class="clay-input w-full mt-1" min="1"
                                    value="1">
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col gap-6">
                        <div>
                            <div class="flex justify-between items-center mb-3 pl-2 pr-2">
                                <h6 class="font-bold text-slate-600 flex items-center gap-2 m-0">
                                    <i class="bi bi-book-half text-blue-400"></i> ç§‘ç›®è®¾ç½®
                                </h6>
                                <span id="total-hours-display"
                                    class="text-xs font-bold px-3 py-1 bg-white rounded-lg text-slate-400 border border-slate-100">
                                    å‘¨è¯¾æ—¶: <span id="current-hours" class="text-blue-500 text-sm">0</span> / 40
                                </span>
                            </div>
                            <div class="clay-card p-4 !shadow-clay-inner h-64 overflow-y-auto">
                                <style>
                                    #course-settings-table input {
                                        min-width: 0 !important;
                                    }

                                    .narrow-input {
                                        width: 100% !important;
                                        padding-left: 4px !important;
                                        padding-right: 4px !important;
                                    }
                                </style>
                                <table id="course-settings-table"
                                    class="w-full text-sm text-left border-separate border-spacing-y-1 border-spacing-x-0 table-fixed"
                                    style="width: 100%; table-layout: fixed;">
                                    <thead>
                                        <tr class="text-slate-400 text-[10px] font-bold sticky top-0 bg-[#eef2f6] z-10">
                                            <th style="width: 80px;" class="pl-2 pb-2">ç§‘ç›®åç§°</th>
                                            <th style="width: 50px;" class="pb-2">èŠ‚æ•°</th>
                                            <th style="width: 70px;" class="pb-2 text-center">ç±»å‹</th>
                                            <th style="width: 100px;" class="pb-2 text-center">åˆ†å¸ƒ</th>
                                            <th style="width: 100px;" class="pb-2">æ ‡ç­¾ (ç”¨,åˆ†éš”)</th>
                                            <th style="width: auto;" class="pb-2">å›ºå®šè€å¸ˆ (å°½é‡å¡«å…¨)</th>
                                            <th style="width: 50px;" class="text-center pb-2">æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="course-settings-body"></tbody>
                                </table>
                            </div>
                            <button
                                class="clay-btn w-full mt-3 py-3 text-xs text-blue-500 font-bold hover:text-blue-600"
                                onclick="addCourseRow()">
                                <i class="bi bi-plus-lg mr-1"></i> æ·»åŠ ç§‘ç›®
                            </button>
                        </div>

                        <div>
                            <h6 class="font-bold text-slate-600 mb-3 pl-2 flex items-center gap-2">
                                <i class="bi bi-building-gear text-green-400"></i> å®éªŒå®¤ / åŠŸèƒ½å®¤
                            </h6>
                            <div class="clay-card p-4 !shadow-clay-inner h-64 overflow-y-auto">
                                <table class="w-full text-sm text-left border-separate border-spacing-y-1 table-fixed">
                                    <thead>
                                        <tr class="text-slate-400 text-xs font-bold sticky top-0 bg-[#eef2f6] z-10">
                                            <th class="pl-2 pb-2 w-[25%]">èµ„æºåç§°</th>
                                            <th class="pb-2 w-[12%]">å®¹é‡(é—´)</th>
                                            <th class="pb-2 w-[55%]">é€‚ç”¨ç§‘ç›® (ç”¨é€—å·åˆ†éš”)</th>
                                            <th class="text-center pb-2 w-[8%]">æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="resource-settings-body" class="space-y-2"></tbody>
                                </table>
                            </div>
                            <button
                                class="clay-btn w-full mt-3 py-3 text-xs text-green-500 font-bold hover:text-green-600"
                                onclick="addResourceRow()">
                                <i class="bi bi-plus-lg mr-1"></i> æ·»åŠ èµ„æº
                            </button>
                        </div>
                    </div>


                </div>
                <div class="modal-footer border-0">
                    <button class="clay-btn px-6 py-2 text-slate-500" data-bs-dismiss="modal"
                        onclick="syncUItoConfig()">
                        <i class="bi bi-floppy mr-1"></i> æš‚å­˜é…ç½®
                    </button>
                    <button class="clay-btn px-6 py-2 !text-white !bg-blue-400 shadow-none hover:bg-blue-500"
                        data-bs-dismiss="modal" onclick="saveSettingsAndInit()">ä¿å­˜å¹¶ç”Ÿæˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Constraint Modal (ç²˜åœŸé£ç‰ˆæœ¬) -->
    <div class="modal fade" id="constraintModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content clay-modal-bg border-0 !rounded-[2rem] overflow-hidden">
                <!-- ç²˜åœŸé£æ ‡é¢˜æ  -->
                <div class="modal-header border-0 px-6 py-5">
                    <h5 class="modal-title font-black text-slate-700 text-lg flex items-center gap-3">
                        <div class="clay-btn w-10 h-10 flex items-center justify-center !rounded-xl">
                            <i class="bi bi-sliders text-blue-500"></i>
                        </div>
                        è§„åˆ™é…ç½®ä¸­å¿ƒ
                    </h5>
                    <button type="button"
                        class="clay-btn w-8 h-8 flex items-center justify-center !rounded-lg text-slate-400 hover:text-red-500"
                        data-bs-dismiss="modal">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>

                <div class="modal-body px-6 pb-6 pt-0">
                    <!-- æ•™å¸ˆè¯¾æ—¶é™åˆ¶åŒºåŸŸ -->
                    <div class="clay-card p-5 mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h6 class="font-bold text-slate-600 flex items-center gap-2">
                                <i class="bi bi-person-badge-fill text-orange-400"></i>
                                æ•™å¸ˆè¯¾æ—¶é™åˆ¶
                            </h6>
                            <button class="clay-btn px-4 py-2 text-xs text-orange-500 font-bold"
                                onclick="addTeacherLimitRow()">
                                <i class="bi bi-plus-lg mr-1"></i> æ·»åŠ äººå‘˜
                            </button>
                        </div>
                        <div class="clay-table-wrap">
                            <table>
                                <thead>
                                    <tr>
                                        <th>æ•™å¸ˆå§“å</th>
                                        <th class="text-center">æœ€å°è¯¾æ—¶</th>
                                        <th class="text-center">æœ€å¤§è¯¾æ—¶</th>
                                        <th>æ ‡ç­¾åŒ¹é…</th>
                                        <th class="text-center w-16">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="teacher-limits-body"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- ç²˜åœŸé£åˆ†éš”çº¿ -->
                    <div class="clay-divider"></div>

                    <!-- æ™ºèƒ½è§„åˆ™åº“åŒºåŸŸ -->
                    <div class="clay-card p-5">
                        <div class="flex justify-between items-center mb-5">
                            <h6 class="font-bold text-slate-600">
                                æ™ºèƒ½è§„åˆ™åº“
                            </h6>

                            <div class="dropdown">
                                <button class="clay-btn px-4 py-2 text-xs text-slate-500 font-bold dropdown-toggle"
                                    type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-collection-fill mr-1"></i> æ¨¡æ¿
                                </button>
                                <ul class="dropdown-menu shadow-lg border-0 rounded-xl">
                                    <li><a class="dropdown-item text-xs font-bold py-2" href="#"
                                            onclick="loadRuleTemplate('shaoxing')">
                                            <i class="bi bi-building mr-2"></i>å¯¼å…¥æ ‡å‡†æ¨¡æ¿
                                        </a></li>
                                    <li>
                                        <hr class="dropdown-divider">
                                    </li>
                                    <li><a class="dropdown-item text-xs font-bold py-2 text-red-400" href="#"
                                            onclick="loadRuleTemplate('empty')">
                                            <i class="bi bi-trash3 mr-2"></i>æ¸…ç©ºæ‰€æœ‰
                                        </a></li>
                                </ul>
                            </div>
                        </div>

                        <!-- è§„åˆ™åˆ—è¡¨å®¹å™¨ -->
                        <div id="rules-container" class="space-y-4 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar">
                        </div>
                    </div>
                </div>

                <!-- ç²˜åœŸé£åº•éƒ¨æ“ä½œæ  -->
                <div class="modal-footer border-0 px-6 py-4 flex justify-between items-center">
                    <div class="flex gap-3">
                        <button class="clay-btn py-3 px-5 text-sm text-purple-600 font-bold"
                            onclick="openAddRuleModal()">
                            <i class="bi bi-plus-circle-fill mr-2"></i> æ–°å¢è§„åˆ™
                        </button>
                        <button class="clay-btn py-3 px-5 text-sm text-white font-bold"
                            style="background: linear-gradient(135deg, #8b5cf6, #6366f1); box-shadow: 4px 4px 12px rgba(139, 92, 246, 0.3);"
                            onclick="new bootstrap.Modal(document.getElementById('aiRuleModal')).show()">
                            <i class="bi bi-stars mr-2"></i> AI ç”Ÿæˆ
                        </button>
                    </div>
                    <div class="flex gap-3">
                        <button class="clay-btn px-5 py-3 text-sm text-slate-400 font-bold"
                            data-bs-dismiss="modal">å…³é—­</button>
                        <button onclick="saveConstraintsAndRun()"
                            class="clay-btn px-6 py-3 text-sm text-white font-bold"
                            style="background: linear-gradient(135deg, #3b82f6, #2563eb); box-shadow: 4px 4px 12px rgba(59, 130, 246, 0.3);">
                            <i class="bi bi-check-lg mr-2"></i> ä¿å­˜å¹¶é‡æ’
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢è§„åˆ™å¼¹çª— -->
    <div class="modal fade" id="addRuleModal" tabindex="-1" style="z-index: 1060;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content clay-modal-bg border-0 !rounded-[2rem] overflow-hidden">
                <div class="modal-header border-0 px-6 py-5">
                    <h5 class="modal-title font-black text-slate-700 text-lg">æ–°å¢è§„åˆ™</h5>
                    <button type="button"
                        class="clay-btn w-8 h-8 flex items-center justify-center !rounded-lg text-slate-400 hover:text-red-500"
                        data-bs-dismiss="modal">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>

                <div class="modal-body px-6 pb-6 pt-0">
                    <div class="flex flex-col items-center space-y-5">

                        <!-- è§„åˆ™åç§° -->
                        <div class="w-full">
                            <label class="text-xs text-slate-500 font-bold block text-center mb-2">è§„åˆ™åç§°</label>
                            <input type="text" id="newRuleName"
                                class="clay-input w-full py-3 text-sm text-center font-bold text-slate-700"
                                placeholder="ä¾‹å¦‚ï¼šè¯­æ–‡ä¸æ’å‘¨äº”ä¸‹åˆ">
                        </div>

                        <!-- è§„åˆ™ç±»å‹ + æƒé‡ -->
                        <div class="grid grid-cols-2 gap-4 w-full">
                            <div class="clay-input-group text-center">
                                <label class="text-center">è§„åˆ™ç±»å‹</label>
                                <select id="newRuleType" class="cursor-pointer text-center">
                                    <option value="FORBIDDEN_SLOTS">æ—¶æ®µç¦æ’</option>
                                    <option value="FIXED_SLOTS">å›ºå®šæ—¶æ®µ</option>
                                    <option value="ZONE_COUNT">åŒºåŸŸè¯¾æ—¶</option>
                                    <option value="CONSECUTIVE">è¿å ‚é™åˆ¶</option>
                                    <option value="GLOBAL_CAPACITY">å…¨æ ¡å®¹é‡</option>
                                    <option value="SPECIAL_DAYS">æ•´æ—¥ç¦æ’</option>
                                </select>
                            </div>
                            <div class="clay-input-group text-center">
                                <label class="text-center">æƒé‡</label>
                                <input type="number" id="newRuleWeight" class="text-center font-bold text-blue-500"
                                    value="100">
                            </div>
                        </div>

                        <!-- é€‚ç”¨å¹´çº§ -->
                        <div class="text-center w-full">
                            <label class="text-xs text-slate-500 font-bold block mb-3">é€‚ç”¨å¹´çº§</label>
                            <div id="newRuleGrades" class="flex flex-wrap gap-3 justify-center">
                                <!-- åŠ¨æ€å¡«å…… -->
                            </div>
                        </div>

                        <!-- ç­›é€‰æ¡ä»¶ -->
                        <div class="w-full">
                            <label class="text-xs text-slate-500 font-bold block text-center mb-2">ç­›é€‰æ¡ä»¶</label>
                            <input type="text" id="newRuleTargets" class="clay-input w-full py-3 text-sm text-center"
                                placeholder="ç§‘ç›®:è¯­æ–‡; å§“å:å¼ ä¸‰">
                        </div>

                        <!-- æ—¶æ®µé€‰æ‹© -->
                        <div class="w-full text-center">
                            <label class="text-xs text-slate-500 font-bold block mb-2">æ—¶æ®µè®¾ç½®</label>
                            <input type="text" id="newRuleSlots"
                                class="clay-input w-full py-3 text-sm text-center font-mono text-indigo-600 mb-3"
                                placeholder="ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®é€‰æ‹©æ—¶æ®µ" readonly>
                            <button type="button" class="clay-btn w-full py-3 text-sm font-bold text-white"
                                style="background: linear-gradient(135deg, #8b5cf6, #6366f1); box-shadow: 4px 4px 12px rgba(139, 92, 246, 0.4);"
                                onclick="openNewRuleSlotPicker()">
                                é€‰æ‹©æ—¶æ®µ
                            </button>
                        </div>

                    </div>
                </div>

                <div class="modal-footer border-0 px-6 py-4 flex justify-center gap-4">
                    <button class="clay-btn px-6 py-3 text-sm text-slate-400 font-bold"
                        data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button class="clay-btn px-8 py-3 text-sm text-white font-bold"
                        style="background: linear-gradient(135deg, #8b5cf6, #6366f1); box-shadow: 4px 4px 12px rgba(139, 92, 246, 0.3);"
                        onclick="confirmAddRule()">
                        ç¡®è®¤æ·»åŠ 
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Rule Slot Picker Modal -->
    <div class="modal fade" id="ruleSlotModal" tabindex="-1" style="z-index: 1070;">
        <div class="modal-dialog">
            <div class="modal-content !bg-[#eef2f6] border-0 !rounded-[2rem] p-4 text-center">
                <div class="modal-header border-0">
                    <h5 class="modal-title font-black text-slate-700">é€‰æ‹©æ—¶æ®µ (Slots Picker)</h5><button type="button"
                        class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div
                        class="bg-purple-50 text-purple-500 p-3 rounded-xl mb-3 text-[10px] font-bold flex items-start gap-2 text-left">
                        <i class="bi bi-info-circle-fill mt-0.5"></i>
                        <div>ç‚¹å‡»ä¸‹æ–¹æ ¼å­æ ‡è®°è§„åˆ™ç”Ÿæ•ˆçš„æ—¶æ®µã€‚ç´«è‰²è¡¨ç¤º"é€‰ä¸­"ã€‚</div>
                    </div>
                    <div class="clay-card p-4 !shadow-clay-inner flex justify-center mb-4">
                        <table class="table-fixed border-separate border-spacing-1" id="rule-slot-grid"
                            style="width: 250px;">
                            <thead>
                                <tr>
                                    <th style="width: 20px;"></th>
                                    <th class="text-[10px] text-slate-400 text-center font-black" style="width: 45px;">ä¸€
                                    </th>
                                    <th class="text-[10px] text-slate-400 text-center font-black" style="width: 45px;">äºŒ
                                    </th>
                                    <th class="text-[10px] text-slate-400 text-center font-black" style="width: 45px;">ä¸‰
                                    </th>
                                    <th class="text-[10px] text-slate-400 text-center font-black" style="width: 45px;">å››
                                    </th>
                                    <th class="text-[10px] text-slate-400 text-center font-black" style="width: 45px;">äº”
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="rule-slot-tbody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer border-0 flex justify-end gap-2">
                    <button class="clay-btn px-6 py-2" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button class="clay-btn px-6 py-1 !text-white !bg-purple-400 hover:!bg-purple-500"
                        onclick="confirmRuleSlots()">ç¡®å®š</button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Rule Generator Modal -->
    <div class="modal fade" id="aiRuleModal" tabindex="-1" style="z-index: 1080;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content !bg-[#eef2f6] border-0 !rounded-[2rem] p-4">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title font-black text-slate-700 flex items-center gap-2">
                        <i class="bi bi-stars text-purple-500"></i> æ™ºèƒ½è§„åˆ™ç”Ÿæˆ
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-xs text-slate-400 mb-2 font-bold">è¯·ç”¨è‡ªç„¶è¯­è¨€æè¿°æ‚¨çš„è¦æ±‚ï¼š</p>
                    <textarea id="ai-input-text" class="clay-input w-full h-32 text-sm p-3 mb-3 resize-none"
                        placeholder="ä¾‹å¦‚ï¼š&#10;- åˆä¸€çš„æ•°å­¦è€å¸ˆå‘¨ä¸‰ä¸‹åˆä¸è¦æ’è¯¾&#10;- è¯­æ–‡æ•°å­¦è‹±è¯­åœ¨ä¸Šåˆå¿…é¡»æ’æ»¡4èŠ‚&#10;- æ‰€æœ‰ä½“è‚²è¯¾ä¸èƒ½æ’åœ¨ç¬¬ä¸€èŠ‚"></textarea>

                    <div id="ai-loading" class="hidden text-center py-4">
                        <div class="spinner-border text-purple-500 w-8 h-8" role="status"></div>
                        <p class="text-xs text-purple-400 font-bold mt-2">Qwen æ­£åœ¨æ€è€ƒä¸­...</p>
                    </div>

                    <div id="ai-result-preview" class="hidden clay-card p-3 bg-white mb-3 border border-purple-100">
                        <div class="text-[10px] text-slate-400 font-bold mb-1">è¯†åˆ«ç»“æœï¼š</div>
                        <pre id="json-preview"
                            class="text-xs text-slate-600 font-mono bg-slate-50 p-2 rounded max-h-40 overflow-auto"></pre>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button id="btn-ai-gen"
                        class="clay-btn px-6 py-2 !bg-purple-500 !text-black w-full shadow-lg hover:scale-[1.02] transition-transform"
                        onclick="callAiGeneration()">
                        <i class="bi bi-magic mr-1"></i> ç”Ÿæˆå¹¶åº”ç”¨
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- è§„åˆ™è¯¦æƒ…å¼¹çª— -->
    <div class="modal fade" id="ruleDetailModal" tabindex="-1" style="z-index: 1085;">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content !bg-[#eef2f6] border-0 !rounded-[2rem] p-4">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title font-black text-slate-700 flex items-center gap-2">
                        <i class="bi bi-info-circle-fill text-blue-500"></i> è§„åˆ™è¯¦æƒ…
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- è§„åˆ™æ‘˜è¦ -->
                    <div class="clay-card p-4 bg-white mb-3">
                        <div class="mb-3 border-b border-dashed border-slate-100 pb-2">
                            <span class="text-slate-400 font-bold block mb-1">è§„åˆ™æè¿°ï¼š</span>
                            <span id="detail-name" class="text-blue-600 font-black text-sm"></span>
                        </div>
                        <div class="grid grid-cols-2 gap-3 text-xs">
                            <div>
                                <span class="text-slate-400 font-bold">è§„åˆ™ç±»å‹ï¼š</span>
                                <span id="detail-type" class="text-slate-600 font-bold"></span>
                            </div>
                            <div>
                                <span class="text-slate-400 font-bold">æƒé‡ï¼š</span>
                                <span id="detail-weight" class="text-blue-500 font-bold"></span>
                            </div>
                            <div class="col-span-2">
                                <span class="text-slate-400 font-bold">é€‚ç”¨å¹´çº§ï¼š</span>
                                <span id="detail-grades" class="text-slate-600"></span>
                            </div>
                            <div class="col-span-2">
                                <span class="text-slate-400 font-bold">ç­›é€‰æ¡ä»¶ï¼š</span>
                                <span id="detail-targets" class="text-slate-600"></span>
                            </div>
                        </div>
                    </div>

                    <!-- æ—¶æ®µå¯è§†åŒ– -->
                    <div id="detail-slots-section" class="clay-card p-4 bg-white mb-3">
                        <div class="text-[10px] text-slate-400 font-bold mb-2">ğŸ“… æ—¶æ®µå¯è§†åŒ–</div>
                        <div id="detail-slots-grid" class="grid grid-cols-6 gap-1 text-[10px]">
                            <!-- åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>

                    <!-- å®Œæ•´ JSON -->
                    <div class="clay-card p-3 bg-white">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[10px] text-slate-400 font-bold">ğŸ“‹ å®Œæ•´ JSON é…ç½®</span>
                            <button class="text-[10px] text-blue-500 font-bold hover:underline"
                                onclick="copyRuleJson()">
                                <i class="bi bi-clipboard mr-1"></i>å¤åˆ¶
                            </button>
                        </div>
                        <pre id="detail-json"
                            class="text-[10px] text-slate-600 font-mono bg-slate-50 p-3 rounded-lg max-h-48 overflow-auto"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Modal -->
    <div class="modal fade" id="statisticsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content !bg-[#eef2f6] border-0 !rounded-[2rem] p-4">
                <div class="modal-header border-0">
                    <h5 class="modal-title font-black text-slate-700">æ•°æ®çœ‹æ¿</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="clay-card p-4 h-[400px]"><canvas id="workloadChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content !bg-[#eef2f6] border-0 !rounded-[2rem] p-6 text-center">
                <h5 class="font-black text-slate-700 mb-2">ç¡®å®šåˆ é™¤?</h5>
                <div class="flex justify-center gap-4 mt-4">
                    <button class="clay-btn px-4 py-2" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button class="clay-btn px-4 py-2 !text-red-500" id="btn-confirm-delete">ç¡®å®š</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Failure Suggestion Modal --> <!-- [æ–°å¢] æ™ºèƒ½è°ƒé…æŠ¥å‘Šæ¨¡æ€æ¡† -->
    <div class="modal fade" id="shardingModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content clay-card overflow-hidden">
                <div class="modal-header border-0 pb-0">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-xl bg-orange-100 text-orange-500 flex items-center justify-center shadow-sm">
                            <i class="bi bi-magic text-xl"></i>
                        </div>
                        <div>
                            <h5 class="modal-title font-black text-slate-700">æ™ºèƒ½è°ƒé…æŠ¥å‘Š</h5>
                            <p class="text-[10px] text-slate-400 uppercase tracking-wider">Smart Sharding Pro Report
                            </p>
                        </div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body pt-6">
                    <div id="sharding-content" class="space-y-4 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar">
                        <!-- åŠ¨æ€å†…å®¹æ¸²æŸ“ -->
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button"
                        class="w-full py-3 rounded-2xl bg-slate-100 text-slate-600 font-bold hover:bg-slate-200 transition-all"
                        data-bs-dismiss="modal">çŸ¥é“äº†</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="failureModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content !bg-[#eef2f6] border-0 !rounded-[2rem] p-6">
                <div class="flex items-center gap-3 mb-4 text-red-500">
                    <i class="bi bi-exclamation-triangle-fill text-2xl"></i>
                    <h5 class="font-black text-slate-700 m-0">æ’è¯¾é‡åˆ°å›°éš¾</h5>
                </div>
                <p class="text-sm text-slate-500 font-bold mb-3">AI å»ºè®®æ‚¨å°è¯•è°ƒæ•´ä»¥ä¸‹çº¦æŸï¼š</p>
                <div class="clay-card p-4 !shadow-clay-inner max-h-60 overflow-y-auto mb-4">
                    <ul id="failure-suggestions" class="space-y-2 text-xs text-slate-600 font-bold"></ul>
                </div>
                <div class="flex justify-end">
                    <button class="clay-btn px-6 py-2" data-bs-dismiss="modal">æˆ‘çŸ¥é“äº†</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tooltip -->
    <div id="conflict-tooltip"
        class="fixed hidden bg-red-400 text-white px-3 py-2 rounded-xl text-xs font-bold shadow-lg z-50 pointer-events-none">
    </div>

    <!-- Scripts (Same Logic) -->
    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/chart.js"></script>
    <script>
        // ... Logic Reuse ...
        let globalSchedule = {}, deleteModalVar = null, targetDeleteName = '', globalTeachers = [], globalClassNames = {}, teacherScheduleMap = {}, historyStack = [], redoStack = [], MAX_HISTORY = 20, currentView = 'class', leaveRequests = [], DAYS = ["å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”"], globalConstraints = { teacher_unavailable: {}, fixed_courses: {} }, currentStats = null, workloadChart = null;
        let currentScheduleId = null;
        let config = {
            num_classes: 6,
            courses: [
                { name: "è¯­æ–‡", count: 5, type: "main", teachers: "åˆä¸€è¯­æ–‡1, åˆä¸€è¯­æ–‡2, åˆä¸€è¯­æ–‡3, åˆä¸€è¯­æ–‡4, åˆä¸€è¯­æ–‡5, åˆä¸€è¯­æ–‡6, åˆä¸€è¯­æ–‡7, åˆä¸€è¯­æ–‡8, åˆä¸€è¯­æ–‡9, åˆä¸€è¯­æ–‡10" },
                { name: "æ•°å­¦", count: 5, type: "main", teachers: "åˆä¸€æ•°å­¦1, åˆä¸€æ•°å­¦2, åˆä¸€æ•°å­¦3, åˆä¸€æ•°å­¦4, åˆä¸€æ•°å­¦5, åˆä¸€æ•°å­¦6, åˆä¸€æ•°å­¦7, åˆä¸€æ•°å­¦8, åˆä¸€æ•°å­¦9, åˆä¸€æ•°å­¦10" },
                { name: "è‹±è¯­", count: 5, type: "main", teachers: "åˆä¸€è‹±è¯­1, åˆä¸€è‹±è¯­2, åˆä¸€è‹±è¯­3, åˆä¸€è‹±è¯­4, åˆä¸€è‹±è¯­5, åˆä¸€è‹±è¯­6, åˆä¸€è‹±è¯­7, åˆä¸€è‹±è¯­8, åˆä¸€è‹±è¯­9, åˆä¸€è‹±è¯­10" },
                { name: "ç§‘å­¦", count: 5, type: "main", teachers: "åˆä¸€ç§‘å­¦1, åˆä¸€ç§‘å­¦2, åˆä¸€ç§‘å­¦3, åˆä¸€ç§‘å­¦4, åˆä¸€ç§‘å­¦5, åˆä¸€ç§‘å­¦6, åˆä¸€ç§‘å­¦7, åˆä¸€ç§‘å­¦8, åˆä¸€ç§‘å­¦9, åˆä¸€ç§‘å­¦10" },
                { name: "ç¤¾ä¼š", count: 5, type: "main", teachers: "åˆä¸€ç¤¾ä¼š1, åˆä¸€ç¤¾ä¼š2, åˆä¸€ç¤¾ä¼š3, åˆä¸€ç¤¾ä¼š4, åˆä¸€ç¤¾ä¼š5, åˆä¸€ç¤¾ä¼š6, åˆä¸€ç¤¾ä¼š7, åˆä¸€ç¤¾ä¼š8, åˆä¸€ç¤¾ä¼š9, åˆä¸€ç¤¾ä¼š10" },
                { name: "ä½“è‚²", count: 3, type: "minor", teachers: "ä½“è‚²1, ä½“è‚²2, ä½“è‚²3, ä½“è‚²4, ä½“è‚²5, ä½“è‚²6, ä½“è‚²7, ä½“è‚²8, ä½“è‚²9, ä½“è‚²10" },
                { name: "ç¾æœ¯", count: 1, type: "minor", teachers: "ç¾æœ¯1, ç¾æœ¯2, ç¾æœ¯3, ç¾æœ¯4, ç¾æœ¯5, ç¾æœ¯6, ç¾æœ¯7, ç¾æœ¯8, ç¾æœ¯9, ç¾æœ¯10" },
                { name: "éŸ³ä¹", count: 1, type: "minor", teachers: "éŸ³ä¹1, éŸ³ä¹2, éŸ³ä¹3, éŸ³ä¹4, éŸ³ä¹5, éŸ³ä¹6, éŸ³ä¹7, éŸ³ä¹8, éŸ³ä¹9, éŸ³ä¹10" },
                { name: "ä¿¡æ¯", count: 1, type: "minor", teachers: "ä¿¡æ¯1, ä¿¡æ¯2, ä¿¡æ¯3, ä¿¡æ¯4, ä¿¡æ¯5, ä¿¡æ¯6, ä¿¡æ¯7, ä¿¡æ¯8, ä¿¡æ¯9, ä¿¡æ¯10" },
                { name: "å¿ƒç†", count: 1, type: "minor", teachers: "å¿ƒç†1, å¿ƒç†2, å¿ƒç†3, å¿ƒç†4, å¿ƒç†5, å¿ƒç†6, å¿ƒç†7, å¿ƒç†8, å¿ƒç†9, å¿ƒç†10" },
                { name: "è¯¾å¤–æ´»åŠ¨", count: 2, type: "minor", teachers: "è¯¾å¤–æ´»åŠ¨1, è¯¾å¤–æ´»åŠ¨2, è¯¾å¤–æ´»åŠ¨3, è¯¾å¤–æ´»åŠ¨4, è¯¾å¤–æ´»åŠ¨5, è¯¾å¤–æ´»åŠ¨6, è¯¾å¤–æ´»åŠ¨7, è¯¾å¤–æ´»åŠ¨8, è¯¾å¤–æ´»åŠ¨9, è¯¾å¤–æ´»åŠ¨10" },
                { name: "æ‹“å±•è¯¾", count: 1, type: "minor", teachers: "æ‹“å±•è¯¾1, æ‹“å±•è¯¾2, æ‹“å±•è¯¾3, æ‹“å±•è¯¾4, æ‹“å±•è¯¾5, æ‹“å±•è¯¾6, æ‹“å±•è¯¾7, æ‹“å±•è¯¾8, æ‹“å±•è¯¾9, æ‹“å±•è¯¾10" },
                { name: "æ”¿æ•™æ´»åŠ¨", count: 1, type: "minor", teachers: "æ”¿æ•™æ´»åŠ¨1, æ”¿æ•™æ´»åŠ¨2, æ”¿æ•™æ´»åŠ¨3, æ”¿æ•™æ´»åŠ¨4, æ”¿æ•™æ´»åŠ¨5, æ”¿æ•™æ´»åŠ¨6, æ”¿æ•™æ´»åŠ¨7, æ”¿æ•™æ´»åŠ¨8, æ”¿æ•™æ´»åŠ¨9, æ”¿æ•™æ´»åŠ¨10" }
            ],
            optimization: {
                golden_time: true,
                avoid_consecutive_subjects: false
            },
            resources: [
                { name: "ç§‘å­¦å®éªŒå®¤", capacity: 3, subjects: "ç§‘å­¦" },
                { name: "éŸ³ä¹æ•™å®¤", capacity: 1, subjects: "éŸ³ä¹" },
                { name: "ç¾æœ¯æ•™å®¤", capacity: 1, subjects: "ç¾æœ¯" },
                { name: "è®¡ç®—æœºæˆ¿", capacity: 2, subjects: "ä¿¡æ¯" },
                { name: "å¤§æ“åœº", capacity: 4, subjects: "ä½“è‚²" }
            ]
        };

        // å¤šå¹´çº§é…ç½®æ•°æ®ç»“æ„ - é¢„è®¾ä¸åŒå¹´çº§çš„ä¸»è¯¾è€å¸ˆ
        const commonMinorCourses = [
            { name: "ä½“è‚²", count: 3, type: "minor", teachers: "ä½“è‚²1, ä½“è‚²2, ä½“è‚²3, ä½“è‚²4, ä½“è‚²5, ä½“è‚²6, ä½“è‚²7, ä½“è‚²8, ä½“è‚²9, ä½“è‚²10" },
            { name: "ç¾æœ¯", count: 1, type: "minor", teachers: "ç¾æœ¯1, ç¾æœ¯2, ç¾æœ¯3, ç¾æœ¯4, ç¾æœ¯5, ç¾æœ¯6, ç¾æœ¯7, ç¾æœ¯8, ç¾æœ¯9, ç¾æœ¯10" },
            { name: "éŸ³ä¹", count: 1, type: "minor", teachers: "éŸ³ä¹1, éŸ³ä¹2, éŸ³ä¹3, éŸ³ä¹4, éŸ³ä¹5, éŸ³ä¹6, éŸ³ä¹7, éŸ³ä¹8, éŸ³ä¹9, éŸ³ä¹10" },
            { name: "ä¿¡æ¯", count: 1, type: "minor", teachers: "ä¿¡æ¯1, ä¿¡æ¯2, ä¿¡æ¯3, ä¿¡æ¯4, ä¿¡æ¯5, ä¿¡æ¯6, ä¿¡æ¯7, ä¿¡æ¯8, ä¿¡æ¯9, ä¿¡æ¯10" },
            { name: "å¿ƒç†", count: 1, type: "minor", teachers: "å¿ƒç†1, å¿ƒç†2, å¿ƒç†3, å¿ƒç†4, å¿ƒç†5, å¿ƒç†6, å¿ƒç†7, å¿ƒç†8, å¿ƒç†9, å¿ƒç†10" },
            { name: "è¯¾å¤–æ´»åŠ¨", count: 2, type: "minor", teachers: "è¯¾å¤–æ´»åŠ¨1, è¯¾å¤–æ´»åŠ¨2, è¯¾å¤–æ´»åŠ¨3, è¯¾å¤–æ´»åŠ¨4, è¯¾å¤–æ´»åŠ¨5, è¯¾å¤–æ´»åŠ¨6, è¯¾å¤–æ´»åŠ¨7, è¯¾å¤–æ´»åŠ¨8, è¯¾å¤–æ´»åŠ¨9, è¯¾å¤–æ´»åŠ¨10" },
            { name: "æ‹“å±•è¯¾", count: 1, type: "minor", teachers: "æ‹“å±•è¯¾1, æ‹“å±•è¯¾2, æ‹“å±•è¯¾3, æ‹“å±•è¯¾4, æ‹“å±•è¯¾5, æ‹“å±•è¯¾6, æ‹“å±•è¯¾7, æ‹“å±•è¯¾8, æ‹“å±•è¯¾9, æ‹“å±•è¯¾10" },
            { name: "æ”¿æ•™æ´»åŠ¨", count: 1, type: "minor", teachers: "æ”¿æ•™æ´»åŠ¨1, æ”¿æ•™æ´»åŠ¨2, æ”¿æ•™æ´»åŠ¨3, æ”¿æ•™æ´»åŠ¨4, æ”¿æ•™æ´»åŠ¨5, æ”¿æ•™æ´»åŠ¨6, æ”¿æ•™æ´»åŠ¨7, æ”¿æ•™æ´»åŠ¨8, æ”¿æ•™æ´»åŠ¨9, æ”¿æ•™æ´»åŠ¨10" }
        ];

        let gradesData = {
            "åˆä¸€": {
                count: 6,
                start: 1,
                courses: [
                    { name: "è¯­æ–‡", count: 5, type: "main", teachers: "åˆä¸€è¯­æ–‡1, åˆä¸€è¯­æ–‡2, åˆä¸€è¯­æ–‡3, åˆä¸€è¯­æ–‡4, åˆä¸€è¯­æ–‡5, åˆä¸€è¯­æ–‡6, åˆä¸€è¯­æ–‡7, åˆä¸€è¯­æ–‡8, åˆä¸€è¯­æ–‡9, åˆä¸€è¯­æ–‡10" },
                    { name: "æ•°å­¦", count: 5, type: "main", teachers: "åˆä¸€æ•°å­¦1, åˆä¸€æ•°å­¦2, åˆä¸€æ•°å­¦3, åˆä¸€æ•°å­¦4, åˆä¸€æ•°å­¦5, åˆä¸€æ•°å­¦6, åˆä¸€æ•°å­¦7, åˆä¸€æ•°å­¦8, åˆä¸€æ•°å­¦9, åˆä¸€æ•°å­¦10" },
                    { name: "è‹±è¯­", count: 5, type: "main", teachers: "åˆä¸€è‹±è¯­1, åˆä¸€è‹±è¯­2, åˆä¸€è‹±è¯­3, åˆä¸€è‹±è¯­4, åˆä¸€è‹±è¯­5, åˆä¸€è‹±è¯­6, åˆä¸€è‹±è¯­7, åˆä¸€è‹±è¯­8, åˆä¸€è‹±è¯­9, åˆä¸€è‹±è¯­10" },
                    { name: "ç§‘å­¦", count: 5, type: "main", teachers: "åˆä¸€ç§‘å­¦1, åˆä¸€ç§‘å­¦2, åˆä¸€ç§‘å­¦3, åˆä¸€ç§‘å­¦4, åˆä¸€ç§‘å­¦5, åˆä¸€ç§‘å­¦6, åˆä¸€ç§‘å­¦7, åˆä¸€ç§‘å­¦8, åˆä¸€ç§‘å­¦9, åˆä¸€ç§‘å­¦10" },
                    { name: "ç¤¾ä¼š", count: 5, type: "main", teachers: "åˆä¸€ç¤¾ä¼š1, åˆä¸€ç¤¾ä¼š2, åˆä¸€ç¤¾ä¼š3, åˆä¸€ç¤¾ä¼š4, åˆä¸€ç¤¾ä¼š5, åˆä¸€ç¤¾ä¼š6, åˆä¸€ç¤¾ä¼š7, åˆä¸€ç¤¾ä¼š8, åˆä¸€ç¤¾ä¼š9, åˆä¸€ç¤¾ä¼š10" },
                    ...commonMinorCourses
                ]
            },
            "åˆäºŒ": {
                count: 6,
                start: 7,
                courses: [
                    { name: "è¯­æ–‡", count: 5, type: "main", teachers: "åˆäºŒè¯­æ–‡1, åˆäºŒè¯­æ–‡2, åˆäºŒè¯­æ–‡3, åˆäºŒè¯­æ–‡4, åˆäºŒè¯­æ–‡5, åˆäºŒè¯­æ–‡6, åˆäºŒè¯­æ–‡7, åˆäºŒè¯­æ–‡8, åˆäºŒè¯­æ–‡9, åˆäºŒè¯­æ–‡10" },
                    { name: "æ•°å­¦", count: 5, type: "main", teachers: "åˆäºŒæ•°å­¦1, åˆäºŒæ•°å­¦2, åˆäºŒæ•°å­¦3, åˆäºŒæ•°å­¦4, åˆäºŒæ•°å­¦5, åˆäºŒæ•°å­¦6, åˆäºŒæ•°å­¦7, åˆäºŒæ•°å­¦8, åˆäºŒæ•°å­¦9, åˆäºŒæ•°å­¦10" },
                    { name: "è‹±è¯­", count: 5, type: "main", teachers: "åˆäºŒè‹±è¯­1, åˆäºŒè‹±è¯­2, åˆäºŒè‹±è¯­3, åˆäºŒè‹±è¯­4, åˆäºŒè‹±è¯­5, åˆäºŒè‹±è¯­6, åˆäºŒè‹±è¯­7, åˆäºŒè‹±è¯­8, åˆäºŒè‹±è¯­9, åˆäºŒè‹±è¯­10" },
                    { name: "ç§‘å­¦", count: 5, type: "main", teachers: "åˆäºŒç§‘å­¦1, åˆäºŒç§‘å­¦2, åˆäºŒç§‘å­¦3, åˆäºŒç§‘å­¦4, åˆäºŒç§‘å­¦5, åˆäºŒç§‘å­¦6, åˆäºŒç§‘å­¦7, åˆäºŒç§‘å­¦8, åˆäºŒç§‘å­¦9, åˆäºŒç§‘å­¦10" },
                    { name: "ç¤¾ä¼š", count: 5, type: "main", teachers: "åˆäºŒç¤¾ä¼š1, åˆäºŒç¤¾ä¼š2, åˆäºŒç¤¾ä¼š3, åˆäºŒç¤¾ä¼š4, åˆäºŒç¤¾ä¼š5, åˆäºŒç¤¾ä¼š6, åˆäºŒç¤¾ä¼š7, åˆäºŒç¤¾ä¼š8, åˆäºŒç¤¾ä¼š9, åˆäºŒç¤¾ä¼š10" },
                    ...commonMinorCourses
                ]
            },
            "åˆä¸‰": {
                count: 6,
                start: 13,
                courses: [
                    { name: "è¯­æ–‡", count: 5, type: "main", teachers: "åˆä¸‰è¯­æ–‡1, åˆä¸‰è¯­æ–‡2, åˆä¸‰è¯­æ–‡3, åˆä¸‰è¯­æ–‡4, åˆä¸‰è¯­æ–‡5, åˆä¸‰è¯­æ–‡6, åˆä¸‰è¯­æ–‡7, åˆä¸‰è¯­æ–‡8, åˆä¸‰è¯­æ–‡9, åˆä¸‰è¯­æ–‡10" },
                    { name: "æ•°å­¦", count: 5, type: "main", teachers: "åˆä¸‰æ•°å­¦1, åˆä¸‰æ•°å­¦2, åˆä¸‰æ•°å­¦3, åˆä¸‰æ•°å­¦4, åˆä¸‰æ•°å­¦5, åˆä¸‰æ•°å­¦6, åˆä¸‰æ•°å­¦7, åˆä¸‰æ•°å­¦8, åˆä¸‰æ•°å­¦9, åˆä¸‰æ•°å­¦10" },
                    { name: "è‹±è¯­", count: 5, type: "main", teachers: "åˆä¸‰è‹±è¯­1, åˆä¸‰è‹±è¯­2, åˆä¸‰è‹±è¯­3, åˆä¸‰è‹±è¯­4, åˆä¸‰è‹±è¯­5, åˆä¸‰è‹±è¯­6, åˆä¸‰è‹±è¯­7, åˆä¸‰è‹±è¯­8, åˆä¸‰è‹±è¯­9, åˆä¸‰è‹±è¯­10" },
                    { name: "ç§‘å­¦", count: 5, type: "main", teachers: "åˆä¸‰ç§‘å­¦1, åˆä¸‰ç§‘å­¦2, åˆä¸‰ç§‘å­¦3, åˆä¸‰ç§‘å­¦4, åˆä¸‰ç§‘å­¦5, åˆä¸‰ç§‘å­¦6, åˆä¸‰ç§‘å­¦7, åˆä¸‰ç§‘å­¦8, åˆä¸‰ç§‘å­¦9, åˆä¸‰ç§‘å­¦10" },
                    { name: "ç¤¾ä¼š", count: 5, type: "main", teachers: "åˆä¸‰ç¤¾ä¼š1, åˆä¸‰ç¤¾ä¼š2, åˆä¸‰ç¤¾ä¼š3, åˆä¸‰ç¤¾ä¼š4, åˆä¸‰ç¤¾ä¼š5, åˆä¸‰ç¤¾ä¼š6, åˆä¸‰ç¤¾ä¼š7, åˆä¸‰ç¤¾ä¼š8, åˆä¸‰ç¤¾ä¼š9, åˆä¸‰ç¤¾ä¼š10" },
                    ...commonMinorCourses
                ]
            }
        };
        let currentActiveGrade = "åˆä¸€";

        /**
         * ç­çº§åç§°ç¿»è¯‘å‡½æ•°ï¼šå°† ID (21) è½¬æ¢ä¸ºä¸­æ–‡å (åˆä¸‰1ç­)
         */
        function getClassName(id) {
            id = id.toString();
            // ä¼˜å…ˆä½¿ç”¨åç«¯è¿”å›çš„å…ƒæ•°æ®åç§° (åŒ…å«å¹´çº§å‰ç¼€)
            if (globalClassNames && globalClassNames[id]) {
                return globalClassNames[id];
            }
            // å¤‡é€‰ï¼šå¦‚æœå…ƒæ•°æ®å°šæœªåŠ è½½ï¼Œå°è¯•åŸºäº gradesData çŒœæµ‹ (æ—§é€»è¾‘å…¼å®¹)
            const numId = parseInt(id);
            for (let gradeName in gradesData) {
                const g = gradesData[gradeName];
                if (numId >= g.start && numId < (g.start + g.count)) {
                    return `${gradeName}${numId - g.start + 1}ç­`;
                }
            }
            return id + "ç­";
        }

        function initGradeTabs() {
            const container = document.getElementById('grade-tabs');
            if (!container) return;
            container.innerHTML = '';

            Object.keys(gradesData).forEach(grade => {
                const btn = document.createElement('button');
                const isActive = grade === currentActiveGrade;
                btn.className = `px-4 py-1.5 rounded-md text-xs font-bold transition-all ${isActive ? 'bg-blue-400 text-white shadow-md' : 'text-slate-500 hover:bg-white'
                    }`;
                btn.innerText = grade;
                btn.onclick = () => switchGrade(grade);
                container.appendChild(btn);
            });
        }

        function switchGrade(targetGrade) {
            saveCurrentGradeToMemory();
            currentActiveGrade = targetGrade;
            initGradeTabs();

            const data = gradesData[targetGrade];
            document.getElementById('grade-count-input').value = data.count;
            document.getElementById('grade-start-input').value = data.start;

            const tbody = document.getElementById('course-settings-body');
            tbody.innerHTML = '';
            data.courses.forEach(c => addCourseRow(c.name, c.count, c.type, c.teachers, c.am_count, c.pm_count));
            updateTotalHours();
        }

        function saveCurrentGradeToMemory() {
            const countInput = document.getElementById('grade-count-input');
            const startInput = document.getElementById('grade-start-input');
            if (!countInput || !startInput) return;

            const count = parseInt(countInput.value) || 0;
            const start = parseInt(startInput.value) || 1;

            let currentCourses = [];
            document.querySelectorAll('#course-settings-body tr').forEach(r => {
                const n = r.querySelector('.course-name').value;
                const c = parseInt(r.querySelector('.course-count').value);
                const t = r.querySelector('.course-type').value;
                const tags = r.querySelector('.course-tags').value;
                const teachers = r.querySelector('.course-teachers').value;
                const am = r.querySelector('.course-am').value;
                const pm = r.querySelector('.course-pm').value;

                if (n && c > 0) {
                    currentCourses.push({
                        name: n,
                        count: c,
                        type: t,
                        tags: tags,
                        teachers: teachers,
                        am_count: am !== "" ? parseInt(am) : null,
                        pm_count: pm !== "" ? parseInt(pm) : null
                    });
                }
            });

            gradesData[currentActiveGrade] = {
                count: count,
                start: start,
                courses: currentCourses
            };
        }

        window.onload = () => {
            setTimeout(() => document.getElementById('splash-screen').style.opacity = 0, 800);
            setTimeout(() => document.getElementById('splash-screen').remove(), 1400);
            checkSession();
            renderSettings(); updateTotalHours(); loadSavedList();
        };

        async function checkSession() {
            try {
                const res = await fetch('/api/list');
                if (res.status === 401 || res.redirected) window.location.href = '/login';
            } catch (e) { console.error("Session check failed"); }
        }

        function toggleSidebar() {
            const s = document.getElementById('main-sidebar');
            s.classList.toggle('-translate-x-full');
        }

        function renderCurrentClass() {
            const cid = document.getElementById('class-select').value; if (!globalSchedule[cid]) return;
            document.getElementById('class-title').innerText = `${getClassName(cid)} è¯¾è¡¨`;
            const tbody = document.getElementById('schedule-body'); tbody.innerHTML = '';
            for (let p = 0; p < 8; p++) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="text-slate-400 font-bold bg-transparent text-xs">ç¬¬ ${p + 1} èŠ‚</td>`;
                for (let d = 0; d < 5; d++) {
                    const td = document.createElement('td');
                    td.dataset.day = d; td.dataset.period = p;
                    td.draggable = true; td.ondragstart = (e) => handleDragStart(e, p, d); td.ondragover = handleDragOver; td.ondrop = (e) => handleDrop(e, p, d); td.ondragend = handleDragEnd;

                    const info = globalSchedule[cid][p][d];
                    td.className = info ? "p-0" : "p-0";
                    const innerDiv = document.createElement('div');
                    innerDiv.className = info ? "schedule-cell mx-auto w-full h-full" : "schedule-cell empty mx-auto w-full h-full";

                    if (info) {
                        let colorClass = info.course_type === 'main' ? 'text-slate-600' : 'text-slate-400';
                        if (info.is_sub) colorClass = info.teacher_name === "ã€è‡ªä¹ ã€‘" ? 'text-red-400' : 'text-green-500';

                        // [æ–°å¢] å°è¯•åŒ¹é…æ•™å®¤
                        const roomName = getRoomName(info.subject);

                        innerDiv.innerHTML = `<div class="${colorClass} font-black text-xl tracking-tight">${info.subject}</div>
                                       <div class="text-[10px] text-slate-400 font-bold mt-1 bg-white/50 px-2 rounded-full">${info.teacher_name}</div>
                                       ${roomName ? `<div class="mt-1"><span class="bg-indigo-100 text-indigo-500 text-[9px] px-1.5 py-0.5 rounded uppercase font-bold tracking-wider">${roomName}</span></div>` : ''}`;
                    } else {
                        innerDiv.innerHTML = `<span class="text-slate-300 font-bold text-xs">-</span>`;
                    }
                    td.appendChild(innerDiv);
                    tr.appendChild(td);
                }
                tbody.appendChild(tr);
            }
        }

        let draggedSource = null; const tooltipEl = document.getElementById('conflict-tooltip');

        function handleDragStart(e, p, d) {
            const td = e.target.closest('td');
            const cid = document.getElementById('class-select').value;
            if (!globalSchedule[cid] || !globalSchedule[cid][p] || !globalSchedule[cid][p][d]) { e.preventDefault(); return; }

            const info = globalSchedule[cid][p][d];
            draggedSource = { period: p, day: d, teacher: info ? info.teacher_name : null, teacherId: info ? info.teacher_id : null, element: td };
            e.dataTransfer.effectAllowed = 'move';

            setTimeout(() => { if (td) td.classList.add('opacity-40', 'bg-blue-100'); }, 0);
        }

        function handleDragOver(e) {
            e.preventDefault(); e.dataTransfer.dropEffect = 'move';
            const td = e.target.closest('td'); if (!td) return;

            document.querySelectorAll('.drag-over-active').forEach(el => el.classList.remove('drag-over-active'));
            td.classList.add('drag-over-active');

            const tD = td.dataset.day, tP = td.dataset.period;
            if (draggedSource && draggedSource.teacher) {
                const conflict = teacherScheduleMap[draggedSource.teacher]?.[`${tD}_${tP}`];
                const cid = document.getElementById('class-select').value;
                if (conflict && conflict.classId != cid) {
                    tooltipEl.style.display = 'block'; tooltipEl.style.left = (e.pageX + 10) + 'px'; tooltipEl.style.top = (e.pageY + 10) + 'px';
                    tooltipEl.innerHTML = `<i class="bi bi-exclamation-circle-fill mr-1"></i> å†²çª: ${draggedSource.teacher} åœ¨ ${conflict.classId} ç­æœ‰è¯¾`;
                    return;
                }
            }
            tooltipEl.style.display = 'none';
        }

        function handleDragEnd(e) {
            const td = e.target.closest('td'); if (td) td.classList.remove('opacity-40', 'bg-blue-100');
            document.querySelectorAll('td').forEach(el => el.classList.remove('opacity-40', 'bg-blue-100'));
            tooltipEl.style.display = 'none'; draggedSource = null;
        }

        async function handleDrop(e) {
            e.preventDefault();
            const td = e.target.closest('td');

            // 1. å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœæ²¡æœ‰ç›®æ ‡æˆ–æ²¡æœ‰æ‹–æ‹½æºï¼Œç›´æ¥æ¸…ç†å¹¶é€€å‡º
            if (!td || !draggedSource) {
                handleDragEnd(e);
                return;
            }

            // 2. å…³é”®ä¿®å¤ï¼šå…ˆè·å–æ•°æ®ï¼Œå†æ¸…ç†æ ·å¼ï¼
            // (å¦‚æœåœ¨æ¸…ç†åå†è·å–ï¼ŒdraggedSource å°±å˜æˆ null äº†)
            const tD = parseInt(td.dataset.day);
            const tP = parseInt(td.dataset.period);
            const sD = draggedSource.day;
            const sP = draggedSource.period;

            // 3. ç«‹å³æ¸…ç†æ ·å¼ (ç§»é™¤åŠé€æ˜æ•ˆæœ)
            handleDragEnd(e);

            // 4. å¦‚æœä½ç½®æ²¡å˜ï¼Œç›´æ¥è¿”å›
            if (sD === tD && sP === tP) return;

            const cid = document.getElementById('class-select').value;

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('loading-state').classList.remove('hidden');

            pushHistory(); // è®°å½• Undo

            try {
                const res = await fetch('/api/schedule/move', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        schedule_id: currentScheduleId,
                        class_id: cid,
                        from_slot: [sD, sP],
                        to_slot: [tD, tP]
                    })
                });

                const data = await res.json();

                if (data.status === 'success') {
                    globalSchedule = data.schedule;
                    renderCurrentClass(); // é‡æ–°æ¸²æŸ“è§†å›¾
                } else {
                    alert("è°ƒè¯¾å¤±è´¥: " + data.message);
                    // å¦‚æœå¤±è´¥ï¼Œå»ºè®®æ’¤é”€ä¸€æ¬¡å†å²è®°å½•ä»¥ä¿æŒä¸€è‡´
                    historyStack.pop();
                    updateUndoButtons();
                }
            } catch (err) {
                console.error(err);
                alert("ç½‘ç»œè¯·æ±‚å¤±è´¥");
                historyStack.pop();
                updateUndoButtons();
            } finally {
                document.getElementById('loading-state').classList.add('hidden');
            }
        }

        async function initSystem() {
            // 1. è·å–ä¼˜åŒ–å¼€å…³çŠ¶æ€
            const avoidConsecutive = document.getElementById('check-avoid-consecutive')?.checked || false;
            if (!config.optimization) config.optimization = {};
            config.optimization.avoid_consecutive_subjects = avoidConsecutive;

            // 2. ç›´æ¥è°ƒç”¨æ ¸å¿ƒæ’è¯¾å‡½æ•°
            // saveSettingsAndInit è´Ÿè´£æ”¶é›†æ‰€æœ‰æ•°æ® (å¹´çº§ã€è¯¾ç¨‹ã€èµ„æº) å¹¶å‘é€ fetch è¯·æ±‚
            saveSettingsAndInit();
        }
        function updateUI(data) {
            if (data.stats) {
                currentStats = data.stats;
                document.getElementById('btn-stats').disabled = false;
            }

            // [ä¿®æ”¹] å¢å¼ºæŠ¥å‘ŠæŒ‰é’®çš„ç‚¹äº®é€»è¾‘
            if (data.rule_report || (data.schedule && data.schedule.rule_report)) {
                globalRuleReport = data.rule_report || data.schedule.rule_report || [];

                const btn = document.getElementById('btn-rule-report');
                btn.disabled = false;

                const failCount = globalRuleReport.filter(r => r.status === 'failed').length;
                if (failCount > 0) {
                    btn.classList.add('animate-pulse', 'text-red-500');
                    btn.innerHTML = `<i class="bi bi-exclamation-triangle-fill text-xl"></i> è§„åˆ™å†²çª (${failCount})`;
                } else {
                    btn.classList.remove('animate-pulse', 'text-red-500');
                    if (globalRuleReport.length > 0) {
                        btn.innerHTML = `<i class="bi bi-clipboard-check-fill text-xl"></i> è§„åˆ™æ‰§è¡Œå®Œç¾`;
                        btn.classList.add('text-green-600');
                    } else {
                        btn.innerHTML = `<i class="bi bi-clipboard text-xl"></i> æš‚æ— è§„åˆ™`;
                        btn.classList.remove('text-green-600');
                    }
                }
            }

            // [æ–°å¢] å¼¹å‡ºæ™ºèƒ½è°ƒé…æŠ¥å‘Š (Sharding Report)
            if (data.sharding_info && data.sharding_info.length > 0) {
                const container = document.getElementById('sharding-content');

                // æŒ‰ç­çº§åˆ†ç»„å±•ç¤º
                const grouped = {};
                data.sharding_info.forEach(item => {
                    const key = `${item.class_id} ç­`;
                    if (!grouped[key]) grouped[key] = [];
                    grouped[key].push(item);
                });

                let html = "";
                for (let className in grouped) {
                    html += `
                    <div class="clay-inner p-4 rounded-3xl bg-white/50 border border-orange-50/50">
                        <div class="flex items-center gap-2 mb-3">
                            <i class="bi bi-mortarboard text-orange-400"></i>
                            <span class="font-black text-slate-600">${className}</span>
                        </div>
                        <div class="space-y-2">`;

                    grouped[className].forEach(info => {
                        html += `
                        <div class="flex items-center justify-between p-3 rounded-2xl bg-white shadow-sm border border-slate-50">
                            <div class="flex flex-col">
                                <span class="text-[10px] text-slate-400 font-bold uppercase tracking-tighter">${info.subject}</span>
                                <div class="flex items-center gap-2">
                                    <span class="text-slate-400 line-through text-xs">${info.original}</span>
                                    <i class="bi bi-arrow-right text-orange-500"></i>
                                    <span class="text-slate-700 font-black text-sm">${info.substitute}</span>
                                </div>
                            </div>
                            <div class="px-2 py-1 rounded-lg bg-orange-50 text-orange-600 font-black text-[10px]">
                                ${info.count} èŠ‚
                            </div>
                        </div>`;
                    });

                    html += `</div></div>`;
                }

                container.innerHTML = html || `<div class="text-center py-8 text-slate-400 italic">æš‚æ— è‡ªåŠ¨è°ƒé…è®°å½•</div>`;

                // å»¶è¿Ÿå¼¹å‡ºï¼Œè®©ä¸» UI å…ˆæ›´æ–°
                setTimeout(() => {
                    new bootstrap.Modal(document.getElementById('shardingModal')).show();
                }, 800);
            }

            globalTeachers = data.teachers || [];
            globalClassNames = data.class_names || {}; // [æ–°å¢] ç¼“å­˜ç­çº§ ID -> åç§°æ˜ å°„
            globalSchedule = data.schedule;

            teacherScheduleMap = {};
            for (let c in globalSchedule) {
                for (let p in globalSchedule[c]) {
                    for (let d in globalSchedule[c][p]) {
                        const i = globalSchedule[c][p][d];
                        if (i && i.teacher_name) {
                            if (!teacherScheduleMap[i.teacher_name]) teacherScheduleMap[i.teacher_name] = {};
                            teacherScheduleMap[i.teacher_name][`${d}_${p}`] = { classId: c, subject: i.subject };
                        }
                    }
                }
            }

            const ts = document.getElementById('teacher-select'); ts.innerHTML = ''; globalTeachers.forEach(t => ts.add(new Option(t.name, t.name)));
            const cs = document.getElementById('class-select');
            cs.innerHTML = '';
            Object.keys(globalSchedule).sort((a, b) => parseInt(a) - parseInt(b)).forEach(k => cs.add(new Option(getClassName(k), k)));

            const tvs = document.getElementById('teacher-view-select'); tvs.innerHTML = ''; globalTeachers.forEach(t => tvs.add(new Option(t.name, t.name)));
            renderCurrentClass();
            ['btn-add-leave', 'btn-apply', 'btn-save', 'btn-export-current', 'btn-view-teacher', 'btn-undo', 'teacher-select'].forEach(i => document.getElementById(i).disabled = false);
        }
        function switchView(v) {
            currentView = v; document.getElementById('class-selector-group').style.display = v === 'class' ? 'block' : 'none'; document.getElementById('teacher-selector-group').style.display = v === 'teacher' ? 'block' : 'none';
            document.getElementById('btn-view-class').className = v === 'class' ? 'clay-btn px-4 py-2 text-sm text-blue-500 bg-white' : 'clay-btn px-4 py-2 text-sm text-slate-400';
            document.getElementById('btn-view-teacher').className = v === 'teacher' ? 'clay-btn px-4 py-2 text-sm text-blue-500 bg-white' : 'clay-btn px-4 py-2 text-sm text-slate-400';
            if (v === 'class') renderCurrentClass(); else renderCurrentTeacher();
        }

        async function renderCurrentTeacher() {
            const name = document.getElementById('teacher-view-select').value; const res = await fetch('/api/teacher_view', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ schedule_id: currentScheduleId, teacher_name: name }) }); const data = await res.json(); if (data.status === 'success') {
                const tbody = document.getElementById('schedule-body'); tbody.innerHTML = '';
                for (let p = 0; p < 8; p++) {
                    const tr = document.createElement('tr'); tr.innerHTML = `<td class="text-slate-400 font-bold bg-transparent text-xs">ç¬¬ ${p + 1} èŠ‚</td>`;
                    for (let d = 0; d < 5; d++) {
                        const td = document.createElement('td'); const info = data.schedule[p][d];
                        td.className = "p-0";
                        td.innerHTML = `<div class="schedule-cell mx-auto w-full h-full ${info ? '' : 'empty'}">${info ? `<div class="text-blue-500 font-black">${getClassName(info.class_id)}</div><div class="text-sm text-slate-400">${info.subject}</div>` : '<span class="text-slate-300">-</span>'}</div>`; tr.appendChild(td);
                    } tbody.appendChild(tr);
                }
                document.getElementById('class-title').innerText = `æ•™å¸ˆ: ${name}`;
            }
        }

        async function loadSavedList() {
            const res = await fetch('/api/list'); const data = await res.json(); document.getElementById('saved-list').innerHTML = data.schedules ? data.schedules.map(s => `
            <div class="clay-btn p-2 flex justify-between items-center mb-2 group hover:bg-white transition-colors">
                <span onclick="loadSchedule('${s.name}')" class="text-xs font-bold truncate flex-1 cursor-pointer text-slate-500 hover:text-blue-500 pl-1">${s.name}</span>
                
                <button onclick="targetDeleteName='${s.name}'; new bootstrap.Modal(document.getElementById('deleteConfirmModal')).show()" 
                        class="w-6 h-6 rounded bg-transparent text-slate-300 hover:bg-red-50 hover:text-red-500 flex items-center justify-center transition-all">
                    <i class="bi bi-trash3 text-xs"></i>
                </button>
            </div>`).join('') : '<div class="text-xs text-slate-400 text-center py-2">æš‚æ— å­˜æ¡£</div>';
        }
        async function loadSchedule(n) {
            const res = await fetch(`/api/load/${encodeURIComponent(n)}`);
            const data = await res.json();
            if (data.status === 'success') {
                currentScheduleId = data.schedule_id;
                if (!data.schedule.schedule) {
                    globalSchedule = data.schedule;
                } else {
                    globalSchedule = data.schedule.schedule;
                }
                config = data.config || config;
                renderSettings();
                updateUI(data);
            }
        }
        async function saveCurrentSchedule() {
            // [å…³é”®ä¿®æ”¹] ä¿å­˜å‰å¼ºåˆ¶åŒæ­¥ UI æ•°æ®
            syncUItoConfig();
            const n = document.getElementById('save-name').value;
            if (!n) return alert("è¯·è¾“å…¥æ–¹æ¡ˆåç§°");
            await fetch('/api/save', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ schedule_id: currentScheduleId, name: n, config }) });
            document.getElementById('save-name').value = '';
            loadSavedList();
            alert("æ–¹æ¡ˆåŠå½“å‰é…ç½®å·²ä¿å­˜ï¼");
        }

        function openSettings() {
            // åˆå§‹åŒ–ä¸‰ä¸ªå¹´çº§çš„ Tabs
            initGradeTabs();
            // é»˜è®¤åŠ è½½å½“å‰å·²å­˜çš„æ•°æ® (åˆ‡åˆ°åˆä¸€)
            switchGrade("åˆä¸€");
            new bootstrap.Modal(document.getElementById('settingsModal')).show();
        }

        function openConstraints() {
            // åŒæ­¥å…¨å±€çŠ¶æ€åˆ° UI
            const isAvoid = config.optimization && config.optimization.avoid_consecutive_subjects === true;
            const chk = document.getElementById('check-avoid-consecutive');
            if (chk) chk.checked = isAvoid;

            // æ˜¾ç¤º Modal
            bootstrap.Modal.getOrCreateInstance(document.getElementById('constraintModal')).show();
        }

        function saveConstraintsAndRun() {
            // 1. å…³é—­æ¨¡æ€æ¡†
            const modalEl = document.getElementById('constraintModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();

            // 2. ç»™ç”¨æˆ·ä¸€ç‚¹åé¦ˆï¼Œé˜²æ­¢è¯¯è§¦
            // ç®€å•çš„ç¡®è®¤é€»è¾‘ï¼Œå› ä¸ºé‡æ’ä¼šè¦†ç›–å½“å‰è¯¾è¡¨
            if (confirm("åº”ç”¨æ–°çº¦æŸå¹¶é‡æ–°ç”Ÿæˆè¯¾è¡¨ï¼Ÿ\n(æ³¨æ„ï¼šå½“å‰æœªä¿å­˜çš„è¯¾è¡¨å˜åŠ¨å°†ä¼šä¸¢å¤±)")) {
                // 3. è°ƒç”¨æ ¸å¿ƒæ’è¯¾å‡½æ•°
                initSystem();
            } else {
                // å¦‚æœç”¨æˆ·ç‚¹äº†å–æ¶ˆï¼Œé‡æ–°æŠŠæ¨¡æ€æ¡†æ‰“å¼€ï¼ˆå¯é€‰ï¼Œä¸ºäº†ä½“éªŒæ›´å¥½ï¼‰
                modal.show();
            }
        }

        function getRoomName(subject) {
            // ç®€å•åŒ¹é…ï¼šéå†èµ„æºåˆ—è¡¨ï¼Œçœ‹è°çš„ subjects åŒ…å«äº†è¿™ä¸ªç§‘ç›®
            // config.resources structure: [{name: 'Lab', capacity: 1, subjects: 'Physics, Science'}]
            if (!config.resources) return null;

            // ç¼“å­˜ä¸€ä¸‹ Map å¯èƒ½ä¼šæ€§èƒ½æ›´å¥½ï¼Œä½†è¿™é‡Œæ•°æ®é‡å°ï¼Œç›´æ¥éå†ä¹Ÿæ— å¦¨
            for (let r of config.resources) {
                if (r.subjects) {
                    // æ”¯æŒä¸­è‹±æ–‡é€—å·
                    const subjs = r.subjects.split(/[,ï¼Œ]/).map(s => s.trim());
                    if (subjs.includes(subject)) {
                        return r.name;
                    }
                }
            }
            return null;
        }

        // [æ–°å¢] 1. æ·»åŠ æ•™å¸ˆé™åˆ¶è¡Œçš„å‡½æ•°
        function addTeacherLimitRow(name = "", min = "", max = "", tags = "") {
            const deleteBtn = `
                <button class="w-8 h-8 rounded-lg bg-white border border-red-100 text-red-400 hover:bg-red-50 hover:border-red-200 hover:text-red-500 flex items-center justify-center transition-all shadow-sm mx-auto" 
                        onclick="this.closest('tr').remove()">
                    <i class="bi bi-trash3"></i>
                </button>`;

            const html = `
            <tr>
                <td class="pr-0"><input class="clay-input w-full py-2 px-2 text-sm border-0 !rounded-lg limit-name" value="${name}" placeholder="å§“å"></td>
                <td class="pr-0"><input type="number" class="clay-input w-full py-2 px-1 text-sm border-0 !rounded-lg limit-min text-center" value="${min}" placeholder="ä¸é™"></td>
                <td class="pr-0"><input type="number" class="clay-input w-full py-2 px-1 text-sm border-0 !rounded-lg limit-max text-center" value="${max}" placeholder="ä¸é™"></td>
                <td class="pr-0"><input class="clay-input w-full py-2 px-2 text-sm border-0 !rounded-lg limit-tags" value="${tags}" placeholder="æ ‡ç­¾..."></td>
                <td class="text-center">${deleteBtn}</td>
            </tr>`;
            document.getElementById('teacher-limits-body').insertAdjacentHTML('beforeend', html);
        }

        function addResourceRow(n = "", c = 1, s = "") {
            // ç»Ÿä¸€çš„åˆ é™¤æŒ‰é’®æ ·å¼
            const deleteBtn = `
                <button class="w-8 h-8 rounded-lg bg-white border border-red-100 text-red-400 hover:bg-red-50 hover:border-red-200 hover:text-red-500 flex items-center justify-center transition-all shadow-sm mx-auto" 
                        onclick="this.closest('tr').remove()">
                    <i class="bi bi-trash3"></i>
                </button>`;

            const html = `
            <tr>
                <td class="pr-0"><input class="clay-input w-full py-2 px-2 text-sm border-0 !rounded-lg course-name" value="${n}" placeholder="èµ„æºå"></td>
                <td class="pr-0"><input type="number" class="clay-input w-full py-2 px-1 text-sm border-0 !rounded-lg course-capacity text-center" value="${c}" min="1"></td>
                <td class="pr-0"><input class="clay-input w-full py-2 px-2 text-sm border-0 !rounded-lg course-subjects" value="${s}" placeholder="é€‚ç”¨ç§‘ç›®"></td>
                <td class="text-center">${deleteBtn}</td>
            </tr>`;
            document.getElementById('resource-settings-body').insertAdjacentHTML('beforeend', html);
        }
        function addCourseRow(n = "", c = 2, t = "main", ts = "", am = "", pm = "", tags = "") {
            // ç»Ÿä¸€çš„åˆ é™¤æŒ‰é’®æ ·å¼
            const deleteBtn = `
                <button class="w-8 h-8 rounded-lg bg-white border border-red-100 text-red-400 hover:bg-red-50 hover:border-red-200 hover:text-red-500 flex items-center justify-center transition-all shadow-sm mx-auto" 
                        onclick="this.closest('tr').remove(); updateTotalHours()">
                    <i class="bi bi-trash3"></i>
                </button>`;

            const html = `
            <tr class="group">
                <td style="width: 80px;"><input class="clay-input text-sm border-0 !rounded-lg course-name" style="width:100%; padding: 8px 4px !important;" value="${n}" placeholder="ç§‘ç›®"></td>
                <td style="width: 50px;"><input type="number" class="clay-input text-sm border-0 !rounded-lg course-count text-center" style="width:100%; padding: 8px 0 !important;" value="${c}" onchange="updateTotalHours()" oninput="updateTotalHours()"></td>
                <td style="width: 70px;">
                    <select class="clay-input w-full py-2 px-1 text-sm border-0 !rounded-lg course-type">
                        <option value="main" ${t === 'main' ? 'selected' : ''}>ä¸»è¯¾</option>
                        <option value="minor" ${t === 'minor' ? 'selected' : ''}>å‰¯è¯¾</option>
                    </select>
                </td>
                <td style="width: 100px;" class="text-center">
                    <div class="flex items-center gap-1 justify-center bg-[#eef2f6] p-1 rounded-lg !shadow-[inset_2px_2px_4px_#dce1e8,inset_-2px_-2px_4px_#ffffff] mx-1">
                        <input type="number" class="bg-transparent w-7 py-0.5 px-0 text-center text-xs font-bold text-blue-500 course-am" 
                               value="${am}" placeholder="AM" min="0">
                        <span class="text-slate-300">/</span>
                        <input type="number" class="bg-transparent w-7 py-0.5 px-0 text-center text-xs font-bold text-orange-400 course-pm" 
                               value="${pm}" placeholder="PM" min="0">
                    </div>
                </td>
                <td style="width: 100px;"><input class="clay-input w-full py-2 px-2 text-sm border-0 !rounded-lg course-tags text-xs" value="${tags}" placeholder="æ ‡ç­¾..."></td>
                <td style="width: auto;"><input class="clay-input w-full py-2 px-3 text-sm border-0 !rounded-lg course-teachers text-xs" value="${ts}" placeholder="è€å¸ˆå§“å..."></td>
                <td style="width: 50px;" class="text-center">${deleteBtn}</td>
            </tr>`;

            document.getElementById('course-settings-body').insertAdjacentHTML('beforeend', html);
            updateTotalHours(); // æ·»åŠ è¡Œåç«‹å³é‡æ–°è®¡ç®—
        }

        // [ä¼˜åŒ–ç‰ˆ] è§„åˆ™å‚æ•°åŠ¨æ€æ›´æ–°
        function updateRuleParams(select) {
            const card = select.closest('.rule-card');
            const container = card.querySelector('.rule-params-container');
            const type = select.value;
            let html = '';

            // ç»Ÿä¸€æ ·å¼ï¼šç²˜åœŸé£å‡¹é™·è¾“å…¥æ¡†ï¼Œæ›´å¤§æ›´é•¿
            const inputClass = "w-full clay-input py-3 px-4 text-sm font-mono text-indigo-600";

            // æŒ‰é’®æ ·å¼ - å®½çš„é•¿æ–¹å½¢ç²˜åœŸé£æŒ‰é’®
            const pickBtn = `<button class="clay-btn w-full py-3 text-sm font-bold text-white" style="background: linear-gradient(135deg, #8b5cf6, #6366f1); box-shadow: 4px 4px 12px rgba(139, 92, 246, 0.4);" onclick="openRuleSlotPicker(this)">é€‰æ‹©æ—¶æ®µ</button>`;

            if (type === 'FORBIDDEN_SLOTS' || type === 'FIXED_SLOTS') {
                html = `
                    <div class="flex flex-col items-center gap-4 py-2">
                        <div class="w-full">
                            <label class="text-xs text-slate-500 font-bold block text-center mb-2">æ—¶æ®µåæ ‡</label>
                            <input class="${inputClass} rule-param-slots text-center" placeholder="ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®é€‰æ‹©" readonly>
                        </div>
                        ${pickBtn}
                    </div>`;
            } else if (type === 'ZONE_COUNT') {
                html = `
                    <div class="flex flex-col items-center gap-4 py-2">
                        <div class="w-full">
                            <label class="text-xs text-slate-500 font-bold block text-center mb-2">é™åˆ¶åŒºåŸŸ</label>
                            <input class="${inputClass} rule-param-slots text-center" placeholder="ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®é€‰æ‹©" readonly>
                        </div>
                        ${pickBtn}
                        <div class="flex items-center justify-center gap-3 w-full">
                            <span class="text-sm font-bold text-slate-600">è¯¥åŒºåŸŸå¿…é¡»æ’</span>
                            <input type="number" class="clay-input w-20 py-2 text-center text-lg font-bold text-blue-600 rule-param-count" value="4">
                            <span class="text-sm font-bold text-slate-600">èŠ‚è¯¾</span>
                        </div>
                    </div>`;
            } else if (type === 'CONSECUTIVE') {
                html = `
                    <div class="flex flex-col items-center gap-3 py-2">
                        <label class="text-xs text-slate-500 font-bold">æœ€å¤§è¿å ‚æ•°</label>
                        <div class="flex items-center gap-3">
                            <input type="number" class="clay-input w-24 py-3 text-center text-xl font-bold text-blue-600 rule-param-max" value="1">
                            <span class="text-sm text-slate-500 font-bold">èŠ‚</span>
                        </div>
                        <div class="text-xs text-slate-400">ä¾‹å¦‚ï¼šè®¾ä¸º 1 è¡¨ç¤ºç¦æ­¢ 2 èŠ‚è¿æ’</div>
                    </div>`;
            } else if (type === 'GLOBAL_CAPACITY') {
                html = `
                    <div class="flex flex-col items-center gap-3 py-2">
                        <label class="text-xs text-slate-500 font-bold">å…¨æ ¡å¹¶å‘ä¸Šé™</label>
                        <div class="flex items-center gap-3">
                            <input type="number" class="clay-input w-24 py-3 text-center text-xl font-bold text-blue-600 rule-param-capacity" value="1">
                            <span class="text-sm text-slate-500 font-bold">ä¸ªç­</span>
                        </div>
                    </div>`;
            } else if (type === 'SPECIAL_DAYS') {
                html = `
                    <div class="flex flex-col items-center gap-3 py-2">
                        <label class="text-xs text-slate-500 font-bold">ç¦æ’æ˜ŸæœŸ (0=å‘¨ä¸€)</label>
                        <input class="${inputClass} rule-param-days text-center" placeholder="ä¾‹å¦‚: [0, 4] è¡¨ç¤ºå‘¨ä¸€å’Œå‘¨äº”">
                    </div>`;
            }
            container.innerHTML = html;
        }

        // [æ–°å¢] è§„åˆ™ä¸­å¿ƒå¯è§†åŒ–æ—¶æ®µé€‰æ‹©é€»è¾‘
        let currentEditingRuleSlots = [];
        let targetRuleInput = null;

        // [ä¼˜åŒ–ç‰ˆ] é€‚é…å¡ç‰‡å¼ç»“æ„
        function openRuleSlotPicker(btn) {
            const container = btn.closest('.rule-params-container');
            targetRuleInput = container.querySelector('.rule-param-slots');
            try {
                currentEditingRuleSlots = JSON.parse(targetRuleInput.value || "[]");
            } catch (e) {
                currentEditingRuleSlots = [];
            }
            renderRuleSlotGrid();
            new bootstrap.Modal(document.getElementById('ruleSlotModal')).show();
        }

        function renderRuleSlotGrid() {
            const tbody = document.getElementById('rule-slot-tbody');
            if (!tbody) return;
            tbody.innerHTML = '';
            for (let p = 0; p < 8; p++) {
                const tr = document.createElement('tr');
                tr.style.height = '48px';
                tr.innerHTML = `<th class="text-slate-300 text-[10px] pr-2 align-middle font-black">${p + 1}</th>`;
                for (let d = 0; d < 5; d++) {
                    const td = document.createElement('td');
                    td.className = "p-1";
                    const isActive = Array.isArray(currentEditingRuleSlots) && currentEditingRuleSlots.some(s => s[0] === d && s[1] === p);

                    // ä¿®æ­£ï¼štd ä¿æŒ table-cellï¼Œå†…éƒ¨ä½¿ç”¨å±…ä¸­çš„ flex å®¹å™¨
                    td.className = "p-1";
                    const bgColor = isActive ? '#f3e8ff' : '#ffffff';
                    const dotColor = isActive ? '#a855f7' : '#e2e8f0';

                    const dotSize = isActive ? '12px' : '6px';
                    td.innerHTML = `<div style="width:40px;height:40px;background:${bgColor};cursor:pointer;display:flex;align-items:center;justify-center:center;border:1px solid #eee;border-radius:10px;margin:auto;"><div style="width:${dotSize};height:${dotSize};background:${dotColor};border-radius:50%"></div></div>`;

                    const _d = d, _p = p;
                    td.onclick = () => {
                        if (!Array.isArray(currentEditingRuleSlots)) currentEditingRuleSlots = [];
                        const idx = currentEditingRuleSlots.findIndex(s => s[0] === _d && s[1] === _p);
                        if (idx >= 0) currentEditingRuleSlots.splice(idx, 1);
                        else currentEditingRuleSlots.push([_d, _p]);
                        renderRuleSlotGrid();
                    };
                    tr.appendChild(td);
                }
                tbody.appendChild(tr);
            }
        }

        function confirmRuleSlots() {
            if (targetRuleInput) {
                // æ’åºä»¥ä¿æŒæ•´æ´
                currentEditingRuleSlots.sort((a, b) => a[0] === b[0] ? a[1] - b[1] : a[0] - b[0]);
                targetRuleInput.value = JSON.stringify(currentEditingRuleSlots);
            }
            bootstrap.Modal.getInstance(document.getElementById('ruleSlotModal')).hide();
        }

        // ============ AI è§„åˆ™ç”ŸæˆåŠŸèƒ½ (ä¼˜åŒ–ç‰ˆ) ============
        async function callAiGeneration() {
            const inputEl = document.getElementById('ai-input-text');
            const text = inputEl.value.trim();
            if (!text) return alert("è¯·è¾“å…¥æè¿°ï¼");

            // UI çŠ¶æ€åˆ‡æ¢
            const btn = document.getElementById('btn-ai-gen');
            const loading = document.getElementById('ai-loading');
            const preview = document.getElementById('ai-result-preview');
            const loadingText = loading.querySelector('p');

            btn.disabled = true;
            loading.classList.remove('hidden');
            preview.classList.add('hidden');

            // åŠ è½½åŠ¨ç”»æ–‡æ¡ˆè½®æ’­
            const steps = ["æ­£åœ¨ç†è§£æ‚¨çš„éœ€æ±‚...", "æ­£åœ¨æ£€ç´¢ç›¸å…³è€å¸ˆå’Œç§‘ç›®...", "æ­£åœ¨æ„å»ºçº¦æŸæ¨¡å‹...", "å³å°†å®Œæˆ..."];
            let stepIndex = 0;
            const intervalId = setInterval(() => {
                stepIndex = (stepIndex + 1) % steps.length;
                if (loadingText) loadingText.innerText = steps[stepIndex];
            }, 800);

            try {
                // 1. æ”¶é›†å½“å‰ä¸Šä¸‹æ–‡ (ç§‘ç›®ã€å¹´çº§ã€è€å¸ˆ)
                const allSubjects = new Set();
                const allTeachers = new Set();
                Object.values(gradesData).forEach(g => {
                    g.courses.forEach(c => {
                        allSubjects.add(c.name);
                        if (c.teachers) {
                            c.teachers.split(/[,ï¼Œ\s]+/).forEach(t => {
                                if (t.trim()) allTeachers.add(t.trim());
                            });
                        }
                    });
                });
                const allGrades = Object.keys(gradesData).length > 0 ? Object.keys(gradesData) : ["åˆä¸€", "åˆäºŒ", "åˆä¸‰"];

                // 2. å‘é€è¯·æ±‚
                const res = await fetch('/api/ai_rule_gen', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: text,
                        context: {
                            subjects: Array.from(allSubjects),
                            grades: allGrades,
                            teachers: Array.from(allTeachers)  // æ–°å¢è€å¸ˆä¸Šä¸‹æ–‡
                        }
                    })
                });

                const data = await res.json();

                if (data.status === 'success') {
                    const rules = data.rules;  // ç°åœ¨æ˜¯æ•°ç»„

                    // 3. éå†æ·»åŠ æ¯æ¡è§„åˆ™
                    let count = 0;
                    rules.forEach(rule => {
                        addRuleRow(
                            rule.targets || {},
                            rule.type,
                            rule.params || {},
                            rule.weight || 100,
                            text // ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„åŸå§‹è‡ªç„¶è¯­è¨€ä½œä¸ºæè¿°
                        );
                        count++;
                    });

                    // å…³é—­ AI æ¨¡æ€æ¡†
                    bootstrap.Modal.getInstance(document.getElementById('aiRuleModal')).hide();

                    // æç¤ºæˆåŠŸ
                    alert(`æˆåŠŸè¯†åˆ«å¹¶ç”Ÿæˆäº† ${count} æ¡è§„åˆ™ï¼\nè¯·æ£€æŸ¥åˆ—è¡¨å¹¶ç‚¹å‡»"ä¿å­˜å¹¶é‡æ’"ç”Ÿæ•ˆã€‚`);
                    inputEl.value = "";
                } else {
                    alert("ç”Ÿæˆå¤±è´¥: " + data.message);
                }

            } catch (e) {
                console.error(e);
                alert("ç½‘ç»œè¯·æ±‚é”™è¯¯");
            } finally {
                clearInterval(intervalId);  // æ¸…é™¤åŠ¨ç”»å®šæ—¶å™¨
                btn.disabled = false;
                loading.classList.add('hidden');
            }
        }

        // ============ è§„åˆ™è¯¦æƒ…åŠŸèƒ½ ============
        let currentRuleJson = {};  // ç¼“å­˜å½“å‰æŸ¥çœ‹çš„è§„åˆ™ JSON

        function showRuleDetail(ruleCard) {
            // æå–åŸºç¡€æ•°æ®
            const name = ruleCard.querySelector('.rule-name').value;
            const type = ruleCard.querySelector('.rule-type').value;
            const weight = ruleCard.querySelector('.rule-weight').value;
            const targetsStr = ruleCard.querySelector('.rule-targets').value;

            // æå–é€‰ä¸­çš„å¹´çº§
            const selectedGrades = [];
            ruleCard.querySelectorAll('.grade-checkbox:checked').forEach(cb => {
                selectedGrades.push(cb.value);
            });

            // è§£æ targets å­—ç¬¦ä¸²
            const targets = parseTargetsStr(targetsStr);
            if (selectedGrades.length > 0) {
                targets.grades = selectedGrades;
            }

            // æå–å‚æ•°ï¼ˆæ ¹æ®è§„åˆ™ç±»å‹ï¼‰
            const params = extractRuleParams(ruleCard, type);

            // æ„é€ å®Œæ•´ JSON
            currentRuleJson = {
                name: name,
                type: type,
                targets: targets,
                params: params,
                weight: parseInt(weight)
            };

            // è§„åˆ™ç±»å‹æ˜ å°„
            const typeNames = {
                'FORBIDDEN_SLOTS': 'ğŸš« æ—¶æ®µç¦æ’',
                'FIXED_SLOTS': 'ğŸ“Œ å›ºå®šæ—¶æ®µ',
                'ZONE_COUNT': 'ğŸ”¢ åŒºåŸŸè¯¾æ—¶é™åˆ¶',
                'CONSECUTIVE': 'â›“ï¸ è¿å ‚é™åˆ¶',
                'GLOBAL_CAPACITY': 'ğŸŸï¸ å…¨æ ¡å®¹é‡é™åˆ¶',
                'SPECIAL_DAYS': 'ğŸ“… æ•´æ—¥ç¦æ’'
            };

            // å¡«å……è¯¦æƒ…
            document.getElementById('detail-name').textContent = name || '(æ— æè¿°)';
            document.getElementById('detail-type').textContent = typeNames[type] || type;
            document.getElementById('detail-weight').textContent = weight + (parseInt(weight) >= 100 ? ' (ç¡¬çº¦æŸ)' : ' (è½¯çº¦æŸ)');
            document.getElementById('detail-grades').textContent = selectedGrades.length > 0 ? selectedGrades.join(', ') : 'å…¨æ ¡';
            document.getElementById('detail-targets').textContent = targetsStr || 'æ— é¢å¤–ç­›é€‰';
            document.getElementById('detail-json').textContent = JSON.stringify(currentRuleJson, null, 2);

            // æ—¶æ®µå¯è§†åŒ–
            renderSlotsGrid(params.slots || []);

            // æ˜¾ç¤ºå¼¹çª—
            new bootstrap.Modal(document.getElementById('ruleDetailModal')).show();
        }

        function parseTargetsStr(str) {
            const targets = {};
            if (!str) return targets;

            str.split(';').forEach(part => {
                const [key, val] = part.split(':').map(s => s.trim());
                if (key && val) {
                    if (key === 'ç§‘ç›®' || key === 'subjects') {
                        targets.subjects = val.split(',').map(s => s.trim());
                    } else if (key === 'æ ‡ç­¾' || key === 'tags') {
                        targets.tags = val.split(',').map(s => s.trim());
                    } else if (key === 'å§“å' || key === 'names') {
                        targets.names = val.split(',').map(s => s.trim());
                    }
                }
            });
            return targets;
        }

        function extractRuleParams(ruleCard, type) {
            const paramsContainer = ruleCard.querySelector('.rule-params-container');
            const params = {};

            if (type === 'FORBIDDEN_SLOTS' || type === 'ZONE_COUNT' || type === 'SPECIAL_DAYS') {
                // æå– slots
                const slotsInput = paramsContainer.querySelector('.rule-slots');
                if (slotsInput) {
                    try {
                        params.slots = JSON.parse(slotsInput.value || '[]');
                    } catch { params.slots = []; }
                }

                // ZONE_COUNT é¢å¤–å‚æ•°
                if (type === 'ZONE_COUNT') {
                    const countInput = paramsContainer.querySelector('.rule-count');
                    if (countInput) params.count = parseInt(countInput.value) || 0;
                    params.relation = '==';
                }
            } else if (type === 'GLOBAL_CAPACITY') {
                const capInput = paramsContainer.querySelector('.rule-capacity');
                if (capInput) params.capacity = parseInt(capInput.value) || 8;
            } else if (type === 'CONSECUTIVE') {
                const maxInput = paramsContainer.querySelector('.rule-max');
                if (maxInput) params.max = parseInt(maxInput.value) || 2;
                params.mode = 'avoid';
            }

            return params;
        }

        function renderSlotsGrid(slots) {
            const grid = document.getElementById('detail-slots-grid');
            const section = document.getElementById('detail-slots-section');

            if (!slots || slots.length === 0) {
                section.style.display = 'none';
                return;
            }
            section.style.display = 'block';

            const days = ['', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”'];
            const slotsSet = new Set(slots.map(s => `${s[0]}-${s[1]}`));

            let html = days.map(d => `<div class="font-bold text-slate-400 text-center">${d}</div>`).join('');

            for (let p = 0; p < 8; p++) {
                html += `<div class="font-bold text-slate-400 text-center">${p + 1}èŠ‚</div>`;
                for (let d = 0; d < 5; d++) {
                    const isSelected = slotsSet.has(`${d}-${p}`);
                    html += `<div class="w-6 h-6 rounded ${isSelected ? 'bg-red-400' : 'bg-slate-100'} flex items-center justify-center mx-auto">
                        ${isSelected ? '<i class="bi bi-x text-white text-xs"></i>' : ''}
                    </div>`;
                }
            }

            grid.innerHTML = html;
        }

        function copyRuleJson() {
            navigator.clipboard.writeText(JSON.stringify(currentRuleJson, null, 2)).then(() => {
                alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            });
        }

        // ============ è§„åˆ™æ¨¡æ¿å¯¼å…¥åŠŸèƒ½ ============
        async function loadRuleTemplate(type) {
            const container = document.getElementById('rules-container');

            if (type === 'empty') {
                if (confirm("ç¡®å®šæ¸…ç©ºæ‰€æœ‰å½“å‰è§„åˆ™å—ï¼Ÿ")) {
                    container.innerHTML = '';
                    alert("è§„åˆ™å·²æ¸…ç©ºï¼");
                }
                return;
            }

            if (confirm("å¯¼å…¥æ¨¡æ¿å°†è¦†ç›–å½“å‰æ‰€æœ‰è§„åˆ™ï¼Œç¡®å®šå—ï¼Ÿ")) {
                try {
                    // ä» static ç›®å½•åŠ è½½ JSON æ–‡ä»¶
                    const res = await fetch(`/static/rules/${type}_rules.json`);
                    if (!res.ok) throw new Error("æ–‡ä»¶åŠ è½½å¤±è´¥");
                    const rules = await res.json();

                    // æ¸…ç©ºæ—§è§„åˆ™
                    container.innerHTML = '';

                    // éå†æ·»åŠ æ¯æ¡è§„åˆ™
                    rules.forEach(r => {
                        addRuleRow(r.targets, r.type, r.params, r.weight, r.name || '');
                    });

                    alert(`æˆåŠŸå¯¼å…¥ ${rules.length} æ¡è§„åˆ™ï¼\nè¯·è®°å¾—ç‚¹å‡»"ä¿å­˜å¹¶é‡æ’"ç”Ÿæ•ˆã€‚`);
                } catch (e) {
                    console.error(e);
                    alert("åŠ è½½æ¨¡æ¿å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„: " + e.message);
                }
            }
        }

        // ============ æ–°å¢è§„åˆ™å¼¹çª—é€»è¾‘ ============
        let newRuleSelectedSlots = []; // å­˜å‚¨æ–°å¢è§„åˆ™å¼¹çª—ä¸­é€‰æ‹©çš„æ—¶æ®µ

        function openNewRuleSlotPicker() {
            // ä½¿ç”¨å¼¹çª—ä¸­å·²é€‰çš„æ—¶æ®µåˆå§‹åŒ–
            currentEditingRuleSlots = [...newRuleSelectedSlots];
            targetRuleInput = document.getElementById('newRuleSlots');
            renderRuleSlotGrid();
            new bootstrap.Modal(document.getElementById('ruleSlotModal')).show();
        }

        function openAddRuleModal() {
            // å¡«å……å¹´çº§é€‰é¡¹
            const gradesContainer = document.getElementById('newRuleGrades');
            const availableGrades = Object.keys(gradesData).length > 0 ? Object.keys(gradesData) : ["åˆä¸€", "åˆäºŒ", "åˆä¸‰"];

            gradesContainer.innerHTML = availableGrades.map(g => `
                <label class="relative">
                    <input type="checkbox" class="grade-checkbox-hidden new-rule-grade" value="${g}">
                    <span class="clay-pill">${g}</span>
                </label>
            `).join('');

            // é‡ç½®è¡¨å•
            document.getElementById('newRuleName').value = '';
            document.getElementById('newRuleType').value = 'FORBIDDEN_SLOTS';
            document.getElementById('newRuleWeight').value = 100;
            document.getElementById('newRuleTargets').value = '';
            document.getElementById('newRuleSlots').value = '';
            newRuleSelectedSlots = [];

            // æ˜¾ç¤ºå¼¹çª—
            new bootstrap.Modal(document.getElementById('addRuleModal')).show();
        }

        function confirmAddRule() {
            // æ”¶é›†è¡¨å•æ•°æ®
            const name = document.getElementById('newRuleName').value.trim();
            const type = document.getElementById('newRuleType').value;
            const weight = parseInt(document.getElementById('newRuleWeight').value) || 100;
            const targetsStr = document.getElementById('newRuleTargets').value.trim();

            // æ”¶é›†é€‰ä¸­çš„å¹´çº§
            const selectedGrades = [];
            document.querySelectorAll('.new-rule-grade:checked').forEach(cb => {
                selectedGrades.push(cb.value);
            });

            // è§£æ targets
            const targets = {};
            if (selectedGrades.length > 0) {
                targets.grades = selectedGrades;
            }
            if (targetsStr) {
                targetsStr.split(';').forEach(part => {
                    const [key, val] = part.split(':').map(s => s.trim());
                    if (key && val) {
                        if (key === 'ç§‘ç›®' || key === 'subjects') {
                            targets.subjects = val.split(',').map(s => s.trim());
                        } else if (key === 'æ ‡ç­¾' || key === 'tags') {
                            targets.tags = val.split(',').map(s => s.trim());
                        } else if (key === 'å§“å' || key === 'names') {
                            targets.names = val.split(',').map(s => s.trim());
                        }
                    }
                });
            }

            // æ”¶é›†æ—¶æ®µå‚æ•°
            const params = {};
            try {
                const slotsStr = document.getElementById('newRuleSlots').value;
                if (slotsStr) {
                    params.slots = JSON.parse(slotsStr);
                }
            } catch (e) { /* å¿½ç•¥è§£æé”™è¯¯ */ }

            // è°ƒç”¨ addRuleRow æ·»åŠ è§„åˆ™
            addRuleRow(targets, type, params, weight, name);

            // å…³é—­å¼¹çª—
            bootstrap.Modal.getInstance(document.getElementById('addRuleModal')).hide();
        }

        // [ç²˜åœŸé£ç‰ˆ] è§„åˆ™å¡ç‰‡ç”Ÿæˆå‡½æ•°
        function addRuleRow(targets = {}, type = "FORBIDDEN_SLOTS", params = {}, weight = 100, name = "") {
            // 1. é¢„å¤„ç†æ•°æ®
            let targetsStr = "";
            if (targets.tags) targetsStr += `æ ‡ç­¾:${Array.isArray(targets.tags) ? targets.tags.join(',') : targets.tags}; `;
            if (targets.subjects) targetsStr += `ç§‘ç›®:${Array.isArray(targets.subjects) ? targets.subjects.join(',') : targets.subjects}; `;
            if (targets.names) targetsStr += `å§“å:${Array.isArray(targets.names) ? targets.names.join(',') : targets.names}; `;

            // è·å–å¹´çº§æ•°æ®
            const availableGrades = Object.keys(gradesData).length > 0 ? Object.keys(gradesData) : ["åˆä¸€", "åˆäºŒ", "åˆä¸‰"];

            // ç”Ÿæˆå”¯ä¸€ID
            const ruleId = 'rule-' + Date.now() + Math.random().toString(36).substr(2, 9);

            // 3. æ„å»ºç²˜åœŸé£ UI ç»“æ„ - å±…ä¸­å¯¹é½ç‰ˆ
            const html = `
            <div class="clay-rule-card rule-card" id="${ruleId}">
                
                <!-- é¡¶éƒ¨ï¼šè§„åˆ™åç§° + åˆ é™¤æŒ‰é’® -->
                <div class="flex justify-center items-center gap-4 mb-5">
                    <input type="text" 
                           class="clay-input flex-1 text-sm font-bold text-slate-700 text-center rule-name" 
                           value="${name}" 
                           placeholder="è¾“å…¥è§„åˆ™åç§°...">
                    <button class="clay-btn w-10 h-10 flex items-center justify-center text-slate-400 hover:text-red-500 !rounded-xl shrink-0" 
                            onclick="this.closest('.rule-card').remove()" title="åˆ é™¤è§„åˆ™">
                        <i class="bi bi-trash3"></i>
                    </button>
                </div>

                <!-- ä¸»ä½“ï¼šå±…ä¸­å•åˆ—å¸ƒå±€ -->
                <div class="flex flex-col items-center space-y-5">
                    
                    <!-- è§„åˆ™ç±»å‹ + æƒé‡ -->
                    <div class="grid grid-cols-2 gap-4 w-full max-w-md">
                        <div class="clay-input-group text-center">
                            <label class="text-center">è§„åˆ™ç±»å‹</label>
                            <select class="rule-type cursor-pointer text-center" onchange="updateRuleParams(this)">
                                <option value="FORBIDDEN_SLOTS" ${type === 'FORBIDDEN_SLOTS' ? 'selected' : ''}>æ—¶æ®µç¦æ’</option>
                                <option value="FIXED_SLOTS" ${type === 'FIXED_SLOTS' ? 'selected' : ''}>å›ºå®šæ—¶æ®µ</option>
                                <option value="ZONE_COUNT" ${type === 'ZONE_COUNT' ? 'selected' : ''}>åŒºåŸŸè¯¾æ—¶</option>
                                <option value="CONSECUTIVE" ${type === 'CONSECUTIVE' ? 'selected' : ''}>è¿å ‚é™åˆ¶</option>
                                <option value="GLOBAL_CAPACITY" ${type === 'GLOBAL_CAPACITY' ? 'selected' : ''}>å…¨æ ¡å®¹é‡</option>
                                <option value="SPECIAL_DAYS" ${type === 'SPECIAL_DAYS' ? 'selected' : ''}>æ•´æ—¥ç¦æ’</option>
                            </select>
                        </div>
                        
                        <div class="clay-input-group text-center">
                            <label class="text-center">æƒé‡ (0-100)</label>
                            <input type="number" class="rule-weight text-blue-500 font-bold text-center" value="${weight}">
                        </div>
                    </div>

                    <!-- é€‚ç”¨å¹´çº§ -->
                    <div class="text-center">
                        <div class="text-xs text-slate-500 font-bold mb-3">é€‚ç”¨å¹´çº§</div>
                        <div class="flex flex-wrap gap-3 justify-center">
                            ${availableGrades.map(g => {
                const isChecked = targets.grades && targets.grades.includes(g) ? 'checked' : '';
                return `<label class="relative">
                                    <input type="checkbox" class="grade-checkbox-hidden rule-grade-checkbox" value="${g}" ${isChecked}>
                                    <span class="clay-pill">${g}</span>
                                </label>`;
            }).join('')}
                        </div>
                    </div>

                    <!-- ç­›é€‰æ¡ä»¶ -->
                    <div class="clay-input-group w-full max-w-md text-center">
                        <label class="text-center">ç­›é€‰æ¡ä»¶</label>
                        <input class="rule-targets text-center" value="${targetsStr}" placeholder="ç§‘ç›®:è¯­æ–‡; å§“å:å¼ ä¸‰">
                    </div>

                    <!-- å‚æ•°åŒºåŸŸï¼ˆé€‰æ—¶æ®µæŒ‰é’®åœ¨æ­¤æ¸²æŸ“ï¼‰ -->
                    <div class="rule-params-container w-full max-w-md"></div>
                </div>
            </div>`;

            document.getElementById('rules-container').insertAdjacentHTML('beforeend', html);

            // è§¦å‘å‚æ•°æ¸²æŸ“
            const selectEl = document.getElementById(ruleId).querySelector('.rule-type');
            updateRuleParams(selectEl);

            // å›å¡«å¤æ‚å‚æ•°é€»è¾‘
            if (Object.keys(params).length > 0) {
                const card = document.getElementById(ruleId);
                try {
                    if (type === 'FORBIDDEN_SLOTS' || type === 'FIXED_SLOTS' || type === 'ZONE_COUNT') {
                        const el = card.querySelector('.rule-param-slots');
                        if (el) el.value = JSON.stringify(params.slots || []);
                        if (type === 'ZONE_COUNT') {
                            const countEl = card.querySelector('.rule-param-count');
                            if (countEl) countEl.value = params.count || 0;
                        }
                    } else if (type === 'CONSECUTIVE') {
                        const el = card.querySelector('.rule-param-max');
                        if (el) el.value = params.max || 1;
                    } else if (type === 'GLOBAL_CAPACITY') {
                        const el = card.querySelector('.rule-param-capacity');
                        if (el) el.value = params.capacity || 1;
                    } else if (type === 'SPECIAL_DAYS') {
                        const el = card.querySelector('.rule-param-days');
                        if (el) el.value = JSON.stringify(params.days || []);
                    }
                } catch (e) { console.error("Params fill error", e); }
            }
        }


        function updateTotalHours() {
            let t = 0;
            // éå†æ‰€æœ‰ç§‘ç›®æ•°é‡è¾“å…¥æ¡†
            document.querySelectorAll('.course-count').forEach(i => t += parseInt(i.value) || 0);

            // æ›´æ–°ç•Œé¢æ˜¾ç¤º
            const displayEl = document.getElementById('current-hours');
            const containerEl = document.getElementById('total-hours-display');

            if (displayEl) {
                displayEl.innerText = t;
                // ç®€å•çš„è¶…é™é¢„è­¦é€»è¾‘ (å‡è®¾ä¸€å‘¨5å¤©*8èŠ‚ = 40èŠ‚)
                if (t > 40) {
                    displayEl.className = "text-red-500 text-lg font-black"; // è¶…é™å˜çº¢å˜å¤§
                    containerEl.classList.add("!border-red-200", "!bg-red-50");
                } else {
                    displayEl.className = "text-blue-500 text-sm";
                    containerEl.classList.remove("!border-red-200", "!bg-red-50");
                }
            }
        }
        function renderSettings() {
            // å¦‚æœ config ä¸­åŒ…å« grades å­—æ®µï¼Œåˆ™æ¢å¤ gradesData
            if (config.grades) {
                gradesData = {};
                for (let gName in config.grades) {
                    const g = config.grades[gName];
                    const cList = [];
                    // è½¬æ¢å­—å…¸æ ¼å¼å› UI æ•°ç»„æ ¼å¼
                    for (let cName in g.courses) {
                        const info = g.courses[cName];
                        // å°è¯•ä»å…¨å±€ teacher_names æ‰¾å›è€å¸ˆ
                        const teachers = (config.teacher_names && config.teacher_names[cName]) ? config.teacher_names[cName].join(', ') : '';
                        cList.push({
                            name: cName,
                            count: info.count,
                            type: info.type,
                            tags: info.tags || '',
                            teachers: teachers,
                            am_count: info.am_count,
                            pm_count: info.pm_count
                        });
                    }
                    gradesData[gName] = {
                        count: g.count,
                        start: g.start_class_id,
                        courses: cList
                    };
                }
            } else if (config.courses) {
                // å¦‚æœæ˜¯æ—§ç‰ˆæ‰å¹³é…ç½®ï¼Œé»˜è®¤å½’å…¥â€œåˆä¸€â€
                const cList = config.courses.map(c => ({
                    name: c.name, count: c.count, type: c.type, teachers: c.teachers
                }));
                gradesData["åˆä¸€"] = { count: config.num_classes || 6, start: 1, courses: cList };
            }

            // æ›´æ–°ï¼šèµ„æºè®¾ç½®
            document.getElementById('resource-settings-body').innerHTML = '';
            (config.resources || []).forEach(r => addResourceRow(r.name, r.capacity, r.subjects));

            // æ›´æ–°ï¼šæ•™å¸ˆé™åˆ¶
            document.getElementById('teacher-limits-body').innerHTML = '';
            const limits = config.teacher_limits || {};
            Object.keys(limits).forEach(name => {
                addTeacherLimitRow(name, limits[name].min, limits[name].max, limits[name].tags || '');
            });

            // åˆå§‹æ¸²æŸ“å½“å‰å¹´çº§
            initGradeTabs();
            // æ³¨æ„ï¼šä¸åœ¨è¿™é‡Œè°ƒç”¨ switchGradeï¼Œå› ä¸ºå®ƒä¼šå°è¯•ä¿å­˜ã€‚
            // è¿™é‡Œæˆ‘ä»¬ç›´æ¥æ‰‹åŠ¨å¡«å…¥ UI æˆ–è€…è°ƒç”¨ä¸€ä¸ªä¸ä¿å­˜çš„ switchã€‚
            const data = gradesData[currentActiveGrade] || Object.values(gradesData)[0];
            if (data) {
                document.getElementById('grade-count-input').value = data.count;
                document.getElementById('grade-start-input').value = data.start;
                const tbody = document.getElementById('course-settings-body');
                tbody.innerHTML = '';
                data.courses.forEach(c => addCourseRow(c.name, c.count, c.type, c.teachers, c.am_count, c.pm_count, c.tags));
                updateTotalHours();
            }

            // æ›´æ–°ï¼šè§„åˆ™ä¸­å¿ƒ
            document.getElementById('rules-container').innerHTML = '';
            (config.rules || []).forEach(r => {
                addRuleRow(r.targets, r.type, r.params, r.weight, r.name || '');
            });
        }
        // ========================================================
        // [æ ¸å¿ƒå‡½æ•°] syncUItoConfig - å…¨åŸŸé…ç½®åŒæ­¥
        // è´Ÿè´£å°†ç•Œé¢ä¸Šæ‰€æœ‰è¾“å…¥æ¡†ï¼ˆæ— è®ºåœ¨å“ªä¸ªå¼¹çª—ï¼‰åŒæ­¥åˆ°å…¨å±€ config å¯¹è±¡
        // ========================================================
        function syncUItoConfig() {
            // 1. åŒæ­¥å½“å‰æ­£åœ¨ç¼–è¾‘çš„å¹´çº§æ•°æ®
            saveCurrentGradeToMemory();

            // 2. æ„é€ å¹´çº§é…ç½®
            const finalGradesConfig = {};
            const globalTeacherNames = {};
            let totalClassesCount = 0;

            Object.keys(gradesData).forEach(gradeName => {
                const gData = gradesData[gradeName];
                totalClassesCount += (parseInt(gData.count) || 0);
                const coursesDict = {};

                gData.courses.forEach(c => {
                    coursesDict[c.name] = {
                        count: c.count,
                        type: c.type,
                        tags: c.tags,
                        am_count: c.am_count,
                        pm_count: c.pm_count
                    };
                    if (c.teachers) {
                        const tList = c.teachers.split(/[,ï¼Œ\s]+/).filter(x => x);
                        if (!globalTeacherNames[c.name]) globalTeacherNames[c.name] = new Set();
                        tList.forEach(t => globalTeacherNames[c.name].add(t));
                    }
                });

                finalGradesConfig[gradeName] = {
                    start_class_id: gData.start,
                    count: gData.count,
                    courses: coursesDict
                };
            });

            // è½¬æ¢è€å¸ˆåå• Set -> Array (å…¨æ ¡æ±‡æ€»ç‰ˆï¼Œä¿ç•™å…¼å®¹æ€§)
            const finalTeacherNames = {};
            for (let k in globalTeacherNames) {
                finalTeacherNames[k] = Array.from(globalTeacherNames[k]);
            }

            // æ–°å¢ï¼šæŒ‰å¹´çº§éš”ç¦»çš„è€å¸ˆåå•
            const gradeTeacherNames = {};
            Object.keys(gradesData).forEach(gradeName => {
                gradeTeacherNames[gradeName] = {};
                gradesData[gradeName].courses.forEach(c => {
                    if (c.teachers) {
                        gradeTeacherNames[gradeName][c.name] = c.teachers.split(/[,ï¼Œ\s]+/).filter(x => x);
                    }
                });
            });

            // 3. æ”¶é›†èµ„æºè®¾ç½®
            let nr = [];
            document.querySelectorAll('#resource-settings-body tr').forEach(r => {
                const n = r.querySelector('.course-name').value;
                const cap = parseInt(r.querySelector('.course-capacity').value);
                const subj = r.querySelector('.course-subjects').value;
                if (n) nr.push({ name: n, capacity: cap || 1, subjects: subj });
            });

            // 4. æ”¶é›†æ•™å¸ˆé™åˆ¶ (å·²ç§»è‡³é«˜çº§çº¦æŸ Tab)
            let limitConfig = {};
            document.querySelectorAll('#teacher-limits-body tr').forEach(r => {
                const name = r.querySelector('.limit-name').value.trim();
                const min = r.querySelector('.limit-min').value;
                const max = r.querySelector('.limit-max').value;
                const tags = r.querySelector('.limit-tags').value;
                if (name) {
                    limitConfig[name] = {};
                    if (min !== "") limitConfig[name].min = parseInt(min);
                    if (max !== "") limitConfig[name].max = parseInt(max);
                    if (tags !== "") limitConfig[name].tags = tags;
                }
            });

            // 5. æ”¶é›†è§„åˆ™ä¸­å¿ƒ (å¡ç‰‡å¼ UI - æ”¯æŒå¹´çº§å‹¾é€‰)
            let rules = [];
            document.querySelectorAll('.rule-card').forEach(card => {
                // ... (ä¹‹å‰å·²æœ‰çš„æå–é€»è¾‘)
                const type = card.querySelector('.rule-type').value;
                const targetsStr = card.querySelector('.rule-targets').value;
                const name = card.querySelector('.rule-name').value;
                const weight = parseInt(card.querySelector('.rule-weight').value) || 100;
                let targets = {};
                let selectedGrades = [];
                card.querySelectorAll('.rule-grade-checkbox:checked').forEach(chk => {
                    selectedGrades.push(chk.value);
                });
                if (selectedGrades.length > 0) targets.grades = selectedGrades;

                if (targetsStr) {
                    targetsStr.split(/[;ï¼›]/).forEach(p => {
                        const kv = p.split(/[:ï¼š]/);
                        if (kv.length === 2) {
                            const key = kv[0].trim();
                            const cleanVals = kv[1].trim().split(/[,ï¼Œ]/).map(s => s.trim()).filter(s => s);
                            if (key.includes("æ ‡ç­¾")) targets.tags = cleanVals;
                            if (key.includes("ç§‘ç›®")) targets.subjects = cleanVals;
                            if (key.includes("å§“å")) targets.names = cleanVals;
                        }
                    });
                }

                let params = {};
                try {
                    const getVal = (cls) => { const el = card.querySelector(cls); return el ? el.value : null; };
                    const slotsInput = getVal('.rule-param-slots');
                    const daysInput = getVal('.rule-param-days');

                    if (type === 'FORBIDDEN_SLOTS' || type === 'ZONE_COUNT' || type === 'FIXED_SLOTS') {
                        params.slots = JSON.parse(slotsInput || '[]');
                        if (type === 'ZONE_COUNT') params.count = parseInt(getVal('.rule-param-count')) || 0;
                    } else if (type === 'CONSECUTIVE') {
                        params.max = parseInt(getVal('.rule-param-max')) || 1;
                        params.mode = 'avoid';
                    } else if (type === 'GLOBAL_CAPACITY') {
                        params.capacity = parseInt(getVal('.rule-param-capacity')) || 1;
                    } else if (type === 'SPECIAL_DAYS') {
                        params.days = JSON.parse(daysInput || '[]');
                    }
                } catch (e) { console.error("Rule parsing error", e); }
                rules.push({ name, targets, type, params, weight });
            });

            // [æ–°å¢/å®¹é”™] å¦‚æœè§„åˆ™ä¸­å¿ƒä¸ºç©ºï¼ˆä¾‹å¦‚é¡µé¢åˆ·æ–°åï¼‰ï¼Œä¸”å­˜åœ¨ç‰¹æ®Šç§‘ç›®ï¼Œåˆ™æ³¨å…¥é»˜è®¤æ ¸å¿ƒè§„åˆ™
            if (rules.length === 0) {
                console.log("No rules detected, injecting default core rules...");
                rules.push({
                    name: "è‡ªåŠ¨æ³¨å…¥-æ”¿æ•™æ´»åŠ¨",
                    type: "FIXED_SLOTS",
                    targets: { subjects: ["æ”¿æ•™æ´»åŠ¨"] },
                    params: { slots: [[4, 7]] },
                    weight: 100
                });
                rules.push({
                    name: "è‡ªåŠ¨æ³¨å…¥-æ‹“å±•è¯¾",
                    type: "FIXED_SLOTS",
                    targets: { subjects: ["æ‹“å±•è¯¾"] },
                    params: { slots: [[4, 6]] },
                    weight: 100
                });
            }

            // 6. æ”¶é›†å¼€å…³
            const avoidConsecutive = document.getElementById('check-avoid-consecutive')?.checked || false;

            // === æ›´æ–°å…¨å±€ config ===
            config.grades = finalGradesConfig;
            config.teacher_names = finalTeacherNames;
            config.grade_teacher_names = gradeTeacherNames;
            config.num_classes = totalClassesCount;
            config.resources = nr;
            config.teacher_limits = limitConfig;
            config.rules = rules;
            config.use_legacy_rules = false;
            config.optimization = {
                golden_time: true,
                avoid_consecutive_subjects: avoidConsecutive
            };
            config.constraints = globalConstraints;

            console.log("Config Synced!", config);
            return config;
        }

        // ========================================================
        // saveSettingsAndInit - é‡æ„åæ›´æ¸…çˆ½
        // ========================================================
        function saveSettingsAndInit() {
            // 1. åŒæ­¥æ•°æ®
            try {
                syncUItoConfig();
            } catch (e) {
                alert("é…ç½®æ•°æ®è¯»å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥è§„åˆ™æ ¼å¼");
                return;
            }

            // 2. UI çŠ¶æ€åé¦ˆ
            const btn = document.getElementById('btn-init');
            const spinner = document.getElementById('init-spinner');
            if (btn) btn.disabled = true;
            if (spinner) spinner.classList.remove('d-none');

            // 3. å‘é€è¯·æ±‚ (ç›´æ¥ä½¿ç”¨å…¨å±€ config)
            fetch('/api/init', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        currentScheduleId = data.schedule_id;
                        updateUI(data);
                        // æˆåŠŸåå…³é—­å¯èƒ½æ‰“å¼€çš„ Modal
                        bootstrap.Modal.getOrCreateInstance(document.getElementById('settingsModal')).hide();
                        bootstrap.Modal.getOrCreateInstance(document.getElementById('constraintModal')).hide();
                    } else {
                        // === [ä¿®æ”¹å¼€å§‹] å¤±è´¥æ—¶ä¹Ÿè¦å¤„ç†æŠ¥å‘Š ===

                        // 1. å¦‚æœåç«¯è¿”å›äº†æŠ¥å‘Šï¼Œç«‹å³æ›´æ–°æŠ¥å‘ŠæŒ‰é’®çŠ¶æ€
                        if (data.rule_report) {
                            // æ‰‹åŠ¨æ›´æ–°å…¨å±€æŠ¥å‘Šæ•°æ®
                            globalRuleReport = data.rule_report;

                            const btn = document.getElementById('btn-rule-report');
                            btn.disabled = false; // æ¿€æ´»æŒ‰é’®

                            // å¼ºåˆ¶æ˜¾ç¤ºä¸ºçº¢è‰²è­¦å‘ŠçŠ¶æ€
                            btn.classList.add('animate-pulse', 'text-red-500');
                            btn.innerHTML = `<i class="bi bi-exclamation-octagon-fill text-xl"></i> æŸ¥çœ‹å¤±è´¥åŸå› `;
                        }

                        // 2. æ˜¾ç¤ºåŸæœ‰çš„é”™è¯¯å»ºè®®å¼¹çª— (ä¿æŒä¸å˜)
                        if (data.suggestions && data.suggestions.length > 0) {
                            const ul = document.getElementById('failure-suggestions');
                            ul.innerHTML = data.suggestions.map(s => `<li class="flex items-start gap-2"><i class="bi bi-lightbulb-fill text-yellow-400 shrink-0 mt-0.5"></i><span>${s}</span></li>`).join('');
                            new bootstrap.Modal(document.getElementById('failureModal')).show();
                        } else {
                            alert(data.message);
                        }
                        // === [ä¿®æ”¹ç»“æŸ] ===
                    }
                })
                .catch(e => {
                    console.error(e);
                    alert("æ’è¯¾è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°ã€‚");
                })
                .finally(() => {
                    if (btn) btn.disabled = false;
                    if (spinner) spinner.classList.add('d-none');
                });
        }
        async function handleConfigUpload(input) {
            if (!input.files || !input.files[0]) return;
            const formData = new FormData(); formData.append('file', input.files[0]);
            try {
                const res = await fetch('/api/import_config', { method: 'POST', body: formData });
                const data = await res.json();
                if (data.status === 'success') {
                    let newCourses = [];
                    for (let [name, info] of Object.entries(data.courses)) { newCourses.push({ name: name, count: info.count, type: info.type, teachers: info.teachers.join(', ') }); }
                    config.courses = newCourses; config.resources = data.resources; renderSettings(); alert(data.message);
                } else { alert(data.message); }
            } catch (e) { alert("ä¸Šä¼ å¤±è´¥"); }
            input.value = '';
        }

        async function performUndo() {
            if (historyStack.length) {
                redoStack.push(JSON.parse(JSON.stringify(globalSchedule)));
                const prevSchedule = historyStack.pop();
                try {
                    const res = await fetch('/api/restore', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ schedule_id: currentScheduleId, schedule: prevSchedule }) });
                    const data = await res.json();
                    if (data.status === 'success') {
                        globalSchedule = prevSchedule; updateUndoButtons();
                        if (currentView === 'class') renderCurrentClass(); else renderCurrentTeacher();
                    }
                    else { alert("æ’¤é”€å¤±è´¥: " + data.message); historyStack.push(prevSchedule); redoStack.pop(); }
                } catch (e) { console.error(e); alert("åŒæ­¥æœåŠ¡å™¨å¤±è´¥"); }
            }
        }
        async function performRedo() {
            if (redoStack.length) {
                historyStack.push(JSON.parse(JSON.stringify(globalSchedule)));
                const nextSchedule = redoStack.pop();
                try {
                    await fetch('/api/restore', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ schedule_id: currentScheduleId, schedule: nextSchedule }) });
                    globalSchedule = nextSchedule; updateUndoButtons();
                    if (currentView === 'class') renderCurrentClass(); else renderCurrentTeacher();
                } catch (e) { console.error(e); }
            }
        }
        function pushHistory() { if (Object.keys(globalSchedule).length) { historyStack.push(JSON.parse(JSON.stringify(globalSchedule))); if (historyStack.length > MAX_HISTORY) historyStack.shift(); redoStack = []; updateUndoButtons(); } }
        function updateUndoButtons() { document.getElementById('btn-undo').disabled = !historyStack.length; document.getElementById('btn-redo').disabled = !redoStack.length; }
        function exportCurrentClass() {
            if (currentView === 'class') {
                const c = document.getElementById('class-select').value; if (c) window.location.href = `/api/export/class/${c}?schedule_id=${currentScheduleId}`;
            } else {
                const t = document.getElementById('teacher-view-select').value; if (t) window.location.href = `/api/export/teacher/${encodeURIComponent(t)}?schedule_id=${currentScheduleId}`;
            }
        }
        function exportAllClasses() {
            window.location.href = `/api/export/all_classes?schedule_id=${currentScheduleId}`;
        }

        function openStatistics() {
            new bootstrap.Modal(document.getElementById('statisticsModal')).show(); setTimeout(() => {
                const ctx = document.getElementById('workloadChart').getContext('2d'); if (workloadChart) workloadChart.destroy();
                const lb = Object.keys(currentStats).sort(); workloadChart = new Chart(ctx, { type: 'bar', data: { labels: lb, datasets: [{ label: 'Hours', data: lb.map(n => currentStats[n].total), backgroundColor: '#63b3ed', borderRadius: 20 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { display: false } }, x: { grid: { display: false } } } } });
            }, 300);
        }
        document.getElementById('btn-confirm-delete').onclick = async () => { await fetch('/api/delete', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: targetDeleteName }) }); bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide(); loadSavedList(); }
        function addLeave() {
            const n = document.getElementById('teacher-select').value;
            // è·å–ä¸‹æ‹‰æ¡†çš„æ•°å€¼ (0-4 ä»£è¡¨å‘¨ä¸€åˆ°å‘¨äº”, 0-8 ä»£è¡¨ç¬¬1-9èŠ‚)
            const sd = parseInt(document.getElementById('start-day').value);
            const sp = parseInt(document.getElementById('start-period').value);
            const ed = parseInt(document.getElementById('end-day').value);
            const ep = parseInt(document.getElementById('end-period').value);

            if (n) {
                // æ¨é€æ–°æ ¼å¼çš„æ•°æ®ç»“æ„
                leaveRequests.push({
                    name: n,
                    start: { day: sd, period: sp },
                    end: { day: ed, period: ep }
                });
                renderLeaveList();
            }
        }
        function renderLeaveList() {
            const dayText = ["å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”"];

            document.getElementById('leave-list').innerHTML = leaveRequests.map((r, i) => {
                // æ ¼å¼åŒ–æ˜¾ç¤ºæ–‡æœ¬ï¼Œä¾‹å¦‚ï¼šå‘¨ä¸€ç¬¬1èŠ‚ - å‘¨ä¸€ç¬¬2èŠ‚
                const startText = `${dayText[r.start.day]}ç¬¬${r.start.period + 1}èŠ‚`;
                const endText = `${dayText[r.end.day]}ç¬¬${r.end.period + 1}èŠ‚`;

                return `
                <li class="flex justify-between items-center text-xs bg-white p-2 rounded-xl border border-slate-100 shadow-sm mb-2">
                    <div class="flex flex-col">
                        <span class="font-bold text-slate-600">${r.name}</span>
                        <span class="scale-90 origin-left text-slate-400 font-mono">${startText} -> ${endText}</span>
                    </div>
                    <button onclick="leaveRequests.splice(${i},1);renderLeaveList()" 
                            class="w-7 h-7 rounded-lg bg-red-50 text-red-400 hover:bg-red-500 hover:text-white flex items-center justify-center transition-all">
                        <i class="bi bi-trash3"></i>
                    </button>
                </li>`;
            }).join('');
        }
        function applySubstitutions() {
            const btn = document.getElementById('btn-apply');
            // é˜²æ­¢é‡å¤ç‚¹å‡»
            btn.disabled = true;
            const originalText = btn.innerText;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> è®¡ç®—ä¸­...';

            fetch('/api/substitute', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ schedule_id: currentScheduleId, leaves: leaveRequests })
            })
                .then(r => r.json())
                .then(d => {
                    if (d.status === 'success') {
                        globalSchedule = d.schedule;
                        updateUI(d); // æ›´æ–°ç•Œé¢æ•°æ®

                        // === æ ¸å¿ƒä¿®å¤ï¼šæ„å»ºæˆåŠŸåé¦ˆå¼¹çª— ===
                        const stats = d.stats || { direct: 0, swap: 0, self_study: 0 };

                        // 1. ç”Ÿæˆç»Ÿè®¡ HTML
                        let resultHtml = `
                <div class="flex gap-2 mb-4">
                    <div class="bg-green-100 text-green-700 px-3 py-2 rounded-xl text-xs font-bold flex-1 text-center shadow-sm">
                        <div class="text-[10px] opacity-60 uppercase">ç›´æ¥ä»£è¯¾</div>
                        <div class="text-lg">${stats.direct}</div>
                    </div>
                    <div class="bg-blue-100 text-blue-700 px-3 py-2 rounded-xl text-xs font-bold flex-1 text-center shadow-sm">
                        <div class="text-[10px] opacity-60 uppercase">è¯¾ç¨‹äº’æ¢</div>
                        <div class="text-lg">${stats.swap}</div>
                    </div>
                    <div class="bg-red-100 text-red-700 px-3 py-2 rounded-xl text-xs font-bold flex-1 text-center shadow-sm">
                        <div class="text-[10px] opacity-60 uppercase">è‡ªä¹ </div>
                        <div class="text-lg">${stats.self_study}</div>
                    </div>
                </div>
            `;

                        // 2. ç”Ÿæˆè¯¦ç»†æ—¥å¿—åˆ—è¡¨
                        if (d.logs && d.logs.length > 0) {
                            resultHtml += '<div class="text-xs font-bold text-slate-400 mb-2 pl-1">è°ƒæ•´æ˜ç»†ï¼š</div>';
                            resultHtml += '<ul class="space-y-2 text-xs font-bold text-slate-600 max-h-60 overflow-y-auto pr-1 custom-scrollbar">';
                            d.logs.forEach(log => {
                                const icon = log.type === 'self_study'
                                    ? '<i class="bi bi-x-circle-fill text-red-400 text-lg"></i>'
                                    : '<i class="bi bi-check-circle-fill text-green-500 text-lg"></i>';
                                const bgClass = log.type === 'self_study' ? 'bg-red-50 border-red-100' : 'bg-green-50 border-green-100';

                                resultHtml += `
                        <li class="flex items-center gap-3 ${bgClass} p-3 rounded-xl border">
                            ${icon} 
                            <span>${log.message}</span>
                        </li>`;
                            });
                            resultHtml += '</ul>';
                        } else {
                            resultHtml += '<div class="text-center text-slate-400 text-xs py-8 bg-slate-50 rounded-xl border border-dashed border-slate-200">æ²¡æœ‰å‘ç°éœ€è¦è°ƒæ•´çš„è¯¾ç¨‹</div>';
                        }

                        // 3. æ“ä½œæ¨¡æ€æ¡† DOM
                        const modalEl = document.getElementById('failureModal');

                        // ä¿®æ”¹æ ‡é¢˜åŒºåŸŸæ ·å¼ï¼ˆå˜æˆç»¿è‰²ï¼‰
                        const headerIcon = modalEl.querySelector('.bi-exclamation-triangle-fill');
                        if (headerIcon) {
                            headerIcon.className = "bi bi-check-circle-fill text-2xl text-green-500";
                        }

                        const headerTitle = modalEl.querySelector('h5');
                        if (headerTitle) {
                            headerTitle.innerText = "æ™ºèƒ½ä»£è¯¾æ‰§è¡ŒæˆåŠŸ";
                            headerTitle.parentElement.className = "flex items-center gap-3 mb-4 text-green-500";
                        }

                        const headerSub = modalEl.querySelector('p.text-sm');
                        if (headerSub) headerSub.innerText = "ç³»ç»Ÿå·²è‡ªåŠ¨å®Œæˆä»¥ä¸‹è¯¾ç¨‹è°ƒæ•´ï¼š";

                        // å¡«å……å†…å®¹
                        const contentBox = modalEl.querySelector('.clay-card');
                        contentBox.innerHTML = resultHtml;

                        // æ˜¾ç¤ºæ¨¡æ€æ¡†
                        new bootstrap.Modal(modalEl).show();

                    } else {
                        alert("ä»£è¯¾è®¡ç®—å‡ºé”™: " + d.message);
                    }
                })
                .catch(e => {
                    console.error(e);
                    alert("è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æ§åˆ¶å°æ—¥å¿—");
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                });
        }

        let globalRuleReport = [];

        function showRuleReport() {
            const listEl = document.getElementById('report-list');
            if (!listEl) return;
            listEl.innerHTML = '';

            let sCount = 0, fCount = 0, wCount = 0;

            globalRuleReport.forEach(rule => {
                if (rule.status === 'success') sCount++;
                if (rule.status === 'failed') fCount++;
                if (rule.status === 'warning') wCount++;

                const isFail = rule.status === 'failed';
                const isWarn = rule.status === 'warning';
                const isSuccess = rule.status === 'success';

                let icon = '<i class="bi bi-check-circle-fill text-green-500 text-lg"></i>';
                let bgClass = 'bg-white border-green-50';
                let statusText = 'æ‰§è¡Œå®Œç¾';

                if (isFail) {
                    icon = '<i class="bi bi-x-octagon-fill text-red-500 text-lg"></i>';
                    bgClass = 'bg-red-50 border-red-100';
                    statusText = 'ç¡¬æ€§çº¦æŸå¤±è´¥';
                } else if (isWarn) {
                    icon = '<i class="bi bi-exclamation-triangle-fill text-yellow-500 text-lg"></i>';
                    bgClass = 'bg-yellow-50 border-yellow-100';
                    statusText = `è½¯çº¦æŸåå·® (${rule.violation_count}å¤„)`;
                }

                let detailsHtml = '';
                if ((isFail || isWarn) && rule.violations && rule.violations.length > 0) {
                    detailsHtml = `
                    <div class="mt-2 pt-2 border-t border-slate-200/50">
                        <div class="text-[10px] font-bold text-slate-400 mb-1">è¿è§„è¯¦æƒ… (å‰5æ¡):</div>
                        <ul class="text-xs text-slate-600 space-y-1 font-mono">
                            ${rule.violations.slice(0, 5).map(v => `<li>â€¢ ${v}</li>`).join('')}
                            ${rule.violations.length > 5 ? `<li class="italic text-slate-400">...ä»¥åŠå…¶ä»– ${rule.violations.length - 5} å¤„</li>` : ''}
                        </ul>
                    </div>`;
                }

                const html = `
                <li class="p-4 rounded-2xl border shadow-sm ${bgClass} transition-all">
                    <div class="flex justify-between items-start">
                        <div class="flex items-center gap-3">
                            ${icon}
                            <div>
                                <div class="font-black text-slate-700 text-sm">${rule.name}</div>
                                <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mt-0.5">
                                    ç±»å‹: ${rule.type} | æƒé‡: ${rule.weight}
                                </div>
                            </div>
                        </div>
                        <div class="text-xs font-bold ${isFail ? 'text-red-500' : (isWarn ? 'text-yellow-500' : 'text-green-500')}">
                            ${statusText}
                        </div>
                    </div>
                    ${detailsHtml}
                </li>`;

                listEl.insertAdjacentHTML('beforeend', html);
            });

            document.getElementById('report-success-count').innerText = sCount;
            document.getElementById('report-fail-count').innerText = fCount;
            document.getElementById('report-warn-count').innerText = wCount;

            if (fCount > 0) document.getElementById('report-advice').classList.remove('hidden');
            else document.getElementById('report-advice').classList.add('hidden');

            new bootstrap.Modal(document.getElementById('reportModal')).show();
        }
    </script>
    <div class="modal fade" id="reportModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content !bg-[#eef2f6] border-0 !rounded-[2rem] overflow-hidden">
                <div class="modal-header border-0 px-6 py-5 pb-2">
                    <h5 class="modal-title font-black text-slate-700 text-lg flex items-center gap-2">
                        <i class="bi bi-clipboard-data-fill text-green-500"></i> è§„åˆ™æ‰§è¡Œä½“æ£€æŠ¥å‘Š
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="px-6 pb-2">
                    <div class="flex gap-3 mb-4">
                        <div class="flex-1 clay-card p-3 text-center bg-green-50">
                            <div class="text-xs text-slate-400 font-bold uppercase">æˆåŠŸåº”ç”¨</div>
                            <div id="report-success-count" class="text-2xl font-black text-green-500">0</div>
                        </div>
                        <div class="flex-1 clay-card p-3 text-center bg-red-50">
                            <div class="text-xs text-slate-400 font-bold uppercase">ç¡¬æ€§å†²çª</div>
                            <div id="report-fail-count" class="text-2xl font-black text-red-500">0</div>
                        </div>
                        <div class="flex-1 clay-card p-3 text-center bg-yellow-50">
                            <div class="text-xs text-slate-400 font-bold uppercase">è½¯çº¦æŸåå·®</div>
                            <div id="report-warn-count" class="text-2xl font-black text-yellow-500">0</div>
                        </div>
                    </div>
                </div>

                <div class="modal-body px-6 pb-6 pt-0">
                    <div class="clay-card p-4 !shadow-clay-inner max-h-[400px] overflow-y-auto custom-scrollbar">
                        <ul id="report-list" class="space-y-3">
                        </ul>
                    </div>
                    <div id="report-advice"
                        class="mt-4 text-xs text-slate-500 bg-white p-3 rounded-xl border border-dashed border-slate-300 hidden">
                        <i class="bi bi-info-circle-fill mr-1"></i>
                        <span class="font-bold">æ”¹è¿›å»ºè®®ï¼š</span>
                        è‹¥å‡ºç°ç¡¬æ€§å†²çªï¼Œå¯èƒ½æ˜¯è§„åˆ™ç›®æ ‡è®¾å®šæœ‰è¯¯ï¼ˆå¦‚ç›®æ ‡ç§‘ç›®åä¸åŒ¹é…ï¼‰ï¼Œæˆ–ä¸å…¶ä»–å›ºå®šè§„åˆ™å†²çªã€‚å»ºè®®æ£€æŸ¥â€œè§„åˆ™ä¸­å¿ƒâ€ä¸­çš„è®¾ç½®ã€‚
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>

</html>