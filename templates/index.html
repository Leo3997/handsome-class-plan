<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>得鹿山智能排课系统</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/bootstrap-icons.min.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
    <style>
        /* 开屏动画样式 */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            transition: opacity 0.8s ease-out, visibility 0.8s;
        }

        @keyframes gradientBG {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .splash-content {
            text-align: center;
            animation: fadeInUp 1s ease-out;
        }

        .splash-icon {
            font-size: 5rem;
            margin-bottom: 20px;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            animation: bounce 2s infinite;
        }

        .splash-title {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .splash-subtitle {
            font-size: 1.2rem;
            opacity: 0.8;
            letter-spacing: 2px;
        }

        .loader {
            margin: 30px auto 0;
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            animation: spin 1s linear infinite;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes bounce {

            0%,
            20%,
            50%,
            80%,
            100% {
                transform: translateY(0);
            }

            40% {
                transform: translateY(-20px);
            }

            60% {
                transform: translateY(-10px);
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #splash-screen.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
    </style>
    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/chart.js"></script>
</head>

<body>
    <!-- 开屏动画 -->
    <div id="splash-screen">
        <div class="splash-content">
            <i class="bi bi-calendar-check-fill splash-icon"></i>
            <div class="splash-title">得鹿山智能排课系统</div>
            <div class="splash-subtitle">Smart Scheduling System</div>
            <div class="loader"></div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 sidebar">
                <h4 class="mb-4 text-primary fw-bold">
                    <i class="bi bi-calendar-check-fill me-2"></i>得鹿山智能排课系统
                </h4>

                <div class="d-flex gap-2 mb-4">
                    <button id="btn-init" class="btn btn-primary flex-grow-1 py-2 shadow-sm" onclick="initSystem()">
                        <span id="init-spinner" class="spinner-border spinner-border-sm d-none"></span>
                        <i class="bi bi-rocket-takeoff me-1"></i> 生成/重置
                    </button>
                    <button class="btn btn-light border shadow-sm" onclick="openSettings()" title="高级约束设置"
                        style="width: 42px;">
                        <i class="bi bi-gear-fill"></i>
                    </button>
                    <button class="btn btn-light border shadow-sm" data-bs-toggle="modal"
                        data-bs-target="#settingsModal" title="基本参数设置" style="width: 42px;">
                        <i class="bi bi-file-earmark-text"></i>
                    </button>
                </div>
                <div class="d-flex gap-2 mb-3">
                    <button id="btn-undo" class="btn btn-outline-secondary w-50 shadow-sm" onclick="performUndo()"
                        disabled>
                        <i class="bi bi-arrow-counterclockwise me-1"></i>撤销
                    </button>
                    <button id="btn-redo" class="btn btn-outline-secondary w-50 shadow-sm" onclick="performRedo()"
                        disabled>
                        <i class="bi bi-arrow-clockwise me-1"></i>重做
                    </button>
                </div>
                <button id="btn-stats" class="btn btn-outline-primary w-100 mb-3 shadow-sm" onclick="openStatistics()"
                    disabled>
                    <i class="bi bi-bar-chart-fill me-1"></i> 查看统计看板
                </button>
                <div id="system-status" class="text-center text-muted small mb-3">系统未初始化</div>

                <!-- 错误提示容器 -->
                <div id="error-alert-container"></div>

                <hr>
                <h5 class="mb-3"><i class="bi bi-floppy me-2"></i>课表方案管理</h5>
                <div class="mb-3">
                    <div class="input-group input-group-sm mb-2">
                        <input type="text" id="save-name" class="form-control" placeholder="输入方案名称">
                        <button class="btn btn-outline-success" onclick="saveCurrentSchedule()" id="btn-save"
                            disabled>保存</button>
                    </div>
                    <div class="small text-muted mb-2">已保存的方案：</div>
                    <div id="saved-list" class="list-group list-group-flush small"
                        style="max-height: 150px; overflow-y: auto;">
                        <div class="text-center text-muted py-2">暂无保存方案</div>
                    </div>
                </div>

                <hr>
                <h5 class="mb-3"><i class="bi bi-person-lines-fill me-2"></i>请假管理</h5>
                <div class="mb-3">
                    <label class="form-label small text-muted">选择老师</label>
                    <select id="teacher-select" class="form-select" disabled></select>
                </div>
                <div class="mb-3">
                    <label class="form-label small text-muted">时间范围</label>
                    <div class="d-flex gap-2">
                        <select id="start-day" class="form-select">
                            <option>周一</option>
                            <option>周二</option>
                            <option>周三</option>
                            <option>周四</option>
                            <option>周五</option>
                        </select>
                        <select id="end-day" class="form-select">
                            <option>周一</option>
                            <option>周二</option>
                            <option>周三</option>
                            <option>周四</option>
                            <option>周五</option>
                        </select>
                    </div>
                </div>
                <button id="btn-add-leave" class="btn btn-outline-secondary w-100 mb-2" onclick="addLeave()" disabled>
                    <i class="bi bi-plus-lg me-1"></i>添加请假条
                </button>
                <ul id="leave-list" class="list-group small mb-3"></ul>
                <button id="btn-apply" class="btn btn-success w-100" onclick="applySubstitutions()" disabled>
                    <i class="bi bi-arrow-repeat me-1"></i>执行智能代课
                </button>

                <!-- 代课日志区域 -->
                <div id="substitution-logs-container" style="display: none;">
                    <hr>
                    <h5 class="mb-3"><i class="bi bi-journal-text me-2"></i>代课日志</h5>

                    <div id="sub-stats" class="mb-3 p-2"
                        style="background: #f8f9fa; border-radius: 8px; font-size: 0.85rem; border: 1px solid #e9ecef;">
                        <div><strong>直接代课：</strong><span id="stat-direct">0</span>次</div>
                        <div><strong>课程互换：</strong><span id="stat-swap" class="text-info">0</span>次</div>
                        <div><strong>标记自习：</strong><span id="stat-self">0</span>次</div>
                        <div class="mt-1"><strong>总扰动度：</strong><span id="stat-score">0</span>分</div>
                    </div>

                    <div class="small text-muted mb-1">详细日志：</div>
                    <div id="sub-logs" class="small"
                        style="max-height: 200px; overflow-y: auto; background: #fff; border: 1px solid #e9ecef; border-radius: 8px; padding: 8px;">
                        <div class="text-muted text-center">暂无日志</div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 main-content">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="d-flex align-items-center gap-2">
                        <h3 id="class-title" class="mb-0 fw-bold">班级课表</h3>
                        <div class="btn-group btn-group-sm ms-2">
                            <button class="btn btn-outline-primary active" id="btn-view-class"
                                onclick="switchView('class')">
                                <i class="bi bi-grid-3x3-gap-fill me-1"></i>班级视图
                            </button>
                            <button class="btn btn-outline-info" id="btn-view-teacher" onclick="switchView('teacher')"
                                disabled>
                                <i class="bi bi-person-video3 me-1"></i>老师视图
                            </button>
                        </div>
                    </div>

                    <div class="d-flex align-items-center gap-2">
                        <div id="class-selector-group" class="d-flex align-items-center gap-2">
                            <label class="text-secondary small">查看班级：</label>
                            <select id="class-select" class="form-select w-auto"
                                onchange="renderCurrentClass()"></select>
                        </div>

                        <div id="teacher-selector-group" class="d-flex align-items-center gap-2" style="display: none;">
                            <label class="text-secondary small">查看老师：</label>
                            <select id="teacher-view-select" class="form-select w-auto"
                                onchange="renderCurrentTeacher()"></select>
                        </div>

                        <div class="btn-group ms-2">
                            <button class="btn btn-sm btn-outline-success" onclick="exportCurrentClass()"
                                id="btn-export-current" disabled title="导出当前班级">
                                <i class="bi bi-download me-1"></i>导出本班
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportAllClasses()"
                                id="btn-export-all" disabled title="导出所有班级">
                                <i class="bi bi-box-seam me-1"></i>导出全部
                            </button>
                        </div>
                    </div>
                </div>
                <div class="timetable-card">
                    <table class="table schedule-table mb-0">
                        <thead>
                            <tr>
                                <th style="width:80px">节次</th>
                                <th>周一</th>
                                <th>周二</th>
                                <th>周三</th>
                                <th>周四</th>
                                <th>周五</th>
                            </tr>
                        </thead>
                        <tbody id="schedule-body">
                            <tr>
                                <td colspan="6" class="text-center py-5 text-muted">请先生成课表</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-sliders me-2"></i>全局排课参数设置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3 d-flex justify-content-end align-items-center bg-light p-2 rounded">
                        <input type="file" id="config-file-input" accept=".xlsx, .xls" style="display: none;"
                            onchange="handleConfigUpload(this)">
                        <small class="text-muted me-auto"><i class="bi bi-info-circle me-1"></i>支持导入排课参数 Excel</small>
                        <button class="btn btn-outline-success btn-sm"
                            onclick="document.getElementById('config-file-input').click()">
                            <i class="bi bi-file-earmark-spreadsheet me-1"></i>从 Excel 导入配置
                        </button>
                    </div>

                    <div class="row mb-3">
                        <label class="col-sm-2 col-form-label">班级总数</label>
                        <div class="col-sm-4">
                            <input type="number" id="setting-num-classes" class="form-control" value="6">
                        </div>
                    </div>

                    <div class="card bg-light border-0 mb-3">
                        <div class="card-body py-2">
                            <h6 class="mb-2 text-primary"><i class="bi bi-cpu-fill me-2"></i>算法优化偏好</h6>
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="opt-golden-time" checked>
                                        <label class="form-check-label" for="opt-golden-time">
                                            优先安排黄金时间
                                            <small class="d-block text-muted"
                                                style="font-size: 0.75rem;">语数英尽量不排在下午</small>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text">避免连堂超过</span>
                                        <select class="form-select" id="opt-max-consecutive">
                                            <option value="2">2 节</option>
                                            <option value="3">3 节</option>
                                            <option value="4">4 节</option>
                                        </select>
                                        <span class="input-group-text">节</span>
                                    </div>
                                    <small class="text-muted" style="font-size: 0.75rem;">超过限制将增加惩罚权重</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr>
                    <h6 class="mb-3"><i class="bi bi-building me-2"></i>专用教室资源配置</h6>
                    <div class="alert alert-light border small">
                        <strong><i class="bi bi-info-circle me-1"></i>说明：</strong> <br>
                        限制特定科目的<b>同时上课班级数</b>。例如：只有1间音乐室，则“音乐”课的容量设为1。
                    </div>
                    <table class="table table-sm align-middle">
                        <thead>
                            <tr>
                                <th style="width: 25%">资源名称</th>
                                <th style="width: 15%">容量(间)</th>
                                <th>适用科目 (用逗号分隔)</th>
                                <th style="width: 10%">操作</th>
                            </tr>
                        </thead>
                        <tbody id="resource-settings-body">
                        </tbody>
                    </table>
                    <button class="btn btn-sm btn-outline-primary mb-3" onclick="addResourceRow()">
                        <i class="bi bi-plus-lg me-1"></i>新增资源
                    </button>

                    <hr>
                    <h6 class="mb-3"><i class="bi bi-people me-2"></i>科目与师资设置</h6>
                    <div class="alert alert-light border small">
                        <strong><i class="bi bi-info-circle me-1"></i>说明：</strong> <br>
                        1. 在“指定老师姓名”中输入名字，用<b>空格</b>或<b>逗号</b>分隔。<br>
                        2. 如果指定的名字少于需要的老师数量，系统会自动补全（如 "语文老师3"）。<br>
                        3. 示例：输入 "张伟, 李娜"，系统会优先安排这两位，不够再自动生成。
                    </div>
                    <table class="table table-sm align-middle">
                        <thead>
                            <tr>
                                <th style="width: 15%">科目名称</th>
                                <th style="width: 12%">每周节数</th>
                                <th style="width: 12%">课程类型</th>
                                <th>指定老师姓名 (可选)</th>
                                <th style="width: 10%">操作</th>
                            </tr>
                        </thead>
                        <tbody id="course-settings-body">
                        </tbody>
                    </table>
                    <button class="btn btn-sm btn-outline-primary" onclick="addCourseRow()">
                        <i class="bi bi-plus-lg me-1"></i>新增科目
                    </button>
                    <div class="mt-3 text-end">
                        当前总课时: <span id="total-hours" class="fw-bold text-primary">0</span> / 45
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal"
                        onclick="saveSettingsAndInit()">
                        <i class="bi bi-check-lg me-1"></i>保存并生成课表
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Constraints Modal -->
    <div class="modal fade" id="constraintModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-gear-wide-connected me-2"></i>高级排课设置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">选择老师进行配置</label>
                        <select id="constraint-teacher-select" class="form-select" onchange="renderConstraintGrid()">
                            <option value="">请选择...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label d-flex justify-content-between">
                            <span>禁排时间设置</span>
                            <small class="text-muted"><span class="text-danger">■</span> 点击红色格子表示禁排</small>
                        </label>
                        <div class="table-responsive">
                            <table class="table table-bordered text-center table-sm small" id="constraint-grid">
                                <thead>
                                    <tr>
                                        <th style="width: 40px"></th>
                                        <th>周一</th>
                                        <th>周二</th>
                                        <th>周三</th>
                                        <th>周四</th>
                                        <th>周五</th>
                                    </tr>
                                </thead>
                                <tbody id="constraint-tbody">
                                    <!-- JS渲染 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveSettings()">保存配置</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Modal -->
    <div class="modal fade" id="statisticsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-bar-chart-fill me-2"></i>课表统计分析</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="statsTabs">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab"
                                data-bs-target="#tab-workload">工作量对比</button>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="tab-workload">
                            <div style="height: 400px;">
                                <canvas id="workloadChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>确认删除</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>确定要永久删除方案 <strong id="delete-target-name"></strong> 吗？</p>
                    <p class="text-muted small mb-0">此操作无法撤销。</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" id="btn-confirm-delete">确认删除</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Conflict Tooltip -->
    <div id="conflict-tooltip" class="conflict-tooltip"></div>

    <script>
        let globalSchedule = {};
        let deleteModalVar = null;
        let targetDeleteName = '';
        let globalTeachers = [];
        let teacherScheduleMap = {}; // Global Map for conflict checking

        // Undo/Redo Globals
        let historyStack = [];
        let redoStack = [];
        const MAX_HISTORY = 20;

        let currentView = 'class';
        let leaveRequests = [];
        const DAYS = ["周一", "周二", "周三", "周四", "周五"];
        let globalConstraints = { teacher_unavailable: {} };
        let currentStats = null;
        let statsModalVar = null;
        let workloadChart = null;
        let constraintModalVar = null;

        let config = {
            num_classes: 6,
            courses: [
                { name: "语文", count: 7, type: "main", teachers: "张伟, 李娜" },
                { name: "数学", count: 7, type: "main", teachers: "王军" },
                { name: "英语", count: 6, type: "main", teachers: "Miss Li" },
                { name: "物理", count: 5, type: "main", teachers: "" },
                { name: "化学", count: 4, type: "main", teachers: "" },
                { name: "生物", count: 3, type: "main", teachers: "" },
                { name: "历史", count: 3, type: "main", teachers: "" },
                { name: "地理", count: 2, type: "main", teachers: "" },
                { name: "政治", count: 2, type: "main", teachers: "" },
                { name: "体育", count: 3, type: "minor", teachers: "" },
                { name: "美术", count: 1, type: "minor", teachers: "" },
                { name: "音乐", count: 1, type: "minor", teachers: "" },
                { name: "信息技术", count: 1, type: "minor", teachers: "" }
            ],
            optimization: {
                golden_time: true,
                max_consecutive: 2
            },
            resources: [
                { name: "物理实验室", capacity: 2, subjects: "物理" },
                { name: "化学实验室", capacity: 2, subjects: "化学" },
                { name: "生物实验室", capacity: 2, subjects: "生物" },
                { name: "音乐教室", capacity: 1, subjects: "音乐" },
                { name: "美术教室", capacity: 1, subjects: "美术" },
                { name: "操场", capacity: 2, subjects: "体育" },
                { name: "计算机教室", capacity: 2, subjects: "信息技术" }
            ]
        };

        window.onload = function () {
            renderSettings();
            updateTotalHours();
            loadSavedList();
        };

        function openStatistics() {
            if (!statsModalVar) {
                statsModalVar = new bootstrap.Modal(document.getElementById('statisticsModal'));
            }
            statsModalVar.show();
            setTimeout(renderCharts, 300);
        }

        function renderCharts() {
            if (!currentStats) return;
            const ctx = document.getElementById('workloadChart').getContext('2d');
            if (workloadChart) workloadChart.destroy();

            const labels = Object.keys(currentStats).sort();
            const data = labels.map(n => currentStats[n].total);

            // Use primary color for chart
            const rootStyle = getComputedStyle(document.body);
            const primaryColor = rootStyle.getPropertyValue('--primary-color') || '#4f46e5';

            workloadChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '周课时总数',
                        data: data,
                        backgroundColor: primaryColor,
                        borderRadius: 4,
                        maxBarThickness: 40
                    }]
                },
                options: {
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function openSettings() {
            if (!constraintModalVar) {
                constraintModalVar = new bootstrap.Modal(document.getElementById('constraintModal'));
            }

            const select = document.getElementById('constraint-teacher-select');
            select.innerHTML = '<option value="">请选择...</option>';

            if (globalTeachers && globalTeachers.length > 0) {
                globalTeachers.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t.name;
                    opt.innerText = `${t.name} (${t.subject})`;
                    select.appendChild(opt);
                });
            } else {
                if (config.courses) {
                    let names = new Set();
                    config.courses.forEach(c => {
                        if (c.teachers) {
                            c.teachers.split(/[,，\s]+/).forEach(n => {
                                if (n) names.add(n);
                            });
                        }
                    });
                    names.forEach(n => {
                        const opt = document.createElement('option');
                        opt.value = n;
                        opt.innerText = n;
                        select.appendChild(opt);
                    });
                }
            }
            document.getElementById('constraint-tbody').innerHTML = '';
            constraintModalVar.show();
        }

        function renderConstraintGrid() {
            const tbody = document.getElementById('constraint-tbody');
            const teacherName = document.getElementById('constraint-teacher-select').value;
            tbody.innerHTML = '';

            if (!teacherName) return;
            const unavailable = globalConstraints.teacher_unavailable[teacherName] || [];
            const isUnavailable = (d, p) => unavailable.some(u => u[0] === d && u[1] === p);

            for (let p = 0; p < 9; p++) {
                const tr = document.createElement('tr');
                const th = document.createElement('th');
                th.innerText = p + 1;
                tr.appendChild(th);

                for (let d = 0; d < 5; d++) {
                    const td = document.createElement('td');
                    td.className = 'constraint-cell';
                    if (isUnavailable(d, p)) {
                        td.classList.add('unavailable');
                    }
                    td.onclick = () => toggleConstraint(teacherName, d, p, td);
                    tr.appendChild(td);
                }
                tbody.appendChild(tr);
            }
        }

        function toggleConstraint(teacherName, day, period, td) {
            if (!globalConstraints.teacher_unavailable[teacherName]) {
                globalConstraints.teacher_unavailable[teacherName] = [];
            }
            const list = globalConstraints.teacher_unavailable[teacherName];
            const index = list.findIndex(u => u[0] === day && u[1] === period);

            if (index >= 0) {
                list.splice(index, 1);
                td.classList.remove('unavailable');
            } else {
                list.push([day, period]);
                td.classList.add('unavailable');
            }
        }

        function saveSettings() {
            constraintModalVar.hide();
        }

        function renderSettings() {
            document.getElementById('setting-num-classes').value = config.num_classes;

            // Render optimization settings
            if (config.optimization) {
                document.getElementById('opt-golden-time').checked = config.optimization.golden_time;
                document.getElementById('opt-max-consecutive').value = config.optimization.max_consecutive;
            }

            if (config.resources) {
                const rbody = document.getElementById('resource-settings-body');
                rbody.innerHTML = '';
                config.resources.forEach(r => addResourceRow(r.name, r.capacity, r.subjects));
            }

            const tbody = document.getElementById('course-settings-body');
            tbody.innerHTML = '';
            config.courses.forEach((c) => {
                addCourseRow(c.name, c.count, c.type || 'minor', c.teachers);
            });
        }

        function addCourseRow(name = "", count = 2, type = "minor", teachers = "") {
            const tbody = document.getElementById('course-settings-body');
            const tr = document.createElement('tr');
            tr.innerHTML = `
            <td><input type="text" class="form-control form-control-sm course-name" value="${name}" placeholder="科目"></td>
            <td><input type="number" class="form-control form-control-sm course-count" value="${count}" onchange="updateTotalHours()"></td>
            <td>
                <select class="form-select form-select-sm course-type">
                    <option value="main" ${type === 'main' ? 'selected' : ''}>主课</option>
                    <option value="minor" ${type === 'minor' ? 'selected' : ''}>副课</option>
                </select>
            </td>
            <td><input type="text" class="form-control form-control-sm course-teachers" value="${teachers}" placeholder="例如: 张三, 李四"></td>
            <td><button class="btn btn-sm btn-outline-danger" onclick="removeRow(this)"><i class="bi bi-trash"></i></button></td>
        `;
            tbody.appendChild(tr);
            updateTotalHours();
        }

        function addResourceRow(name = "", capacity = 1, subjects = "") {
            const tbody = document.getElementById('resource-settings-body');
            const tr = document.createElement('tr');
            tr.innerHTML = `
            <td><input type="text" class="form-control form-control-sm res-name" value="${name}" placeholder="如：音乐室"></td>
            <td><input type="number" class="form-control form-control-sm res-capacity" value="${capacity}" min="1"></td>
            <td><input type="text" class="form-control form-control-sm res-subjects" value="${subjects}" placeholder="如：音乐, 舞蹈"></td>
            <td><button class="btn btn-sm btn-outline-danger" onclick="removeRow(this)"><i class="bi bi-trash"></i></button></td>
        `;
            tbody.appendChild(tr);
        }

        function removeRow(btn) {
            btn.closest('tr').remove();
            updateTotalHours(); // Safe to call even if it's a resource row (won't find course inputs)
        }

        function updateTotalHours() {
            const rows = document.querySelectorAll('#course-settings-body tr');
            let total = 0;
            rows.forEach(row => {
                const count = parseInt(row.querySelector('.course-count').value) || 0;
                total += count;
            });
            const el = document.getElementById('total-hours');
            el.innerText = total;
            el.className = total > 45 ? "fw-bold text-danger" : "fw-bold text-primary";
        }

        function saveSettingsAndInit() {
            config.num_classes = parseInt(document.getElementById('setting-num-classes').value);

            // Read optimization settings
            config.optimization = {
                golden_time: document.getElementById('opt-golden-time').checked,
                max_consecutive: parseInt(document.getElementById('opt-max-consecutive').value)
            };

            const rows = document.querySelectorAll('#course-settings-body tr');
            let newCourses = [];
            let coursesDict = {};
            let teacherNamesDict = {};
            let total = 0;

            rows.forEach(row => {
                const name = row.querySelector('.course-name').value.trim();
                const count = parseInt(row.querySelector('.course-count').value);
                const type = row.querySelector('.course-type').value;
                const teacherStr = row.querySelector('.course-teachers').value.trim();

                if (name && count > 0) {
                    newCourses.push({ name, count, type, teachers: teacherStr });
                    coursesDict[name] = { count: count, type: type };
                    total += count;
                    if (teacherStr) {
                        const names = teacherStr.split(/[,，\s]+/).filter(n => n.length > 0);
                        if (names.length > 0) teacherNamesDict[name] = names;
                    }
                }
            });

            config.courses = newCourses;

            // 3. Save resources
            let newResources = [];
            document.querySelectorAll('#resource-settings-body tr').forEach(row => {
                const name = row.querySelector('.res-name').value.trim();
                const capacity = parseInt(row.querySelector('.res-capacity').value) || 1;
                const subjects = row.querySelector('.res-subjects').value.trim();
                if (name && subjects) {
                    newResources.push({ name, capacity, subjects });
                }
            });
            config.resources = newResources;

            if (total > 45) {
                alert(`⚠️ 注意：总课时 (${total}) 超过了每周容量 (45)！\n多出的课程可能无法安排。`);
            }

            const payload = {
                num_classes: config.num_classes,
                courses: coursesDict,
                teacher_names: teacherNamesDict,
                resources: config.resources,  // 添加教室资源配置
                optimization: config.optimization
            };
            initSystem(payload);
        }

        async function initSystem(customPayload = null) {
            const btn = document.getElementById('btn-init');
            const spinner = document.getElementById('init-spinner');
            const status = document.getElementById('system-status');

            btn.disabled = true;
            spinner.classList.remove('d-none');
            // Use HTML for Icon
            status.innerHTML = '<span class="text-primary"><i class="bi bi-hourglass-split"></i> 计算中...</span>';

            let payload = customPayload;
            if (!payload) {
                // Extract teacher names for map
                let tDict = {};
                config.courses.forEach(c => {
                    if (c.teachers) tDict[c.name] = c.teachers.split(/[,，\s]+/).filter(n => n);
                });

                // Ensure optimization/resources included in default payload
                if (!config.optimization) config.optimization = { golden_time: true, max_consecutive: 2 };
                if (!config.resources) config.resources = [];

                payload = {
                    num_classes: config.num_classes,
                    courses: config.courses, // Send full list directly (backend now supports this)
                    teacher_names: tDict,
                    optimization: config.optimization,
                    resources: config.resources
                };
            }
            payload.constraints = globalConstraints;
            // 确保资源配置也被传递 (如果点击保存按钮会走customPayload，上面的分支是点初始化按钮)
            if (customPayload && !customPayload.resources) {
                customPayload.resources = config.resources;
            }

            try {
                const response = await fetch('/api/init', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();

                if (data.status === 'success') {
                    // Clear history on new init
                    historyStack = [];
                    redoStack = [];
                    updateUndoButtons();

                    updateUI(data);
                    status.innerHTML = '<i class="bi bi-check-circle-fill"></i> 排课成功';
                    status.className = "text-center text-success fw-bold mb-3";
                    clearErrorAlert();
                } else {
                    showErrorAlert(data);
                    status.innerHTML = '<i class="bi bi-x-circle-fill"></i> 失败';
                    status.className = "text-center text-danger fw-bold mb-3";
                }
            } catch (e) {
                console.error(e);
                showErrorAlert({
                    error_type: "network_error",
                    message: "网络请求失败",
                    suggestions: ["请检查网络连接", "刷新页面重试"]
                });
                status.innerText = "网络错误";
            } finally {
                btn.disabled = false;
                spinner.classList.add('d-none');
            }
        }

        function updateUI(data) {
            if (data.stats) {
                currentStats = data.stats;
                document.getElementById('btn-stats').disabled = false;
            }
            globalTeachers = data.teachers || [];
            globalSchedule = data.schedule; // Update global variable

            // === Build Teacher Schedule Map for Conflict Detection ===
            teacherScheduleMap = {};
            if (globalSchedule) {
                Object.entries(globalSchedule).forEach(([classId, periods]) => {
                    Object.entries(periods).forEach(([pIndex, days]) => {
                        Object.entries(days).forEach(([dIndex, info]) => {
                            if (info && info.teacher_name) {
                                // Split teachers if multiple (e.g. "Zhang, Li") - though system usually assigns one main
                                // Assuming simple case or primary teacher
                                const tName = info.teacher_name;
                                if (!teacherScheduleMap[tName]) teacherScheduleMap[tName] = {};
                                teacherScheduleMap[tName][`${dIndex}_${pIndex}`] = {
                                    classId: classId,
                                    subject: info.subject,
                                    room: info.room
                                };
                            }
                        });
                    });
                });
            }
            // =========================================================

            const teacherSelect = document.getElementById('teacher-select');
            teacherSelect.innerHTML = '';
            globalTeachers.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.name;
                opt.innerText = t.name;
                teacherSelect.appendChild(opt);
            });

            const teacherViewSelect = document.getElementById('teacher-view-select');
            teacherViewSelect.innerHTML = '';
            globalTeachers.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.name;
                opt.innerText = t.name;
                teacherViewSelect.appendChild(opt);
            });

            const classSelect = document.getElementById('class-select');
            classSelect.innerHTML = '';
            Object.keys(data.schedule).forEach(cid => {
                const opt = document.createElement('option');
                opt.value = cid;
                opt.innerText = cid + " 班";
                classSelect.appendChild(opt);
            });

            // globalSchedule = data.schedule; // Already updated above
            renderCurrentClass();

            teacherSelect.disabled = false;
            document.getElementById('btn-add-leave').disabled = false;
            document.getElementById('btn-apply').disabled = false;
            document.getElementById('btn-save').disabled = false;
            document.getElementById('btn-export-current').disabled = false;
            document.getElementById('btn-export-all').disabled = false;
            document.getElementById('btn-view-teacher').disabled = false;
        }

        function renderCurrentClass() {
            const classId = document.getElementById('class-select').value;
            const tbody = document.getElementById('schedule-body');
            const title = document.getElementById('class-title');

            if (!classId || !globalSchedule[classId]) return;
            title.innerText = `${classId} 班 课表`;
            tbody.innerHTML = '';

            const classData = globalSchedule[classId];
            for (let p = 0; p < 9; p++) {
                const tr = document.createElement('tr');
                const th = document.createElement('th'); th.innerText = `第 ${p + 1} 节`; tr.appendChild(th);
                for (let d = 0; d < 5; d++) {
                    const td = document.createElement('td');
                    td.className = "draggable-cell";
                    // Add data attributes for conflict detection
                    td.dataset.day = d;
                    td.dataset.period = p;

                    td.setAttribute('draggable', 'true');
                    td.setAttribute('ondragstart', `handleDragStart(event, ${p}, ${d})`);
                    td.setAttribute('ondragover', 'handleDragOver(event)');
                    td.setAttribute('ondrop', `handleDrop(event, ${p}, ${d})`);
                    td.setAttribute('ondragleave', 'handleDragLeave(event)');
                    td.setAttribute('ondragend', 'handleDragEnd(event)');
                    // Add click handler for Smart Suggestions
                    td.setAttribute('onclick', `handleCellClick(event, ${p}, ${d})`);

                    const info = classData[p][d];
                    if (info) {
                        // 添加课程类型样式
                        if (info.course_type === 'main') {
                            td.classList.add('course-main');
                        } else {
                            td.classList.add('course-minor');
                        }

                        if (info.is_sub) {
                            td.classList.add(info.teacher_name === "【自习】" ? "status-empty" : "status-sub");
                        }

                        let html = `<div class="course-cell">${info.subject}</div><span class="teacher-name">${info.teacher_name}</span>`;
                        if (info.room) {
                            html += `<div class="mt-1"><span class="badge bg-light text-secondary border fw-normal" style="font-size: 0.7rem;"><i class="bi bi-geo-alt-fill me-1"></i>${info.room}</span></div>`;
                        }
                        td.innerHTML = html;
                    }
                    tr.appendChild(td);
                }
                tbody.appendChild(tr);
            }
        }

        let draggedSource = null;
        const tooltipEl = document.getElementById('conflict-tooltip');

        function handleDragStart(e, period, day) {
            clearSuggestions(); // Clear any existing highlights
            const classId = document.getElementById('class-select').value;
            // Get teacher name from globalSchedule
            const info = globalSchedule[classId] ? globalSchedule[classId][period][day] : null;
            const teacher = info ? info.teacher_name : null;

            draggedSource = { period, day, teacher };
            e.target.classList.add('drag-source');
            e.dataTransfer.setData('text/plain', JSON.stringify({ period, day }));
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            e.preventDefault();
            const td = e.target.closest('td');
            // Basic checks
            if (!td || td.classList.contains('drag-source')) return;

            const targetDay = td.dataset.day;
            const targetPeriod = td.dataset.period;

            // Conflict Detection Logic
            if (draggedSource && draggedSource.teacher && targetDay !== undefined) {
                const map = teacherScheduleMap[draggedSource.teacher];
                const key = `${targetDay}_${targetPeriod}`;
                const conflict = map ? map[key] : null;
                const currentClassId = document.getElementById('class-select').value;

                // Check if teacher busy elsewhere (same teacher, same slot, DIFFERENT class)
                if (conflict && conflict.classId != currentClassId) {
                    td.classList.add('conflict-cell');
                    // Show Tooltip
                    tooltipEl.style.display = 'block';
                    tooltipEl.style.left = (e.pageX + 15) + 'px';
                    tooltipEl.style.top = (e.pageY + 15) + 'px';
                    tooltipEl.innerText = `⚠️ 冲突: ${draggedSource.teacher} 在 ${conflict.classId}班 有课 (${conflict.subject})`;

                    e.dataTransfer.dropEffect = 'none'; // Forbidden
                    return;
                }
            }

            td.classList.add('drag-over');
            e.dataTransfer.dropEffect = 'move';
            hideTooltip();
        }

        function handleDragLeave(e) {
            const td = e.target.closest('td');
            if (td) {
                td.classList.remove('drag-over');
                td.classList.remove('conflict-cell');
            }
            hideTooltip();
        }

        function handleDragEnd(e) {
            e.target.classList.remove('drag-source');
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            document.querySelectorAll('.conflict-cell').forEach(el => el.classList.remove('conflict-cell'));
            hideTooltip();
        }

        function hideTooltip() {
            tooltipEl.style.display = 'none';
        }
        async function handleDrop(e, targetPeriod, targetDay) {
            e.preventDefault();
            handleDragEnd(e);
            if (!draggedSource) return;
            const sourcePeriod = draggedSource.period;
            const sourceDay = draggedSource.day;
            if (sourcePeriod === targetPeriod && sourceDay === targetDay) return;
            const classId = document.getElementById('class-select').value;

            try {
                // Save state before move
                pushHistory();

                const response = await fetch('/api/schedule/move', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        class_id: classId,
                        from_slot: [sourceDay, sourcePeriod],
                        to_slot: [targetDay, targetPeriod]
                    })
                });
                const data = await response.json();
                if (data.status === 'success') {
                    globalSchedule = data.schedule;
                    renderCurrentClass();
                } else {
                    alert(`调课失败: ${data.message}`);
                }
            } catch (err) {
                console.error(err);
                alert('系统错误: ' + err.message);
            }
            draggedSource = null;
        }

        function addLeave() {
            const name = document.getElementById('teacher-select').value;
            const start = document.getElementById('start-day').value;
            const end = document.getElementById('end-day').value;
            const map = { "周一": 0, "周二": 1, "周三": 2, "周四": 3, "周五": 4 };
            if (map[start] > map[end]) { alert("日期顺序错误"); return; }
            const days = [];
            for (let i = map[start]; i <= map[end]; i++) days.push(DAYS[i]);
            leaveRequests.push({ name, days });
            updateLeaveList();
        }

        function updateLeaveList() {
            const list = document.getElementById('leave-list');
            if (leaveRequests.length === 0) { list.innerHTML = ''; return; }
            list.innerHTML = leaveRequests.map((req, index) => `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>
                        <strong>${req.name}</strong>
                        <br>
                        <small class="text-muted">${req.days.join(', ')}</small>
                    </span>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeLeave(${index})"><i class="bi bi-x"></i></button>
                </li>
            `).join('');
        }
        function removeLeave(index) {
            leaveRequests.splice(index, 1);
            updateLeaveList();
        }

        async function applySubstitutions() {
            const btn = document.getElementById('btn-apply');
            btn.disabled = true; btn.innerText = "计算中...";
            try {
                // Save state before substitution
                pushHistory();

                const resp = await fetch('/api/substitute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ leaves: leaveRequests })
                });
                const data = await resp.json();
                if (data.status === 'success') {
                    globalSchedule = data.schedule;
                    renderCurrentClass();
                    if (data.logs) showSubstitutionLogs(data.stats, data.logs);
                    alert("代课安排完成！");
                } else {
                    alert("错误: " + data.message);
                }
            } finally {
                btn.disabled = false; btn.innerHTML = '<i class="bi bi-arrow-repeat me-1"></i>执行智能代课';
            }
        }

        function showSubstitutionLogs(stats, logs) {
            const container = document.getElementById('substitution-logs-container');
            container.style.display = 'block';
            document.getElementById('stat-direct').textContent = stats.direct || 0;
            document.getElementById('stat-swap').textContent = stats.swap || 0;
            document.getElementById('stat-self').textContent = stats.self_study || 0;
            const totalScore = (stats.direct || 0) * 0 + (stats.swap || 0) * 1 + (stats.self_study || 0) * 999;
            document.getElementById('stat-score').textContent = totalScore;

            const logsContainer = document.getElementById('sub-logs');
            if (logs && logs.length > 0) {
                logsContainer.innerHTML = logs.map(log => {
                    const colorClass = log.type === 'self_study' ? 'text-danger' : 'text-success';
                    return `<div class="${colorClass}" style="margin-bottom: 4px;">${log.message}</div>`;
                }).join('');
            } else {
                logsContainer.innerHTML = '<div class="text-muted text-center">暂无日志</div>';
            }
            setTimeout(() => container.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 100);
        }

        async function loadSavedList() {
            try {
                const resp = await fetch('/api/list');
                const data = await resp.json();
                const listEl = document.getElementById('saved-list');
                if (data.status === 'success' && data.schedules && data.schedules.length > 0) {
                    listEl.innerHTML = '';
                    data.schedules.forEach(s => {
                        const item = document.createElement('div');
                        item.className = 'list-group-item d-flex justify-content-between align-items-start p-2';

                        // Create content wrapper for click (Load)
                        const content = document.createElement('div');
                        content.className = 'flex-grow-1';
                        content.style.cursor = 'pointer';
                        content.onclick = function () {
                            console.log('Click triggered for:', s.name);
                            // alert('DEBUG: Clicked ' + s.name); // Uncomment for debugging
                            loadSchedule(s.name);
                        };
                        content.innerHTML = `
                            <strong>${s.name}</strong>
                            <div class="text-muted" style="font-size: 0.75rem;">${s.created_at}</div>
                        `;

                        // Create delete button
                        const delBtn = document.createElement('button');
                        delBtn.className = 'btn btn-sm btn-outline-danger py-0 px-1';
                        delBtn.title = '删除';
                        delBtn.innerHTML = '<i class="bi bi-x" style="pointer-events: none;"></i>';
                        delBtn.type = 'button'; // Prevent default form submission
                        delBtn.style.zIndex = '100'; // Force on top
                        delBtn.style.position = 'relative';
                        delBtn.onclick = function (e) {
                            // Ensure event doesn't bubble or do default action
                            e.stopPropagation();
                            e.preventDefault();

                            console.log('Delete button clicked for:', s.name);
                            deleteSchedule(s.name);
                        };

                        item.appendChild(content);
                        item.appendChild(delBtn);
                        listEl.appendChild(item);
                    });
                } else {
                    listEl.innerHTML = '<div class="text-center text-muted py-2">暂无保存方案</div>';
                }
            } catch (e) {
                console.error('加载方案列表失败:', e);
            }
        }

        async function loadSchedule(name) {
            console.log('Executing loadSchedule for:', name);
            // Temporary removed confirm for debugging
            // if (!confirm(`确定要加载方案 "${name}" 吗？...`)) return;

            try {
                const resp = await fetch(`/api/load/${encodeURIComponent(name)}`);
                const data = await resp.json();

                if (data.status === 'success') {
                    // Clear history on load
                    historyStack = [];
                    redoStack = [];
                    updateUndoButtons();

                    // 1. Update Global Schedule
                    globalSchedule = data.schedule;

                    // Update UI Dropdowns
                    const classSelect = document.getElementById('class-select');
                    classSelect.innerHTML = '';
                    Object.keys(globalSchedule).forEach(cid => {
                        const opt = document.createElement('option');
                        opt.value = cid;
                        opt.innerText = cid + " 班";
                        classSelect.appendChild(opt);
                    });

                    // Update Teacher Dropdown (for leave requests)
                    const teacherSelect = document.getElementById('teacher-select');
                    teacherSelect.innerHTML = '';
                    if (data.teachers && data.teachers.length > 0) {
                        data.teachers.forEach(t => {
                            const opt = document.createElement('option');
                            opt.value = t.name;
                            opt.innerText = t.name;
                            teacherSelect.appendChild(opt);
                        });
                    }

                    // Enable buttons
                    document.getElementById('teacher-select').disabled = false;
                    document.getElementById('btn-add-leave').disabled = false;
                    document.getElementById('btn-apply').disabled = false;
                    document.getElementById('btn-save').disabled = false;
                    document.getElementById('btn-export-current').disabled = false;
                    document.getElementById('btn-export-all').disabled = false;
                    document.getElementById('btn-view-teacher').disabled = false;

                    renderCurrentClass();

                    // 2. Restore Configuration
                    if (data.config) {
                        config = data.config;

                        // Restore basic settings
                        document.getElementById('setting-num-classes').value = config.num_classes || 10;
                        if (config.optimization) {
                            document.getElementById('opt-golden-time').checked = config.optimization.golden_time;
                            document.getElementById('opt-max-consecutive').value = config.optimization.max_consecutive || 2;
                        }

                        // Restore Course Table
                        const courseBody = document.getElementById('course-settings-body');
                        courseBody.innerHTML = '';

                        // Handle both list and dict formats for courses
                        let coursesList = [];
                        if (Array.isArray(config.courses)) {
                            coursesList = config.courses;
                        } else if (config.courses) {
                            // Convert old dict format to list
                            for (const [name, val] of Object.entries(config.courses)) {
                                if (typeof val === 'object') {
                                    coursesList.push({ name: name, ...val });
                                } else {
                                    coursesList.push({ name: name, count: val, type: val >= 5 ? 'main' : 'minor' });
                                }
                            }
                        }

                        coursesList.forEach(c => {
                            // Re-construct teacher string from config or teacher_names mapping if available
                            let teacherStr = c.teachers || "";
                            if (!teacherStr && config.teacher_names && config.teacher_names[c.name]) {
                                teacherStr = config.teacher_names[c.name].join(" ");
                            }
                            addCourseRow(c.name, c.count, c.type, teacherStr);
                        });

                        // Restore Resources
                        const resBody = document.getElementById('resource-settings-body');
                        resBody.innerHTML = '';
                        if (config.resources && Array.isArray(config.resources)) {
                            config.resources.forEach(r => {
                                addResourceRow(r.name, r.capacity, r.subjects);
                            });
                        }

                        updateTotalHours();
                    }

                    alert(`方案 "${name}" 加载成功！`);
                    // Update system status
                    const status = document.getElementById('system-status');
                    status.innerHTML = `<i class="bi bi-cloud-check-fill"></i> 已加载`;
                    status.className = "text-center text-info fw-bold mb-3";

                } else {
                    alert(`加载失败: ${data.message}`);
                }
            } catch (e) {
                console.error("加载异常:", e);
                alert("系统错误: " + e.message);
            }
        }

        async function saveCurrentSchedule() {
            const name = document.getElementById('save-name').value.trim();
            if (!name) { alert('请输入方案名称'); return; }
            if (!globalSchedule || Object.keys(globalSchedule).length === 0) { alert('没有可保存的课表'); return; }
            try {
                const resp = await fetch('/api/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name, config: config })
                });
                const data = await resp.json();
                if (data.status === 'success') {
                    alert(`✅ ${data.message}`);
                    document.getElementById('save-name').value = '';
                    loadSavedList();
                } else {
                    alert(`❌ ${data.message}`);
                }
            } catch (e) { alert('保存失败: ' + e.message); }
        }




        // 第一阶段：点击删除按钮，只负责弹窗
        function deleteSchedule(name) {
            targetDeleteName = name; // 记下要删谁

            // 更新弹窗里的文字
            document.getElementById('delete-target-name').innerText = name;

            // 显示弹窗
            const modalEl = document.getElementById('deleteConfirmModal');
            if (!deleteModalVar) {
                deleteModalVar = new bootstrap.Modal(modalEl);
            }
            deleteModalVar.show();
        }

        function exportCurrentClass() {
            const classId = document.getElementById('class-select').value;
            if (!classId) { alert('请先选择要导出的班级'); return; }
            window.location.href = `/api/export/class/${classId}`;
        }

        function exportAllClasses() {
            if (!confirm('确定要导出所有班级的课表吗？')) return;
            window.location.href = '/api/export/all_classes';
        }

        function switchView(mode) {
            currentView = mode;
            const classBtn = document.getElementById('btn-view-class');
            const teacherBtn = document.getElementById('btn-view-teacher');
            const classSelector = document.getElementById('class-selector-group');
            const teacherSelector = document.getElementById('teacher-selector-group');
            const title = document.getElementById('class-title');

            if (mode === 'class') {
                classBtn.classList.add('active');
                teacherBtn.classList.remove('active');
                classSelector.style.display = 'flex';
                teacherSelector.style.display = 'none';
                title.innerText = '班级课表';
                renderCurrentClass();
            } else if (mode === 'teacher') {
                classBtn.classList.remove('active');
                teacherBtn.classList.add('active');
                classSelector.style.display = 'none';
                teacherSelector.style.display = 'flex';
                title.innerText = '老师课表';
                renderCurrentTeacher();
            }
        }

        async function renderCurrentTeacher() {
            const teacherName = document.getElementById('teacher-view-select').value;
            if (!teacherName) return;
            try {
                const resp = await fetch('/api/teacher_view', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ teacher_name: teacherName })
                });
                const data = await resp.json();
                if (data.status === 'success') {
                    renderTeacherSchedule(data.schedule);
                } else {
                    alert(`错误: ${data.message}`);
                }
            } catch (e) { alert('获取老师课表失败: ' + e.message); }
        }

        function renderTeacherSchedule(schedule) {
            const tbody = document.getElementById('schedule-body');
            tbody.innerHTML = '';
            for (let p = 0; p < 9; p++) {
                const tr = document.createElement('tr');
                const th = document.createElement('th'); th.innerText = `第 ${p + 1} 节`; tr.appendChild(th);
                for (let d = 0; d < 5; d++) {
                    const td = document.createElement('td');
                    const periodData = schedule[p];
                    const info = periodData ? periodData[d] : null;
                    if (info) {
                        td.className = info.is_sub ? 'status-sub' : '';
                        td.innerHTML = `<div class="course-cell">${info.class_id}班</div><span class="teacher-name">${info.subject}</span>`;
                    }
                    tr.appendChild(td);
                }
                tbody.appendChild(tr);
            }
        }

        function showErrorAlert(errorData) {
            const container = document.getElementById('error-alert-container');
            let alertClass = 'alert-warning';
            let icon = '<i class="bi bi-exclamation-triangle-fill"></i>';
            if (errorData.error_type === 'system_error' || errorData.error_type === 'network_error') {
                alertClass = 'alert-danger';
                icon = '<i class="bi bi-x-circle-fill"></i>';
            }
            let suggestionsHTML = '';
            if (errorData.suggestions && errorData.suggestions.length > 0) {
                suggestionsHTML = '<div class="mt-2"><strong><i class="bi bi-lightbulb"></i> 建议：</strong><ul class="mb-0 mt-1">';
                errorData.suggestions.forEach(suggestion => {
                    suggestionsHTML += `<li>${suggestion}</li>`;
                });
                suggestionsHTML += '</ul></div>';
            }
            container.innerHTML = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    <h6 class="alert-heading alert-title">${icon} ${errorData.message || '排课失败'}</h6>
                    ${suggestionsHTML}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }

        function clearErrorAlert() {
            document.getElementById('error-alert-container').innerHTML = '';
        }

        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('btn-confirm-delete').addEventListener('click', async function () {
                // 关闭弹窗
                if (deleteModalVar) deleteModalVar.hide();

                const name = targetDeleteName;
                if (!name) return;

                try {
                    const resp = await fetch('/api/delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: name })
                    });

                    if (!resp.ok) {
                        const text = await resp.text();
                        throw new Error(`服务器错误 (${resp.status}): ${text.substring(0, 50)}`);
                    }

                    const data = await resp.json();

                    if (data.status === 'success') {
                        // 不弹窗干扰用户，直接刷新列表，体验更流畅
                        loadSavedList();
                        // 可选：显示一个轻提示（Toast），这里简单用控制台记录
                        console.log(`方案 ${name} 删除成功`);
                    } else {
                        alert(`删除失败: ${data.message}`);
                    }
                } catch (e) {
                    console.error("删除请求出错:", e);
                    alert(`系统错误: ${e.message}`);
                }
            });
        });

        // ================= Undo/Redo Logic =================
        function pushHistory() {
            if (!globalSchedule || Object.keys(globalSchedule).length === 0) return;
            // Deep copy
            const snapshot = JSON.parse(JSON.stringify(globalSchedule));
            historyStack.push(snapshot);
            if (historyStack.length > MAX_HISTORY) historyStack.shift();
            redoStack = []; // Clear redo on new action
            updateUndoButtons();
        }

        async function performUndo() {
            if (historyStack.length === 0) return;
            // Save current state to redo stack
            const currentState = JSON.parse(JSON.stringify(globalSchedule));
            redoStack.push(currentState);

            const prevState = historyStack.pop();
            await applyRestoredState(prevState);
            updateUndoButtons();
        }

        async function performRedo() {
            if (redoStack.length === 0) return;
            // Save current state to history
            const currentState = JSON.parse(JSON.stringify(globalSchedule));
            historyStack.push(currentState);

            const nextState = redoStack.pop();
            await applyRestoredState(nextState);
            updateUndoButtons();
        }

        async function applyRestoredState(scheduleData) {
            try {
                const resp = await fetch('/api/restore', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ schedule: scheduleData })
                });
                const data = await resp.json();
                if (data.status === 'success') {
                    // Update global variable
                    globalSchedule = scheduleData;

                    // Re-calculate derived data (teacher map)
                    updateUI({ schedule: globalSchedule, teachers: globalTeachers, stats: data.stats });

                    // Re-render current view
                    if (currentView === 'class') renderCurrentClass();
                    else if (currentView === 'teacher') renderCurrentTeacher();

                } else {
                    alert('恢复状态失败: ' + data.message);
                }
            } catch (e) {
                console.error(e);
                alert('系统错误: ' + e.message);
            }
        }

        function updateUndoButtons() {
            const btnUndo = document.getElementById('btn-undo');
            const btnRedo = document.getElementById('btn-redo');
            if (btnUndo) btnUndo.disabled = historyStack.length === 0;
            if (btnRedo) btnRedo.disabled = redoStack.length === 0;
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function (e) {
            // Check if input/textarea is focused to avoid conflict? (optional)
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                e.preventDefault();
                performUndo();
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'y') {
                e.preventDefault();
                performRedo();
            }
        });

        async function handleConfigUpload(input) {
            if (!input.files || input.files.length === 0) return;

            const file = input.files[0];
            const formData = new FormData();
            formData.append('file', file);

            try {
                // Show loading state?
                const btn = input.nextElementSibling; // The button is actually next next.. getting via ID is safer but button triggered click.
                // Doesn't matter, just fetch.

                const resp = await fetch('/api/import_config', {
                    method: 'POST',
                    body: formData
                });

                if (!resp.ok) {
                    const text = await resp.text();
                    throw new Error(`Import failed: ${text}`);
                }

                const data = await resp.json();
                if (data.status === 'success') {
                    // Convert courses dict to array
                    const newCourses = [];
                    for (const [subj, info] of Object.entries(data.courses)) {
                        newCourses.push({
                            name: subj,
                            count: info.count,
                            type: info.type,
                            teachers: info.teachers.join(', ')
                        });
                    }
                    config.courses = newCourses;

                    // Resources
                    const newResources = data.resources.map(r => ({
                        name: r.name,
                        capacity: r.capacity,
                        subjects: r.subjects.join(', ')
                    }));
                    config.resources = newResources;

                    renderSettings();
                    alert(`✅ ${data.message}`);
                } else {
                    alert(`❌ 导入失败: ${data.message}`);
                }
            } catch (e) {
                console.error(e);
                alert(`系统错误: ${e.message}`);
            } finally {
                input.value = ''; // Reset input
            }
        }


        // ================= Smart Suggestions =================
        function handleCellClick(e, srcPeriod, srcDay) {
            // If dragging, ignore click
            if (e.target.closest('.drag-source')) return;

            // Clear previous suggestions
            clearSuggestions();

            const classId = document.getElementById('class-select').value;
            const info = globalSchedule[classId] ? globalSchedule[classId][srcPeriod][srcDay] : null;

            if (!info || !info.teacher_name) return; // Clicked empty cell

            const teacher = info.teacher_name;

            // [~] Implement smart suggestions (highlight feasible slots for a selected class) <!-- id: 7 -->
            // Highlight feasible slots
            // Feasible = Empty slot AND Teacher is free
            const tbody = document.getElementById('schedule-body');
            const rows = tbody.querySelectorAll('tr');

            for (let p = 0; p < 9; p++) {
                for (let d = 0; d < 5; d++) {
                    // Skip self
                    if (p === srcPeriod && d === srcDay) continue;

                    // Check if slot is empty in current class
                    const targetInfo = globalSchedule[classId][p][d];
                    if (!targetInfo) {
                        // Slot is empty from class perspective.
                        // Check teacher availability
                        // Teacher is busy if teacherScheduleMap[teacher] has entry at (d,p)
                        // AND that entry is NOT the current class (moving within same class is fine, but we are checking empty slots so no entry should be there for current class)

                        // Wait, if teacher teaches Class 2 at (d,p), they are busy. 
                        const map = teacherScheduleMap[teacher];
                        const key = `${d}_${p}`;
                        const conflict = map ? map[key] : null;

                        if (!conflict) {
                            // Feasible!
                            // Find the TD
                            const targetTd = rows[p].children[d + 1]; // +1 because of TH
                            if (targetTd) targetTd.classList.add('feasible-cell');
                        }
                    }
                }
            }
        }

        function clearSuggestions() {
            document.querySelectorAll('.feasible-cell').forEach(el => el.classList.remove('feasible-cell'));
        }

        // Hide suggestions when clicking outside table
        document.addEventListener('click', function (e) {
            if (!e.target.closest('.schedule-table')) {
                clearSuggestions();
            }
        });
    </script>
    <script>
        // 开屏动画控制
        window.addEventListener('load', () => {
            setTimeout(() => {
                const splash = document.getElementById('splash-screen');
                if (splash) {
                    splash.classList.add('hidden');
                    setTimeout(() => {
                        splash.remove(); // 动画结束后从DOM移除
                    }, 800);
                }
            }, 1000); // 至少显示1秒
        });
    </script>
</body>

</html>