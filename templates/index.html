<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>得鹿山智能排课系统</title>
    <!-- Tailwind CSS -->
    <link href="/static/css/output.css" rel="stylesheet">
    <!-- Google Fonts for Campus Vibe -->
    <link
        href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Quicksand:wght@500;600;700&display=swap"
        rel="stylesheet">
    <!-- Bootstrap CSS (Keep for Modals compatibility) -->
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/bootstrap-icons.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #eef2f6;
            background-image: radial-gradient(#cbd5e0 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .clay-card {
            background: #eef2f6;
            border-radius: 20px;
            box-shadow: 8px 8px 16px #dce1e8, -8px -8px 16px #ffffff;
            transition: all 0.3s ease;
        }

        .clay-btn {
            background: #eef2f6;
            border-radius: 12px;
            box-shadow: 5px 5px 10px #dce1e8, -5px -5px 10px #ffffff;
            color: #4a5568;
            transition: all 0.2s ease;
            font-weight: 700;
        }

        .clay-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            color: #3182ce;
        }

        .clay-btn:active:not(:disabled) {
            box-shadow: inset 5px 5px 10px #dce1e8, inset -5px -5px 10px #ffffff;
            transform: translateY(0);
        }

        .clay-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .clay-btn-primary {
            background: #ebf8ff;
            color: #2b6cb0;
        }

        .clay-btn-primary:hover:not(:disabled) {
            color: #2c5282;
        }

        .clay-input {
            background: #eef2f6;
            border: none;
            border-radius: 12px;
            padding: 0.75rem 1rem;
            box-shadow: inset 5px 5px 10px #dce1e8, inset -5px -5px 10px #ffffff;
            outline: none;
            transition: all 0.2s;
        }

        .clay-input:focus {
            box-shadow: inset 8px 8px 16px #dce1e8, inset -8px -8px 16px #ffffff;
        }

        /* Schedule Table */
        .schedule-cell {
            background: #eef2f6;
            border-radius: 12px;
            box-shadow: 3px 3px 6px #dce1e8, -3px -3px 6px #ffffff;
            transition: transform 0.2s;
            cursor: move;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 4px;
        }

        .schedule-cell:hover {
            transform: scale(1.02);
            z-index: 10;
        }

        .schedule-cell.empty {
            box-shadow: inset 3px 3px 6px #dce1e8, inset -3px -3px 6px #ffffff;
            opacity: 0.6;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }
    </style>
</head>

<body class="h-screen flex overflow-hidden text-slate-600 font-sans p-4 gap-4">

    <!-- Splash -->
    <div id="splash-screen"
        class="fixed inset-0 bg-[#eef2f6] z-[9999] flex flex-col items-center justify-center transition-opacity duration-700">
        <div class="clay-card p-8 flex flex-col items-center animate-bounce">
            <img src="/static/logo.png" class="w-16 h-16 mb-4 object-contain">
            <h2 class="text-2xl font-black text-slate-700 tracking-wider">得鹿山</h2>
            <p class="text-slate-400 font-bold mt-2">校园排课系统加载中...</p>
        </div>
    </div>

    <!-- Sidebar (Left Panel) -->
    <aside id="main-sidebar"
        class="w-72 bg-white/80 backdrop-blur-xl border-r border-white/50 flex flex-col fixed md:relative z-50 h-full transition-transform transform -translate-x-full md:translate-x-0 shadow-2xl md:shadow-none">
        <!-- Header -->
        <div class="p-6 pb-2 text-center relative">
            <button class="md:hidden absolute top-4 right-4 text-slate-400 hover:text-slate-600"
                onclick="toggleSidebar()">
                <i class="bi bi-x-lg text-xl"></i>
            </button>
            <div class="w-20 h-20 mx-auto clay-card flex items-center justify-center mb-4 rounded-full">
                <img src="/static/logo.png" class="w-12 h-12 object-contain" alt="Logo">
            </div>
            <h1 class="text-2xl font-black text-slate-700 font-display">得鹿山智能排课</h1>
            <div
                class="inline-block px-3 py-1 mt-2 bg-yellow-100 text-yellow-600 rounded-full text-xs font-bold shadow-sm">
                校园版
            </div>
        </div>

        <!-- Navigation -->
        <div class="flex-1 overflow-y-auto px-6 py-4 space-y-6 custom-scrollbar">

            <!-- Main Actions -->
            <button id="btn-init" onclick="initSystem()"
                class="w-full clay-btn clay-btn-primary py-4 text-lg flex items-center justify-center group relative overflow-hidden">
                <span id="init-spinner" class="spinner-border spinner-border-sm mr-2 d-none"></span>
                <i class="bi bi-stars mr-2 text-yellow-500 text-xl group-hover:scale-110 transition-transform"></i>
                一键生成
            </button>



            <!-- Buttons Grid -->
            <div class="grid grid-cols-2 gap-4">
                <button onclick="openSettings()"
                    class="clay-btn py-3 flex flex-col items-center justify-center text-sm gap-1 hover:text-blue-500">
                    <i class="bi bi-sliders text-xl text-blue-400"></i> 高级
                </button>
                <button data-bs-toggle="modal" data-bs-target="#settingsModal"
                    class="clay-btn py-3 flex flex-col items-center justify-center text-sm gap-1 hover:text-indigo-500">
                    <i class="bi bi-gear-fill text-xl text-indigo-400"></i> 参数
                </button>
            </div>

            <!-- Management Card -->
            <div
                class="clay-card p-4 !shadow-[inset_5px_5px_10px_#dce1e8,inset_-5px_-5px_10px_#ffffff] !bg-transparent rounded-2xl">
                <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-3 ml-1">方案存档</h3>
                <div class="flex gap-2 mb-3">
                    <input id="save-name" class="clay-input w-full text-sm" placeholder="方案名称...">
                    <button onclick="saveCurrentSchedule()" id="btn-save" disabled
                        class="clay-btn w-10 flex items-center justify-center text-green-500">
                        <i class="bi bi-check-lg"></i>
                    </button>
                </div>
                <div id="saved-list" class="space-y-2 max-h-32 overflow-y-auto pr-1"></div>
            </div>

            <!-- Leave & Sub -->
            <div
                class="clay-card p-4 !shadow-[inset_5px_5px_10px_#dce1e8,inset_-5px_-5px_10px_#ffffff] !bg-transparent rounded-2xl">
                <div onclick="document.querySelector('#leave-panel').classList.toggle('hidden')"
                    class="flex justify-between items-center cursor-pointer mb-2">
                    <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest ml-1">请假与代课</h3>
                    <i class="bi bi-caret-down-fill text-slate-300"></i>
                </div>

                <div id="leave-panel" class="hidden space-y-2">
                    <select id="teacher-select" disabled class="clay-input w-full text-sm p-2"></select>

                    <div class="grid grid-cols-2 gap-2 text-[10px] text-slate-400 font-bold px-1">
                        <span>开始时间</span>
                        <span>结束时间</span>
                    </div>
                    <div class="flex gap-2">
                        <select id="start-day" class="clay-input w-2/3 text-xs p-2">
                            <option value="0">周一</option>
                            <option value="1">周二</option>
                            <option value="2">周三</option>
                            <option value="3">周四</option>
                            <option value="4">周五</option>
                        </select>
                        <select id="start-period" class="clay-input w-1/3 text-xs p-2">
                            <option value="0">1</option>
                            <option value="1">2</option>
                            <option value="2">3</option>
                            <option value="3">4</option>
                            <option value="4">5</option>
                            <option value="5">6</option>
                            <option value="6">7</option>
                            <option value="7">8</option>
                            <option value="8">9</option>
                        </select>
                    </div>
                    <div class="flex gap-2">
                        <select id="end-day" class="clay-input w-2/3 text-xs p-2">
                            <option value="0">周一</option>
                            <option value="1">周二</option>
                            <option value="2">周三</option>
                            <option value="3">周四</option>
                            <option value="4">周五</option>
                        </select>
                        <select id="end-period" class="clay-input w-1/3 text-xs p-2">
                            <option value="0">1</option>
                            <option value="1">2</option>
                            <option value="2">3</option>
                            <option value="3">4</option>
                            <option value="4">5</option>
                            <option value="5">6</option>
                            <option value="6">7</option>
                            <option value="7">8</option>
                            <option value="8">9</option>
                        </select>
                    </div>

                    <button onclick="addLeave()" id="btn-add-leave" disabled
                        class="w-full clay-btn py-2 text-xs text-orange-400 hover:text-orange-500">添加请假条</button>
                    <ul id="leave-list" class="space-y-2"></ul>
                    <button onclick="applySubstitutions()" id="btn-apply" disabled
                        class="w-full clay-btn py-2 text-xs text-purple-500 hover:text-purple-600 font-black mt-2">执行智能代课</button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="px-4 pb-4 space-y-2">

            <a href="/logout"
                class="block w-full text-center clay-btn py-3 text-red-400 hover:text-red-500 text-sm font-bold">
                <i class="bi bi-power mr-1"></i> 退出登录
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full rounded-[2rem] overflow-hidden relative">

        <!-- Mobile Menu Button -->
        <button onclick="toggleSidebar()"
            class="md:hidden absolute top-6 left-4 z-40 text-slate-500 clay-btn p-2 w-10 h-10 flex items-center justify-center">
            <i class="bi bi-list text-xl"></i>
        </button>

        <!-- Header -->
        <header class="h-20 mb-4 flex items-center justify-between px-2 shrink-0 pl-16 md:pl-2">
            <div class="ml-1">
                <h2 id="class-title" class="text-3xl font-black text-slate-700 font-display"> 班级课表 </h2>
            </div>

            <div class="flex items-center gap-4">
                <!-- View Switcher -->
                <div class="clay-card p-1.5 flex gap-2">
                    <button id="btn-view-class" onclick="switchView('class')"
                        class="clay-btn px-4 py-2 text-sm text-blue-500 bg-white">班级视图</button>
                    <button id="btn-view-teacher" onclick="switchView('teacher')" disabled
                        class="clay-btn px-4 py-2 text-sm text-slate-400 hover:text-slate-600">教师视图</button>
                </div>

                <!-- Selectors -->
                <div id="class-selector-group">
                    <select id="class-select" onchange="renderCurrentClass()"
                        class="clay-input py-2.5 px-4 text-sm font-bold text-slate-600 w-[200px]"></select>
                </div>
                <div id="teacher-selector-group" class="hidden">
                    <select id="teacher-view-select" onchange="renderCurrentTeacher()"
                        class="clay-input py-2.5 px-4 text-sm font-bold text-slate-600 w-[200px]"></select>
                </div>

                <div class="flex gap-3 ml-2">
                    <button onclick="performUndo()" id="btn-undo" disabled
                        class="clay-btn w-10 h-10 flex items-center justify-center text-slate-400 hover:text-blue-500"><i
                            class="bi bi-arrow-counterclockwise text-lg"></i></button>
                    <button onclick="performRedo()" id="btn-redo" disabled
                        class="clay-btn w-10 h-10 flex items-center justify-center text-slate-400 hover:text-blue-500"><i
                            class="bi bi-arrow-clockwise text-lg"></i></button>
                    <button onclick="exportCurrentClass()" id="btn-export-current" disabled
                        class="clay-btn w-10 h-10 flex items-center justify-center text-green-500 hover:text-green-600"><i
                            class="bi bi-cloud-download-fill text-lg"></i></button>
                    <button onclick="openStatistics()" id="btn-stats" disabled
                        class="clay-btn w-10 h-10 flex items-center justify-center text-indigo-400 hover:text-indigo-500"><i
                            class="bi bi-bar-chart-line-fill text-lg"></i></button>
                </div>
            </div>
        </header>

        <!-- Schedule Grid -->
        <div class="flex-1 clay-card p-6 overflow-auto custom-scrollbar relative z-10 !rounded-[2.5rem]">
            <div id="error-alert-container"></div>

            <div id="loading-state"
                class="hidden absolute inset-0 flex items-center justify-center bg-white/50 z-50 rounded-[2.5rem] backdrop-blur-sm">
                <div class="spinner-border text-blue-300" style="width: 3rem; height: 3rem;"></div>
            </div>

            <table class="w-full text-center border-separate border-spacing-x-4 border-spacing-y-4">
                <thead>
                    <tr>
                        <th class="w-16"></th>
                        <th class="text-slate-400 font-black uppercase text-sm pb-2">周一</th>
                        <th class="text-slate-400 font-black uppercase text-sm pb-2">周二</th>
                        <th class="text-slate-400 font-black uppercase text-sm pb-2">周三</th>
                        <th class="text-slate-400 font-black uppercase text-sm pb-2">周四</th>
                        <th class="text-slate-400 font-black uppercase text-sm pb-2">周五</th>
                    </tr>
                </thead>
                <tbody id="schedule-body">
                    <tr>
                        <td colspan="6" class="py-20 text-slate-300 font-bold text-xl text-center">准备好排课了吗？
                            <br> 点击 "一键生成" 开始！
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

    </main>

    <!-- Modals (Reused Structure, Clay Styled) -->
    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content !bg-[#eef2f6] border-0 !rounded-[2rem] !shadow-2xl overflow-hidden p-4">
                <div class="modal-header border-0">
                    <h5 class="modal-title font-black text-slate-700">配置参数</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="clay-card p-6 mb-4 !bg-[#fff5f5] flex justify-between items-center">
                        <div>
                            <h6 class="text-red-400 font-bold mb-1 uppercase tracking-wide text-xs">快速配置</h6>
                            <p class="text-xs text-slate-400">上传 Excel 自动填充科目与老师</p>
                        </div>
                        <div class="flex gap-2">
                            <input type="file" id="config-excel-upload" class="hidden" accept=".xlsx, .xls"
                                onchange="handleConfigUpload(this)">
                            <label for="config-excel-upload"
                                class="clay-btn px-4 py-2 text-xs text-red-400 cursor-pointer hover:text-red-500">
                                <i class="bi bi-file-earmark-excel-fill mr-1"></i> 导入配置
                            </label>
                            <a href="/static/template.xlsx" class="clay-btn px-3 py-2 text-xs text-slate-400" download>
                                <i class="bi bi-download"></i>
                            </a>
                        </div>
                    </div>
                    <div class="clay-card p-6 mb-4 !bg-[#ebf8ff]">
                        <h6 class="text-blue-500 font-bold mb-3 uppercase tracking-wide text-xs">核心设置</h6>
                        <div class="row">
                            <label class="col-sm-2 font-bold text-slate-600">班级数量</label>
                            <div class="col-sm-4"><input type="number" id="setting-num-classes"
                                    class="clay-input w-full" value="6"></div>
                        </div>
                    </div>

                    <div class="flex flex-col gap-6">
                        <div>
                            <div class="flex justify-between items-center mb-3 pl-2 pr-2">
                                <h6 class="font-bold text-slate-600 flex items-center gap-2 m-0">
                                    <i class="bi bi-book-half text-blue-400"></i> 科目设置
                                </h6>
                                <span id="total-hours-display"
                                    class="text-xs font-bold px-3 py-1 bg-white rounded-lg text-slate-400 border border-slate-100">
                                    周课时: <span id="current-hours" class="text-blue-500 text-sm">0</span> / 45
                                </span>
                            </div>
                            <div class="clay-card p-4 !shadow-clay-inner h-64 overflow-y-auto">
                                <table class="w-full text-sm text-left border-separate border-spacing-y-2">
                                    <thead>
                                        <tr class="text-slate-400 text-xs font-bold sticky top-0 bg-[#eef2f6] z-10">
                                            <th class="pl-2 pb-2 w-[25%]">科目名称</th>
                                            <th class="pb-2 w-[15%]">每周节数</th>
                                            <th class="pb-2 w-[15%]">类型</th>
                                            <th class="pb-2 w-[35%]">固定老师 (选填)</th>
                                            <th class="text-center pb-2 w-[10%]">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="course-settings-body" class="space-y-2"></tbody>
                                </table>
                            </div>
                            <button
                                class="clay-btn w-full mt-3 py-3 text-xs text-blue-500 font-bold hover:text-blue-600"
                                onclick="addCourseRow()">
                                <i class="bi bi-plus-lg mr-1"></i> 添加科目
                            </button>
                        </div>

                        <div>
                            <h6 class="font-bold text-slate-600 mb-3 pl-2 flex items-center gap-2">
                                <i class="bi bi-building-gear text-green-400"></i> 实验室 / 功能室
                            </h6>
                            <div class="clay-card p-4 !shadow-clay-inner h-64 overflow-y-auto">
                                <table class="w-full text-sm text-left border-separate border-spacing-y-2">
                                    <thead>
                                        <tr class="text-slate-400 text-xs font-bold sticky top-0 bg-[#eef2f6] z-10">
                                            <th class="pl-2 pb-2 w-[30%]">资源名称</th>
                                            <th class="pb-2 w-[15%]">容量(间)</th>
                                            <th class="pb-2 w-[45%]">适用科目 (用逗号分隔)</th>
                                            <th class="text-center pb-2 w-[10%]">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="resource-settings-body" class="space-y-2"></tbody>
                                </table>
                            </div>
                            <button
                                class="clay-btn w-full mt-3 py-3 text-xs text-green-500 font-bold hover:text-green-600"
                                onclick="addResourceRow()">
                                <i class="bi bi-plus-lg mr-1"></i> 添加资源
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button class="clay-btn px-6 py-2" data-bs-dismiss="modal">关闭</button>
                    <button class="clay-btn px-6 py-2 !text-white !bg-blue-400 shadow-none hover:bg-blue-500"
                        data-bs-dismiss="modal" onclick="saveSettingsAndInit()">保存并生成</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Constraint Modal -->
    <div class="modal fade" id="constraintModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content !bg-[#eef2f6] border-0 !rounded-[2rem] p-4">
                <div class="modal-header border-0">
                    <h5 class="modal-title font-black text-slate-700">高级约束</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div <div
                        class="bg-indigo-50 text-indigo-500 p-3 rounded-xl mb-3 text-xs font-bold flex items-start gap-2">
                        <i class="bi bi-exclamation-circle-fill mt-0.5"></i>
                        <div>
                            <p>点击格子标记为 <span class="text-red-400">红色</span> 表示该时段【不排课】。</p>
                            <p class="opacity-70 mt-1">注意：设置完成后，必须点击右下角的“保存并重排”才会生效。</p>
                        </div>
                    </div>

                    <div class="clay-card p-3 mb-4 flex items-center justify-between !bg-white">
                        <div class="flex flex-col">
                            <span class="text-sm font-black text-slate-700">禁止科目连排</span>
                            <span class="text-[10px] text-slate-400 font-bold">同一门课尽量不连续上2节 (如：语文不连上)</span>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input cursor-pointer" type="checkbox" id="check-avoid-consecutive"
                                style="width: 3em; height: 1.5em;">
                        </div>
                    </div>

                    <!-- Mode Switcher -->
                    <div class="flex gap-4 mb-3">
                        <label class="clay-btn px-4 py-2 text-xs cursor-pointer flex-1 text-center">
                            <input type="radio" name="constraint-mode" value="teacher" class="hidden" checked
                                onchange="switchConstraintMode()">
                            <i class="bi bi-person-x-fill mr-1"></i> 教师不排课
                        </label>
                        <label class="clay-btn px-4 py-2 text-xs cursor-pointer flex-1 text-center">
                            <input type="radio" name="constraint-mode" value="fixed" class="hidden"
                                onchange="switchConstraintMode()">
                            <i class="bi bi-pin-angle-fill mr-1"></i> 班级预排课
                        </label>
                    </div>

                    <select id="constraint-teacher-select" class="clay-input w-full mb-4"
                        onchange="renderConstraintGrid()"></select>

                    <select id="constraint-class-select" class="clay-input w-full mb-4 hidden"
                        onchange="renderConstraintGrid()"></select>

                    <div class="clay-card p-4 !shadow-clay-inner flex justify-center">
                        <table class="table-auto border-separate border-spacing-2" id="constraint-grid">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>一</th>
                                    <th>二</th>
                                    <th>三</th>
                                    <th>四</th>
                                    <th>五</th>
                                </tr>
                            </thead>
                            <tbody id="constraint-tbody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer border-0 flex justify-between items-center">
                    <div class="text-xs text-slate-400 font-bold ml-2">
                        <i class="bi bi-info-circle-fill mr-1"></i> 修改后需重新生成生效
                    </div>
                    <div class="flex gap-2">
                        <button class="clay-btn px-4 py-2" data-bs-dismiss="modal">暂存 (不生成)</button>
                        <button onclick="saveConstraintsAndRun()"
                            class="clay-btn px-8 py-3 !text-green-400 !bg-blue-600 hover:!bg-blue-700 shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all text-base font-black tracking-widest">
                            <i class="bi bi-lightning-charge-fill mr-1"></i> 保存并重排
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Modal -->
    <div class="modal fade" id="statisticsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content !bg-[#eef2f6] border-0 !rounded-[2rem] p-4">
                <div class="modal-header border-0">
                    <h5 class="modal-title font-black text-slate-700">数据看板</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="clay-card p-4 h-[400px]"><canvas id="workloadChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content !bg-[#eef2f6] border-0 !rounded-[2rem] p-6 text-center">
                <h5 class="font-black text-slate-700 mb-2">确定删除?</h5>
                <div class="flex justify-center gap-4 mt-4">
                    <button class="clay-btn px-4 py-2" data-bs-dismiss="modal">取消</button>
                    <button class="clay-btn px-4 py-2 !text-red-500" id="btn-confirm-delete">确定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Failure Suggestion Modal -->
    <div class="modal fade" id="failureModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content !bg-[#eef2f6] border-0 !rounded-[2rem] p-6">
                <div class="flex items-center gap-3 mb-4 text-red-500">
                    <i class="bi bi-exclamation-triangle-fill text-2xl"></i>
                    <h5 class="font-black text-slate-700 m-0">排课遇到困难</h5>
                </div>
                <p class="text-sm text-slate-500 font-bold mb-3">AI 建议您尝试调整以下约束：</p>
                <div class="clay-card p-4 !shadow-clay-inner max-h-60 overflow-y-auto mb-4">
                    <ul id="failure-suggestions" class="space-y-2 text-xs text-slate-600 font-bold"></ul>
                </div>
                <div class="flex justify-end">
                    <button class="clay-btn px-6 py-2" data-bs-dismiss="modal">我知道了</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tooltip -->
    <div id="conflict-tooltip"
        class="fixed hidden bg-red-400 text-white px-3 py-2 rounded-xl text-xs font-bold shadow-lg z-50 pointer-events-none">
    </div>

    <!-- Scripts (Same Logic) -->
    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/chart.js"></script>
    <script>
        // ... Logic Reuse ...
        let globalSchedule = {}, deleteModalVar = null, targetDeleteName = '', globalTeachers = [], teacherScheduleMap = {}, historyStack = [], redoStack = [], MAX_HISTORY = 20, currentView = 'class', leaveRequests = [], DAYS = ["周一", "周二", "周三", "周四", "周五"], globalConstraints = { teacher_unavailable: {}, fixed_courses: {} }, currentStats = null, workloadChart = null;
        let currentScheduleId = null;
        let config = {
            num_classes: 6,
            courses: [
                { name: "语文", count: 7, type: "main", teachers: "张伟, 李娜" },
                { name: "数学", count: 7, type: "main", teachers: "王军" },
                { name: "英语", count: 6, type: "main", teachers: "Miss Li" },
                { name: "物理", count: 5, type: "main" },
                { name: "化学", count: 4, type: "main" },
                { name: "生物", count: 3, type: "main" },
                { name: "历史", count: 3, type: "main" },
                { name: "地理", count: 2, type: "main" },
                { name: "政治", count: 2, type: "main" },
                { name: "体育", count: 3, type: "minor" },
                { name: "美术", count: 1, type: "minor" },
                { name: "音乐", count: 1, type: "minor" },
                { name: "信息技术", count: 1, type: "minor" }
            ],
            optimization: {
                golden_time: true,
                avoid_consecutive_subjects: false
            },
            resources: [
                { name: "物理实验室", capacity: 1, subjects: "物理" },
                { name: "化学实验室", capacity: 1, subjects: "化学" },
                { name: "生物实验室", capacity: 1, subjects: "生物" },
                { name: "音乐教室", capacity: 1, subjects: "音乐" },
                { name: "美术教室", capacity: 1, subjects: "美术" },
                { name: "计算机房", capacity: 2, subjects: "信息技术" },
                { name: "大操场", capacity: 4, subjects: "体育" }
            ]
        };

        window.onload = () => {
            setTimeout(() => document.getElementById('splash-screen').style.opacity = 0, 800);
            setTimeout(() => document.getElementById('splash-screen').remove(), 1400);
            checkSession();
            renderSettings(); updateTotalHours(); loadSavedList();
        };

        async function checkSession() {
            try {
                const res = await fetch('/api/list');
                if (res.status === 401 || res.redirected) window.location.href = '/login';
            } catch (e) { console.error("Session check failed"); }
        }

        function toggleSidebar() {
            const s = document.getElementById('main-sidebar');
            s.classList.toggle('-translate-x-full');
        }

        function renderCurrentClass() {
            const cid = document.getElementById('class-select').value; if (!globalSchedule[cid]) return;
            document.getElementById('class-title').innerText = `${cid} 班课表`;
            const tbody = document.getElementById('schedule-body'); tbody.innerHTML = '';
            for (let p = 0; p < 9; p++) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="text-slate-400 font-bold bg-transparent text-xs">第 ${p + 1} 节</td>`;
                for (let d = 0; d < 5; d++) {
                    const td = document.createElement('td');
                    td.dataset.day = d; td.dataset.period = p;
                    td.draggable = true; td.ondragstart = (e) => handleDragStart(e, p, d); td.ondragover = handleDragOver; td.ondrop = (e) => handleDrop(e, p, d); td.ondragend = handleDragEnd;

                    const info = globalSchedule[cid][p][d];
                    td.className = info ? "p-0" : "p-0";
                    const innerDiv = document.createElement('div');
                    innerDiv.className = info ? "schedule-cell mx-auto w-full h-full" : "schedule-cell empty mx-auto w-full h-full";

                    if (info) {
                        let colorClass = info.course_type === 'main' ? 'text-slate-600' : 'text-slate-400';
                        if (info.is_sub) colorClass = info.teacher_name === "【自习】" ? 'text-red-400' : 'text-green-500';

                        // [新增] 尝试匹配教室
                        const roomName = getRoomName(info.subject);

                        innerDiv.innerHTML = `<div class="${colorClass} font-black text-xl tracking-tight">${info.subject}</div>
                                       <div class="text-[10px] text-slate-400 font-bold mt-1 bg-white/50 px-2 rounded-full">${info.teacher_name}</div>
                                       ${roomName ? `<div class="mt-1"><span class="bg-indigo-100 text-indigo-500 text-[9px] px-1.5 py-0.5 rounded uppercase font-bold tracking-wider">${roomName}</span></div>` : ''}`;
                    } else {
                        innerDiv.innerHTML = `<span class="text-slate-300 font-bold text-xs">-</span>`;
                    }
                    td.appendChild(innerDiv);
                    tr.appendChild(td);
                }
                tbody.appendChild(tr);
            }
        }

        let draggedSource = null; const tooltipEl = document.getElementById('conflict-tooltip');

        function handleDragStart(e, p, d) {
            const td = e.target.closest('td');
            const cid = document.getElementById('class-select').value;
            if (!globalSchedule[cid] || !globalSchedule[cid][p] || !globalSchedule[cid][p][d]) { e.preventDefault(); return; }

            const info = globalSchedule[cid][p][d];
            draggedSource = { period: p, day: d, teacher: info ? info.teacher_name : null, teacherId: info ? info.teacher_id : null, element: td };
            e.dataTransfer.effectAllowed = 'move';

            setTimeout(() => { if (td) td.classList.add('opacity-40', 'bg-blue-100'); }, 0);
        }

        function handleDragOver(e) {
            e.preventDefault(); e.dataTransfer.dropEffect = 'move';
            const td = e.target.closest('td'); if (!td) return;

            document.querySelectorAll('.drag-over-active').forEach(el => el.classList.remove('drag-over-active'));
            td.classList.add('drag-over-active');

            const tD = td.dataset.day, tP = td.dataset.period;
            if (draggedSource && draggedSource.teacher) {
                const conflict = teacherScheduleMap[draggedSource.teacher]?.[`${tD}_${tP}`];
                const cid = document.getElementById('class-select').value;
                if (conflict && conflict.classId != cid) {
                    tooltipEl.style.display = 'block'; tooltipEl.style.left = (e.pageX + 10) + 'px'; tooltipEl.style.top = (e.pageY + 10) + 'px';
                    tooltipEl.innerHTML = `<i class="bi bi-exclamation-circle-fill mr-1"></i> 冲突: ${draggedSource.teacher} 在 ${conflict.classId} 班有课`;
                    return;
                }
            }
            tooltipEl.style.display = 'none';
        }

        function handleDragEnd(e) {
            const td = e.target.closest('td'); if (td) td.classList.remove('opacity-40', 'bg-blue-100');
            document.querySelectorAll('td').forEach(el => el.classList.remove('opacity-40', 'bg-blue-100'));
            tooltipEl.style.display = 'none'; draggedSource = null;
        }

        async function handleDrop(e) {
            e.preventDefault();
            const td = e.target.closest('td');

            // 1. 安全检查：如果没有目标或没有拖拽源，直接清理并退出
            if (!td || !draggedSource) {
                handleDragEnd(e);
                return;
            }

            // 2. 关键修复：先获取数据，再清理样式！
            // (如果在清理后再获取，draggedSource 就变成 null 了)
            const tD = parseInt(td.dataset.day);
            const tP = parseInt(td.dataset.period);
            const sD = draggedSource.day;
            const sP = draggedSource.period;

            // 3. 立即清理样式 (移除半透明效果)
            handleDragEnd(e);

            // 4. 如果位置没变，直接返回
            if (sD === tD && sP === tP) return;

            const cid = document.getElementById('class-select').value;

            // 显示加载状态
            document.getElementById('loading-state').classList.remove('hidden');

            pushHistory(); // 记录 Undo

            try {
                const res = await fetch('/api/schedule/move', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        schedule_id: currentScheduleId,
                        class_id: cid,
                        from_slot: [sD, sP],
                        to_slot: [tD, tP]
                    })
                });

                const data = await res.json();

                if (data.status === 'success') {
                    globalSchedule = data.schedule;
                    renderCurrentClass(); // 重新渲染视图
                } else {
                    alert("调课失败: " + data.message);
                    // 如果失败，建议撤销一次历史记录以保持一致
                    historyStack.pop();
                    updateUndoButtons();
                }
            } catch (err) {
                console.error(err);
                alert("网络请求失败");
                historyStack.pop();
                updateUndoButtons();
            } finally {
                document.getElementById('loading-state').classList.add('hidden');
            }
        }

        async function initSystem() {
            document.getElementById('init-spinner').classList.remove('d-none'); document.getElementById('btn-init').disabled = true;
            let tDict = {}, cDict = {}; config.courses.forEach(c => { cDict[c.name] = { count: c.count, type: c.type }; if (c.teachers) tDict[c.name] = c.teachers.split(/[,，\s]+/).filter(n => n) });

            // 1. 获取开关状态
            const avoidConsecutive = document.getElementById('check-avoid-consecutive')?.checked || false;

            // 2. 更新 optimization 配置
            if (!config.optimization) config.optimization = {};
            config.optimization.avoid_consecutive_subjects = avoidConsecutive;

            const payload = { num_classes: config.num_classes, courses: cDict, teacher_names: tDict, resources: config.resources, optimization: config.optimization, constraints: globalConstraints };
            try {
                const res = await fetch('/api/init', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const data = await res.json();
                if (data.status === 'success') { currentScheduleId = data.schedule_id; updateUI(data); }
                else {
                    if (data.suggestions && data.suggestions.length > 0) {
                        const ul = document.getElementById('failure-suggestions');
                        ul.innerHTML = data.suggestions.map(s => `<li class="flex items-start gap-2"><i class="bi bi-lightbulb-fill text-yellow-400 shrink-0 mt-0.5"></i><span>${s}</span></li>`).join('');
                        new bootstrap.Modal(document.getElementById('failureModal')).show();
                    } else {
                        alert(data.message);
                    }
                }
            } catch (e) { console.error(e); } finally { document.getElementById('init-spinner').classList.add('d-none'); document.getElementById('btn-init').disabled = false; }
        }
        function updateUI(data) {
            if (data.stats) {
                currentStats = data.stats;
                document.getElementById('btn-stats').disabled = false;
            }

            // [新增] 渲染评分卡片


            globalTeachers = data.teachers || [];
            globalSchedule = data.schedule;

            teacherScheduleMap = {};
            for (let c in globalSchedule) {
                for (let p in globalSchedule[c]) {
                    for (let d in globalSchedule[c][p]) {
                        const i = globalSchedule[c][p][d];
                        if (i && i.teacher_name) {
                            if (!teacherScheduleMap[i.teacher_name]) teacherScheduleMap[i.teacher_name] = {};
                            teacherScheduleMap[i.teacher_name][`${d}_${p}`] = { classId: c, subject: i.subject };
                        }
                    }
                }
            }

            const ts = document.getElementById('teacher-select'); ts.innerHTML = ''; globalTeachers.forEach(t => ts.add(new Option(t.name, t.name)));
            const cs = document.getElementById('class-select'); cs.innerHTML = ''; Object.keys(globalSchedule).forEach(k => cs.add(new Option(k + " 班", k)));
            const tvs = document.getElementById('teacher-view-select'); tvs.innerHTML = ''; globalTeachers.forEach(t => tvs.add(new Option(t.name, t.name)));
            renderCurrentClass();
            ['btn-add-leave', 'btn-apply', 'btn-save', 'btn-export-current', 'btn-view-teacher', 'btn-undo', 'teacher-select'].forEach(i => document.getElementById(i).disabled = false);
        }
        function switchView(v) {
            currentView = v; document.getElementById('class-selector-group').style.display = v === 'class' ? 'block' : 'none'; document.getElementById('teacher-selector-group').style.display = v === 'teacher' ? 'block' : 'none';
            document.getElementById('btn-view-class').className = v === 'class' ? 'clay-btn px-4 py-2 text-sm text-blue-500 bg-white' : 'clay-btn px-4 py-2 text-sm text-slate-400';
            document.getElementById('btn-view-teacher').className = v === 'teacher' ? 'clay-btn px-4 py-2 text-sm text-blue-500 bg-white' : 'clay-btn px-4 py-2 text-sm text-slate-400';
            if (v === 'class') renderCurrentClass(); else renderCurrentTeacher();
        }

        async function renderCurrentTeacher() {
            const name = document.getElementById('teacher-view-select').value; const res = await fetch('/api/teacher_view', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ schedule_id: currentScheduleId, teacher_name: name }) }); const data = await res.json(); if (data.status === 'success') {
                const tbody = document.getElementById('schedule-body'); tbody.innerHTML = '';
                for (let p = 0; p < 9; p++) {
                    const tr = document.createElement('tr'); tr.innerHTML = `<td class="text-slate-400 font-bold bg-transparent text-xs">第 ${p + 1} 节</td>`;
                    for (let d = 0; d < 5; d++) {
                        const td = document.createElement('td'); const info = data.schedule[p][d];
                        td.className = "p-0";
                        td.innerHTML = `<div class="schedule-cell mx-auto w-full h-full ${info ? '' : 'empty'}">${info ? `<div class="text-blue-500 font-black">${info.class_id} 班</div><div class="text-sm text-slate-400">${info.subject}</div>` : '<span class="text-slate-300">-</span>'}</div>`; tr.appendChild(td);
                    } tbody.appendChild(tr);
                }
                document.getElementById('class-title').innerText = `教师: ${name}`;
            }
        }

        async function loadSavedList() {
            const res = await fetch('/api/list'); const data = await res.json(); document.getElementById('saved-list').innerHTML = data.schedules ? data.schedules.map(s => `
            <div class="clay-btn p-2 flex justify-between items-center mb-2 group hover:bg-white transition-colors">
                <span onclick="loadSchedule('${s.name}')" class="text-xs font-bold truncate flex-1 cursor-pointer text-slate-500 hover:text-blue-500 pl-1">${s.name}</span>
                
                <button onclick="targetDeleteName='${s.name}'; new bootstrap.Modal(document.getElementById('deleteConfirmModal')).show()" 
                        class="w-6 h-6 rounded bg-transparent text-slate-300 hover:bg-red-50 hover:text-red-500 flex items-center justify-center transition-all">
                    <i class="bi bi-trash3 text-xs"></i>
                </button>
            </div>`).join('') : '<div class="text-xs text-slate-400 text-center py-2">暂无存档</div>';
        }
        async function loadSchedule(n) { const res = await fetch(`/api/load/${encodeURIComponent(n)}`); const data = await res.json(); if (data.status === 'success') { currentScheduleId = data.schedule_id; globalSchedule = data.schedule; config = data.config || config; renderSettings(); updateUI(data); } }
        async function saveCurrentSchedule() { const n = document.getElementById('save-name').value; await fetch('/api/save', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ schedule_id: currentScheduleId, name: n, config }) }); document.getElementById('save-name').value = ''; loadSavedList(); }

        function openSettings() {
            const m = new bootstrap.Modal(document.getElementById('constraintModal'));

            // 1. 打开时只填充一次下拉列表，避免 onchange 时被重置
            const t = document.getElementById('constraint-teacher-select');
            t.innerHTML = '<option value="">选择教师...</option>';
            globalTeachers.sort((a, b) => a.name.localeCompare(b.name)).forEach(x => {
                t.add(new Option(x.name, x.name));
            });

            // 填充班级列表
            const c = document.getElementById('constraint-class-select');
            c.innerHTML = '<option value="">选择班级...</option>';
            // 如果还没排课，config.num_classes可能有值，用它生成
            const numC = config.num_classes || 0;
            if (numC > 0) {
                for (let i = 1; i <= numC; i++) c.add(new Option(`${i} 班`, `${i}`));
            } else {
                // 有可能用中文名
                Object.keys(globalSchedule).forEach(k => c.add(new Option(`${k} 班`, k)));
            }

            // 重置模式
            document.querySelector('input[name="constraint-mode"][value="teacher"]').checked = true;
            switchConstraintMode();

            // 2. 初始化开关状态 (读取当前配置，如果没有则默认为 false)
            const isAvoid = config.optimization && config.optimization.avoid_consecutive_subjects === true;
            document.getElementById('check-avoid-consecutive').checked = isAvoid;

            // 3. 渲染一个初始的空格子（或者清空）
            renderConstraintGrid();

            m.show();
        }
        function switchConstraintMode() {
            const mode = document.querySelector('input[name="constraint-mode"]:checked').value;
            const tSel = document.getElementById('constraint-teacher-select');
            const cSel = document.getElementById('constraint-class-select');

            // 样式更新
            document.querySelectorAll('input[name="constraint-mode"]').forEach(el => {
                const label = el.parentElement;
                if (el.checked) {
                    label.classList.add('bg-blue-100', 'text-blue-600', 'font-bold');
                } else {
                    label.classList.remove('bg-blue-100', 'text-blue-600', 'font-bold');
                }
            });

            if (mode === 'teacher') {
                tSel.classList.remove('hidden');
                cSel.classList.add('hidden');
            } else {
                tSel.classList.add('hidden');
                cSel.classList.remove('hidden');
            }
            renderConstraintGrid();
        }

        function renderConstraintGrid() {
            const mode = document.querySelector('input[name="constraint-mode"]:checked').value;
            const tb = document.getElementById('constraint-tbody');
            tb.innerHTML = '';

            let currentData = null;
            let currentTarget = null;

            if (mode === 'teacher') {
                currentTarget = document.getElementById('constraint-teacher-select').value;
                currentData = (currentTarget && globalConstraints.teacher_unavailable[currentTarget]) ? globalConstraints.teacher_unavailable[currentTarget] : [];
            } else {
                currentTarget = document.getElementById('constraint-class-select').value;
                if (!globalConstraints.fixed_courses) globalConstraints.fixed_courses = {};
                currentData = (currentTarget && globalConstraints.fixed_courses[currentTarget]) ? globalConstraints.fixed_courses[currentTarget] : {};
            }

            for (let p = 0; p < 9; p++) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<th class="text-slate-300 text-[10px] pr-2 align-middle">${p + 1}</th>`;

                for (let d = 0; d < 5; d++) {
                    const td = document.createElement('td');
                    td.className = "rounded-lg hover:bg-slate-100 cursor-pointer p-2 relative transition-colors";

                    if (mode === 'teacher') {
                        // 教师不排课模式
                        const isRestricted = Array.isArray(currentData) && currentData.some(c => c[0] === d && c[1] === p);
                        const dotClass = isRestricted ? "bg-red-400 w-4 h-4 shadow-md" : "bg-slate-200 w-2 h-2";
                        td.innerHTML = `<div class="${dotClass} rounded-full mx-auto transition-all duration-200"></div>`;
                        td.onclick = () => toggleTeacherConstraint(d, p, td);
                    } else {
                        // 班级预排模式
                        const fixedSubj = currentData[`${d}_${p}`];
                        if (fixedSubj) {
                            td.innerHTML = `<div class="bg-blue-100 text-blue-600 text-[10px] font-bold px-1 py-1 rounded text-center truncate shadow-sm">${fixedSubj}</div>`;
                        } else {
                            td.innerHTML = `<div class="w-2 h-2 rounded-full bg-slate-200 mx-auto"></div>`;
                        }
                        td.onclick = () => toggleFixedConstraint(d, p, td);
                    }
                    tr.appendChild(td);
                }
                tb.appendChild(tr);
            }
        }

        function toggleTeacherConstraint(d, p, td) {
            const t = document.getElementById('constraint-teacher-select').value;
            if (!t) return alert("请先选择一位老师");

            if (!globalConstraints.teacher_unavailable[t]) globalConstraints.teacher_unavailable[t] = [];
            const idx = globalConstraints.teacher_unavailable[t].findIndex(u => u[0] == d && u[1] == p);

            if (idx >= 0) {
                globalConstraints.teacher_unavailable[t].splice(idx, 1);
            } else {
                globalConstraints.teacher_unavailable[t].push([d, p]);
            }
            renderConstraintGrid();
        }

        function toggleFixedConstraint(d, p, td) {
            const c = document.getElementById('constraint-class-select').value;
            if (!c) return alert("请先选择一个班级");

            if (!globalConstraints.fixed_courses[c]) globalConstraints.fixed_courses[c] = {};

            const currentSubj = globalConstraints.fixed_courses[c][`${d}_${p}`];

            if (currentSubj) {
                // 已有 -> 清除
                delete globalConstraints.fixed_courses[c][`${d}_${p}`];
                renderConstraintGrid();
            } else {
                // 没有 -> 选择
                // 收集所有可选课程
                const subjects = config.courses.map(x => x.name);
                // 简单起见，使用 prompt
                // 更高级的做法是弹出一个小的 popover，但这需要写更多 DOM
                const input = prompt(`请输入 [ ${c} 班 - ${DAYS[d]} 第${p + 1}节 ] 固定要上的科目名称：\n(可选: ${subjects.join(', ')})`);
                if (input) {
                    const trimmed = input.trim();
                    // 验证一下
                    if (subjects.includes(trimmed)) {
                        globalConstraints.fixed_courses[c][`${d}_${p}`] = trimmed;
                        renderConstraintGrid();
                    } else {
                        alert("科目不存在，请检查输入 (必须完全匹配参数设置中的科目名)");
                    }
                }
            }
        }

        function saveConstraintsAndRun() {
            // 1. 关闭模态框
            const modalEl = document.getElementById('constraintModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();

            // 2. 给用户一点反馈，防止误触
            // 简单的确认逻辑，因为重排会覆盖当前课表
            if (confirm("应用新约束并重新生成课表？\n(注意：当前未保存的课表变动将会丢失)")) {
                // 3. 调用核心排课函数
                initSystem();
            } else {
                // 如果用户点了取消，重新把模态框打开（可选，为了体验更好）
                modal.show();
            }
        }

        function getRoomName(subject) {
            // 简单匹配：遍历资源列表，看谁的 subjects 包含了这个科目
            // config.resources structure: [{name: 'Lab', capacity: 1, subjects: 'Physics, Science'}]
            if (!config.resources) return null;

            // 缓存一下 Map 可能会性能更好，但这里数据量小，直接遍历也无妨
            for (let r of config.resources) {
                if (r.subjects) {
                    // 支持中英文逗号
                    const subjs = r.subjects.split(/[,，]/).map(s => s.trim());
                    if (subjs.includes(subject)) {
                        return r.name;
                    }
                }
            }
            return null;
        }

        function addResourceRow(n = "", c = 1, s = "") {
            // 统一的删除按钮样式
            const deleteBtn = `
                <button class="w-8 h-8 rounded-lg bg-white border border-red-100 text-red-400 hover:bg-red-50 hover:border-red-200 hover:text-red-500 flex items-center justify-center transition-all shadow-sm mx-auto" 
                        onclick="this.closest('tr').remove()">
                    <i class="bi bi-trash3"></i>
                </button>`;

            const html = `
            <tr>
                <td class="pr-2"><input class="clay-input w-full py-2 px-3 text-sm border-0 course-name" value="${n}" placeholder="资源名"></td>
                <td class="pr-2"><input type="number" class="clay-input w-full py-2 px-3 text-sm border-0 course-capacity" value="${c}" min="1"></td>
                <td class="pr-2"><input class="clay-input w-full py-2 px-3 text-sm border-0 course-subjects" value="${s}" placeholder="适用科目"></td>
                <td class="text-center">${deleteBtn}</td>
            </tr>`;
            document.getElementById('resource-settings-body').insertAdjacentHTML('beforeend', html);
        }
        function addCourseRow(n = "", c = 2, t = "main", ts = "") {
            // 统一的删除按钮样式
            const deleteBtn = `
                <button class="w-8 h-8 rounded-lg bg-white border border-red-100 text-red-400 hover:bg-red-50 hover:border-red-200 hover:text-red-500 flex items-center justify-center transition-all shadow-sm mx-auto" 
                        onclick="this.closest('tr').remove(); updateTotalHours()">
                    <i class="bi bi-trash3"></i>
                </button>`;

            const html = `
            <tr>
                <td class="pr-2"><input class="clay-input w-full py-2 px-3 text-sm border-0 course-name" value="${n}" placeholder="科目名"></td>
                <td class="pr-2"><input type="number" class="clay-input w-full py-2 px-3 text-sm border-0 course-count" value="${c}" onchange="updateTotalHours()" oninput="updateTotalHours()"></td>
                <td class="pr-2">
                    <select class="clay-input w-full py-2 px-3 text-sm border-0 course-type">
                        <option value="main" ${t === 'main' ? 'selected' : ''}>主课</option>
                        <option value="minor" ${t === 'minor' ? 'selected' : ''}>副课</option>
                    </select>
                </td>
                <td class="pr-2"><input class="clay-input w-full py-2 px-3 text-sm border-0 course-teachers text-xs" value="${ts}" placeholder="张三, 李四"></td>
                <td class="text-center">${deleteBtn}</td>
            </tr>`;

            document.getElementById('course-settings-body').insertAdjacentHTML('beforeend', html);
            updateTotalHours(); // 添加行后立即重新计算
        }

        function updateTotalHours() {
            let t = 0;
            // 遍历所有科目数量输入框
            document.querySelectorAll('.course-count').forEach(i => t += parseInt(i.value) || 0);

            // 更新界面显示
            const displayEl = document.getElementById('current-hours');
            const containerEl = document.getElementById('total-hours-display');

            if (displayEl) {
                displayEl.innerText = t;
                // 简单的超限预警逻辑 (假设一周5天*9节 = 45节)
                if (t > 45) {
                    displayEl.className = "text-red-500 text-lg font-black"; // 超限变红变大
                    containerEl.classList.add("!border-red-200", "!bg-red-50");
                } else {
                    displayEl.className = "text-blue-500 text-sm";
                    containerEl.classList.remove("!border-red-200", "!bg-red-50");
                }
            }
        }
        function renderSettings() {
            document.getElementById('setting-num-classes').value = config.num_classes;

            // 更新：传递 subjects 参数 (r.subjects)
            document.getElementById('resource-settings-body').innerHTML = '';
            (config.resources || []).forEach(r => addResourceRow(r.name, r.capacity, r.subjects));

            document.getElementById('course-settings-body').innerHTML = '';
            config.courses.forEach(c => addCourseRow(c.name, c.count, c.type, c.teachers));
        }
        function saveSettingsAndInit() {
            config.num_classes = parseInt(document.getElementById('setting-num-classes').value);

            // 保存科目设置
            let nc = [], td = {};
            document.querySelectorAll('#course-settings-body tr').forEach(r => {
                const n = r.querySelector('.course-name').value;
                const c = parseInt(r.querySelector('.course-count').value);
                if (n && c > 0) {
                    nc.push({
                        name: n,
                        count: c,
                        type: r.querySelector('.course-type').value,
                        teachers: r.querySelector('.course-teachers').value
                    });
                    if (r.querySelector('.course-teachers').value) {
                        td[n] = r.querySelector('.course-teachers').value.split(/[,，\s]+/).filter(x => x);
                    }
                }
            });
            config.courses = nc;
            config.teacher_names = td;

            // === 更新：保存资源设置 (包含适用科目) ===
            let nr = [];
            document.querySelectorAll('#resource-settings-body tr').forEach(r => {
                const n = r.querySelector('.course-name').value;
                const cap = parseInt(r.querySelector('.course-capacity').value);
                const subj = r.querySelector('.course-subjects').value; // 获取适用科目

                if (n) {
                    nr.push({
                        name: n,
                        capacity: cap || 1,
                        subjects: subj // 保存为字符串，后端 normal.py 会处理逗号分割
                    });
                }
            });
            config.resources = nr;

            initSystem();
        }
        async function handleConfigUpload(input) {
            if (!input.files || !input.files[0]) return;
            const formData = new FormData(); formData.append('file', input.files[0]);
            try {
                const res = await fetch('/api/import_config', { method: 'POST', body: formData });
                const data = await res.json();
                if (data.status === 'success') {
                    let newCourses = [];
                    for (let [name, info] of Object.entries(data.courses)) { newCourses.push({ name: name, count: info.count, type: info.type, teachers: info.teachers.join(', ') }); }
                    config.courses = newCourses; config.resources = data.resources; renderSettings(); alert(data.message);
                } else { alert(data.message); }
            } catch (e) { alert("上传失败"); }
            input.value = '';
        }

        async function performUndo() {
            if (historyStack.length) {
                redoStack.push(JSON.parse(JSON.stringify(globalSchedule)));
                const prevSchedule = historyStack.pop();
                try {
                    const res = await fetch('/api/restore', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ schedule_id: currentScheduleId, schedule: prevSchedule }) });
                    const data = await res.json();
                    if (data.status === 'success') {
                        globalSchedule = prevSchedule; updateUndoButtons();
                        if (currentView === 'class') renderCurrentClass(); else renderCurrentTeacher();
                    }
                    else { alert("撤销失败: " + data.message); historyStack.push(prevSchedule); redoStack.pop(); }
                } catch (e) { console.error(e); alert("同步服务器失败"); }
            }
        }
        async function performRedo() {
            if (redoStack.length) {
                historyStack.push(JSON.parse(JSON.stringify(globalSchedule)));
                const nextSchedule = redoStack.pop();
                try {
                    await fetch('/api/restore', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ schedule_id: currentScheduleId, schedule: nextSchedule }) });
                    globalSchedule = nextSchedule; updateUndoButtons();
                    if (currentView === 'class') renderCurrentClass(); else renderCurrentTeacher();
                } catch (e) { console.error(e); }
            }
        }
        function pushHistory() { if (Object.keys(globalSchedule).length) { historyStack.push(JSON.parse(JSON.stringify(globalSchedule))); if (historyStack.length > MAX_HISTORY) historyStack.shift(); redoStack = []; updateUndoButtons(); } }
        function updateUndoButtons() { document.getElementById('btn-undo').disabled = !historyStack.length; document.getElementById('btn-redo').disabled = !redoStack.length; }
        function exportCurrentClass() {
            if (currentView === 'class') {
                const c = document.getElementById('class-select').value; if (c) window.location.href = `/api/export/class/${c}?schedule_id=${currentScheduleId}`;
            } else {
                const t = document.getElementById('teacher-view-select').value; if (t) window.location.href = `/api/export/teacher/${encodeURIComponent(t)}?schedule_id=${currentScheduleId}`;
            }
        }
        function exportAllClasses() {
            window.location.href = `/api/export/all_classes?schedule_id=${currentScheduleId}`;
        }

        function openStatistics() {
            new bootstrap.Modal(document.getElementById('statisticsModal')).show(); setTimeout(() => {
                const ctx = document.getElementById('workloadChart').getContext('2d'); if (workloadChart) workloadChart.destroy();
                const lb = Object.keys(currentStats).sort(); workloadChart = new Chart(ctx, { type: 'bar', data: { labels: lb, datasets: [{ label: 'Hours', data: lb.map(n => currentStats[n].total), backgroundColor: '#63b3ed', borderRadius: 20 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { display: false } }, x: { grid: { display: false } } } } });
            }, 300);
        }
        document.getElementById('btn-confirm-delete').onclick = async () => { await fetch('/api/delete', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: targetDeleteName }) }); bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide(); loadSavedList(); }
        function addLeave() {
            const n = document.getElementById('teacher-select').value;
            // 获取下拉框的数值 (0-4 代表周一到周五, 0-8 代表第1-9节)
            const sd = parseInt(document.getElementById('start-day').value);
            const sp = parseInt(document.getElementById('start-period').value);
            const ed = parseInt(document.getElementById('end-day').value);
            const ep = parseInt(document.getElementById('end-period').value);

            if (n) {
                // 推送新格式的数据结构
                leaveRequests.push({
                    name: n,
                    start: { day: sd, period: sp },
                    end: { day: ed, period: ep }
                });
                renderLeaveList();
            }
        }
        function renderLeaveList() {
            const dayText = ["周一", "周二", "周三", "周四", "周五"];

            document.getElementById('leave-list').innerHTML = leaveRequests.map((r, i) => {
                // 格式化显示文本，例如：周一第1节 - 周一第2节
                const startText = `${dayText[r.start.day]}第${r.start.period + 1}节`;
                const endText = `${dayText[r.end.day]}第${r.end.period + 1}节`;

                return `
                <li class="flex justify-between items-center text-xs bg-white p-2 rounded-xl border border-slate-100 shadow-sm mb-2">
                    <div class="flex flex-col">
                        <span class="font-bold text-slate-600">${r.name}</span>
                        <span class="scale-90 origin-left text-slate-400 font-mono">${startText} -> ${endText}</span>
                    </div>
                    <button onclick="leaveRequests.splice(${i},1);renderLeaveList()" 
                            class="w-7 h-7 rounded-lg bg-red-50 text-red-400 hover:bg-red-500 hover:text-white flex items-center justify-center transition-all">
                        <i class="bi bi-trash3"></i>
                    </button>
                </li>`;
            }).join('');
        }
        function applySubstitutions() {
            const btn = document.getElementById('btn-apply');
            // 防止重复点击
            btn.disabled = true;
            const originalText = btn.innerText;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 计算中...';

            fetch('/api/substitute', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ schedule_id: currentScheduleId, leaves: leaveRequests })
            })
                .then(r => r.json())
                .then(d => {
                    if (d.status === 'success') {
                        globalSchedule = d.schedule;
                        updateUI(d); // 更新界面数据

                        // === 核心修复：构建成功反馈弹窗 ===
                        const stats = d.stats || { direct: 0, swap: 0, self_study: 0 };

                        // 1. 生成统计 HTML
                        let resultHtml = `
                <div class="flex gap-2 mb-4">
                    <div class="bg-green-100 text-green-700 px-3 py-2 rounded-xl text-xs font-bold flex-1 text-center shadow-sm">
                        <div class="text-[10px] opacity-60 uppercase">直接代课</div>
                        <div class="text-lg">${stats.direct}</div>
                    </div>
                    <div class="bg-blue-100 text-blue-700 px-3 py-2 rounded-xl text-xs font-bold flex-1 text-center shadow-sm">
                        <div class="text-[10px] opacity-60 uppercase">课程互换</div>
                        <div class="text-lg">${stats.swap}</div>
                    </div>
                    <div class="bg-red-100 text-red-700 px-3 py-2 rounded-xl text-xs font-bold flex-1 text-center shadow-sm">
                        <div class="text-[10px] opacity-60 uppercase">自习</div>
                        <div class="text-lg">${stats.self_study}</div>
                    </div>
                </div>
            `;

                        // 2. 生成详细日志列表
                        if (d.logs && d.logs.length > 0) {
                            resultHtml += '<div class="text-xs font-bold text-slate-400 mb-2 pl-1">调整明细：</div>';
                            resultHtml += '<ul class="space-y-2 text-xs font-bold text-slate-600 max-h-60 overflow-y-auto pr-1 custom-scrollbar">';
                            d.logs.forEach(log => {
                                const icon = log.type === 'self_study'
                                    ? '<i class="bi bi-x-circle-fill text-red-400 text-lg"></i>'
                                    : '<i class="bi bi-check-circle-fill text-green-500 text-lg"></i>';
                                const bgClass = log.type === 'self_study' ? 'bg-red-50 border-red-100' : 'bg-green-50 border-green-100';

                                resultHtml += `
                        <li class="flex items-center gap-3 ${bgClass} p-3 rounded-xl border">
                            ${icon} 
                            <span>${log.message}</span>
                        </li>`;
                            });
                            resultHtml += '</ul>';
                        } else {
                            resultHtml += '<div class="text-center text-slate-400 text-xs py-8 bg-slate-50 rounded-xl border border-dashed border-slate-200">没有发现需要调整的课程</div>';
                        }

                        // 3. 操作模态框 DOM
                        const modalEl = document.getElementById('failureModal');

                        // 修改标题区域样式（变成绿色）
                        const headerIcon = modalEl.querySelector('.bi-exclamation-triangle-fill');
                        if (headerIcon) {
                            headerIcon.className = "bi bi-check-circle-fill text-2xl text-green-500";
                        }

                        const headerTitle = modalEl.querySelector('h5');
                        if (headerTitle) {
                            headerTitle.innerText = "智能代课执行成功";
                            headerTitle.parentElement.className = "flex items-center gap-3 mb-4 text-green-500";
                        }

                        const headerSub = modalEl.querySelector('p.text-sm');
                        if (headerSub) headerSub.innerText = "系统已自动完成以下课程调整：";

                        // 填充内容
                        const contentBox = modalEl.querySelector('.clay-card');
                        contentBox.innerHTML = resultHtml;

                        // 显示模态框
                        new bootstrap.Modal(modalEl).show();

                    } else {
                        alert("代课计算出错: " + d.message);
                    }
                })
                .catch(e => {
                    console.error(e);
                    alert("请求失败，请检查网络或控制台日志");
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                });
        }
    </script>
</body>

</html>