<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨è‡ªå®šä¹‰æ™ºèƒ½æ’è¯¾ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.98);
            height: 100vh;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow-y: auto;
        }

        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 3px;
        }

        .main-content {
            padding: 20px;
            height: 100vh;
            overflow-y: auto;
        }

        /* å¡ç‰‡åŒºå—æ ·å¼ */
        .section-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .section-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }

        .section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title::before {
            content: '';
            width: 3px;
            height: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
        }

        /* ä¸»æ ‡é¢˜ä¼˜åŒ– */
        h4.text-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700 !important;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
        }

        .btn-outline-primary {
            border: 2px solid #667eea;
            color: #667eea;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-outline-primary:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            border: none;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(17, 153, 142, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(17, 153, 142, 0.4);
        }

        .btn-outline-success {
            border: 2px solid #11998e;
            color: #11998e;
            font-weight: 500;
        }

        .btn-outline-success:hover {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: none;
        }

        .btn-outline-info {
            border: 2px solid #4facfe;
            color: #4facfe;
        }

        .btn-outline-info:hover,
        .btn-outline-info.active {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-color: #4facfe;
            color: white;
        }

        /* ä¸»å†…å®¹å¡ç‰‡ */
        .timetable-card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            padding: 24px;
        }

        /* è¯¾è¡¨æ ·å¼ */
        .schedule-table {
            border-collapse: separate;
            border-spacing: 0;
            overflow: hidden;
            border-radius: 12px;
        }

        .schedule-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            vertical-align: middle;
            padding: 14px;
            font-weight: 600;
            font-size: 0.9rem;
            border: none;
        }

        .schedule-table td {
            text-align: center;
            vertical-align: middle;
            height: 85px;
            width: 18%;
            border: 1px solid #e9ecef;
            background: white;
            transition: all 0.2s ease;
        }

        .schedule-table td:hover {
            background-color: #f8f9fa;
        }

        .course-cell {
            font-size: 0.95rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .teacher-name {
            font-size: 0.8rem;
            color: #718096;
            display: block;
        }

        .status-sub {
            background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%) !important;
            border-left: 4px solid #ffc107;
        }

        .status-empty {
            background: linear-gradient(135deg, #fee 0%, #f8d7da 100%) !important;
            border-left: 4px solid #dc3545;
        }

        /* çŠ¶æ€æ ‡ç­¾ */
        .text-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .text-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .text-info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* è¾“å…¥æ¡†ä¼˜åŒ– */
        .form-control:focus,
        .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
        }

        /* æ‹–æ‹½ç›¸å…³æ ·å¼ */
        .draggable-cell {
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .draggable-cell:active {
            cursor: grabbing;
        }

        .drag-source {
            opacity: 0.5;
            transform: scale(0.95);
            background-color: #e9ecef !important;
            border: 2px dashed #adb5bd !important;
        }

        .drag-over {
            background-color: #e3f2fd !important;
            border: 2px dashed #2196f3 !important;
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.2);
            z-index: 1;
        }

        /* ç½‘æ ¼äº¤äº’æ ·å¼ */
        .constraint-cell {
            cursor: pointer;
            transition: all 0.2s;
        }

        .constraint-cell:hover {
            background-color: #f8f9fa;
        }

        .constraint-cell.unavailable {
            background-color: #ff4d4d;
            color: white;
            box-shadow: inset 0 0 0 1px #e03e3e;
        }

        /* åˆ—è¡¨é¡¹ä¼˜åŒ– */
        .list-group-item {
            border-radius: 8px !important;
            margin-bottom: 8px;
            border: 1px solid #e9ecef;
            transition: all 0.2s ease;
        }

        .list-group-item:hover {
            background-color: #f8f9fa;
            border-color: #667eea;
            transform: translateX(4px);
        }

        /* é”™è¯¯æç¤º */
        .alert {
            border-radius: 12px;
            border: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .alert-warning {
            background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%);
        }

        .alert-danger {
            background: linear-gradient(135deg, #fee 0%, #f8d7da 100%);
        }

        /* è§†å›¾åˆ‡æ¢æŒ‰é’® */
        .btn-outline-primary.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        /* åŠ¨ç”» */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }
    </style>
</head>

<body>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3 sidebar">
                <h4 class="mb-4 text-primary fw-bold">ğŸ“… æ™ºèƒ½æ’è¯¾ç³»ç»Ÿ</h4>

                <div class="d-flex gap-2 mb-4">
                    <button id="btn-init" class="btn btn-primary flex-grow-1 py-2 shadow-sm"
                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;"
                        onclick="initSystem()">
                        <span id="init-spinner" class="spinner-border spinner-border-sm d-none"></span>
                        ğŸš€ ç”Ÿæˆ/é‡ç½®
                    </button>
                    <button class="btn btn-light shadow-sm" onclick="openSettings()" title="é«˜çº§çº¦æŸè®¾ç½®"
                        style="width: 42px;">
                        âš™ï¸
                    </button>
                    <button class="btn btn-light shadow-sm" data-bs-toggle="modal" data-bs-target="#settingsModal"
                        title="åŸºæœ¬å‚æ•°è®¾ç½®" style="width: 42px;">
                        ğŸ“
                    </button>
                </div>
                <button id="btn-stats" class="btn btn-outline-primary w-100 mb-3 shadow-sm" onclick="openStatistics()"
                    disabled>
                    ğŸ“Š æŸ¥çœ‹ç»Ÿè®¡çœ‹æ¿
                </button>
                <div id="system-status" class="text-center text-muted small mb-3">ç³»ç»Ÿæœªåˆå§‹åŒ–</div>

                <!-- é”™è¯¯æç¤ºå®¹å™¨ -->
                <div id="error-alert-container"></div>

                <hr>
                <h5 class="mb-3">ğŸ’¾ è¯¾è¡¨æ–¹æ¡ˆç®¡ç†</h5>
                <div class="mb-3">
                    <div class="input-group input-group-sm mb-2">
                        <input type="text" id="save-name" class="form-control" placeholder="è¾“å…¥æ–¹æ¡ˆåç§°">
                        <button class="btn btn-outline-success" onclick="saveCurrentSchedule()" id="btn-save"
                            disabled>ä¿å­˜</button>
                    </div>
                    <div class="small text-muted mb-2">å·²ä¿å­˜çš„æ–¹æ¡ˆï¼š</div>
                    <div id="saved-list" class="list-group list-group-flush small"
                        style="max-height: 150px; overflow-y: auto;">
                        <div class="text-center text-muted py-2">æš‚æ— ä¿å­˜æ–¹æ¡ˆ</div>
                    </div>
                </div>

                <hr>
                <h5 class="mb-3">ğŸ“ è¯·å‡ç®¡ç†</h5>
                <div class="mb-3">
                    <label>é€‰æ‹©è€å¸ˆ</label>
                    <select id="teacher-select" class="form-select" disabled></select>
                </div>
                <div class="mb-3">
                    <label>æ—¶é—´èŒƒå›´</label>
                    <div class="d-flex gap-2">
                        <select id="start-day" class="form-select">
                            <option>å‘¨ä¸€</option>
                            <option>å‘¨äºŒ</option>
                            <option>å‘¨ä¸‰</option>
                            <option>å‘¨å››</option>
                            <option>å‘¨äº”</option>
                        </select>
                        <select id="end-day" class="form-select">
                            <option>å‘¨ä¸€</option>
                            <option>å‘¨äºŒ</option>
                            <option>å‘¨ä¸‰</option>
                            <option>å‘¨å››</option>
                            <option>å‘¨äº”</option>
                        </select>
                    </div>
                </div>
                <button id="btn-add-leave" class="btn btn-outline-secondary w-100 mb-2" onclick="addLeave()" disabled>+
                    æ·»åŠ è¯·å‡æ¡</button>
                <ul id="leave-list" class="list-group small mb-3"></ul>
                <button id="btn-apply" class="btn btn-success w-100" onclick="applySubstitutions()" disabled>ğŸ”„
                    æ‰§è¡Œæ™ºèƒ½ä»£è¯¾</button>

                <!-- æ–°å¢ï¼šä»£è¯¾æ—¥å¿—åŒºåŸŸ -->
                <div id="substitution-logs-container" style="display: none;">
                    <hr>
                    <h5 class="mb-3">ğŸ“Š ä»£è¯¾æ—¥å¿—</h5>

                    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                    <div id="sub-stats" class="mb-3 p-2"
                        style="background: #f8f9fa; border-radius: 8px; font-size: 0.85rem;">
                        <div><strong>ç›´æ¥ä»£è¯¾ï¼š</strong><span id="stat-direct">0</span>æ¬¡</div>
                        <div><strong>è¯¾ç¨‹äº’æ¢ï¼š</strong><span id="stat-swap" class="text-info">0</span>æ¬¡</div>
                        <div><strong>æ ‡è®°è‡ªä¹ ï¼š</strong><span id="stat-self">0</span>æ¬¡</div>
                        <div class="mt-1"><strong>æ€»æ‰°åŠ¨åº¦ï¼š</strong><span id="stat-score">0</span>åˆ†</div>
                    </div>

                    <!-- è¯¦ç»†æ—¥å¿— -->
                    <div class="small text-muted mb-1">è¯¦ç»†æ—¥å¿—ï¼š</div>
                    <div id="sub-logs" class="small"
                        style="max-height: 200px; overflow-y: auto; background: #f8f9fa; border-radius: 8px; padding: 8px;">
                        <div class="text-muted text-center">æš‚æ— æ—¥å¿—</div>
                    </div>
                </div>
            </div>

            <div class="col-md-9 main-content">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="d-flex align-items-center gap-2">
                        <h3 id="class-title" class="mb-0">ç­çº§è¯¾è¡¨</h3>
                        <!-- è§†å›¾åˆ‡æ¢æŒ‰é’® -->
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary active" id="btn-view-class"
                                onclick="switchView('class')">
                                ğŸ“š ç­çº§è§†å›¾
                            </button>
                            <button class="btn btn-outline-info" id="btn-view-teacher" onclick="switchView('teacher')"
                                disabled>
                                ğŸ‘¨â€ğŸ« è€å¸ˆè§†å›¾
                            </button>
                        </div>
                    </div>

                    <div class="d-flex align-items-center gap-2">
                        <!-- ç­çº§é€‰æ‹©å™¨ï¼ˆé»˜è®¤æ˜¾ç¤ºï¼‰ -->
                        <div id="class-selector-group" class="d-flex align-items-center gap-2">
                            <label>æŸ¥çœ‹ç­çº§ï¼š</label>
                            <select id="class-select" class="form-select w-auto"
                                onchange="renderCurrentClass()"></select>
                        </div>

                        <!-- è€å¸ˆé€‰æ‹©å™¨ï¼ˆé»˜è®¤éšè—ï¼‰ -->
                        <div id="teacher-selector-group" class="d-flex align-items-center gap-2" style="display: none;">
                            <label>æŸ¥çœ‹è€å¸ˆï¼š</label>
                            <select id="teacher-view-select" class="form-select w-auto"
                                onchange="renderCurrentTeacher()"></select>
                        </div>

                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-success" onclick="exportCurrentClass()"
                                id="btn-export-current" disabled title="å¯¼å‡ºå½“å‰ç­çº§">
                                ğŸ“¥ å¯¼å‡ºæœ¬ç­
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="exportAllClasses()"
                                id="btn-export-all" disabled title="å¯¼å‡ºæ‰€æœ‰ç­çº§">
                                ğŸ“¦ å¯¼å‡ºå…¨éƒ¨
                            </button>
                        </div>
                    </div>
                </div>
                <div class="timetable-card">
                    <table class="table table-bordered schedule-table mb-0">
                        <thead>
                            <tr>
                                <th style="width:80px">èŠ‚æ¬¡</th>
                                <th>å‘¨ä¸€</th>
                                <th>å‘¨äºŒ</th>
                                <th>å‘¨ä¸‰</th>
                                <th>å‘¨å››</th>
                                <th>å‘¨äº”</th>
                            </tr>
                        </thead>
                        <tbody id="schedule-body">
                            <tr>
                                <td colspan="6" class="text-center py-5">è¯·å…ˆç”Ÿæˆè¯¾è¡¨</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">âš™ï¸ å…¨å±€æ’è¯¾å‚æ•°è®¾ç½®</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3 row">
                        <label class="col-sm-2 col-form-label">ç­çº§æ€»æ•°</label>
                        <div class="col-sm-4">
                            <input type="number" id="setting-num-classes" class="form-control" value="6">
                        </div>
                    </div>
                    <hr>
                    <h6>ğŸ“š ç§‘ç›®ä¸å¸ˆèµ„è®¾ç½®</h6>
                    <div class="alert alert-light border small">
                        <strong>è¯´æ˜ï¼š</strong> <br>
                        1. åœ¨â€œæŒ‡å®šè€å¸ˆå§“åâ€ä¸­è¾“å…¥åå­—ï¼Œç”¨<b>ç©ºæ ¼</b>æˆ–<b>é€—å·</b>åˆ†éš”ã€‚<br>
                        2. å¦‚æœæŒ‡å®šçš„åå­—å°‘äºéœ€è¦çš„è€å¸ˆæ•°é‡ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¡¥å…¨ï¼ˆå¦‚ "è¯­æ–‡è€å¸ˆ3"ï¼‰ã€‚<br>
                        3. ç¤ºä¾‹ï¼šè¾“å…¥ "å¼ ä¼Ÿ, æå¨œ"ï¼Œç³»ç»Ÿä¼šä¼˜å…ˆå®‰æ’è¿™ä¸¤ä½ï¼Œä¸å¤Ÿå†è‡ªåŠ¨ç”Ÿæˆã€‚
                    </div>
                    <table class="table table-sm align-middle">
                        <thead>
                            <tr>
                                <th style="width: 15%">ç§‘ç›®åç§°</th>
                                <th style="width: 15%">æ¯å‘¨èŠ‚æ•°</th>
                                <th>æŒ‡å®šè€å¸ˆå§“å (å¯é€‰)</th>
                                <th style="width: 10%">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="course-settings-body">
                        </tbody>
                    </table>
                    <button class="btn btn-sm btn-outline-primary" onclick="addCourseRow()">+ æ–°å¢ç§‘ç›®</button>
                    <div class="mt-3 text-end">
                        å½“å‰æ€»è¯¾æ—¶: <span id="total-hours" class="fw-bold text-primary">0</span> / 45
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal"
                        onclick="saveSettingsAndInit()">ğŸ’¾ ä¿å­˜å¹¶ç”Ÿæˆè¯¾è¡¨</button>
                </div>
            </div>
        </div>
    </div>

    <!-- é«˜çº§è®¾ç½®æ¨¡æ€æ¡† -->
    <div class="modal fade" id="constraintModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">âš™ï¸ é«˜çº§æ’è¯¾è®¾ç½®</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">é€‰æ‹©è€å¸ˆè¿›è¡Œé…ç½®</label>
                        <select id="constraint-teacher-select" class="form-select" onchange="renderConstraintGrid()">
                            <option value="">è¯·é€‰æ‹©...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label d-flex justify-content-between">
                            <span>ç¦æ’æ—¶é—´è®¾ç½®</span>
                            <small class="text-muted"><span style="color: #ff4d4d">â– </span> ç‚¹å‡»çº¢è‰²æ ¼å­è¡¨ç¤ºç¦æ’</small>
                        </label>
                        <div class="table-responsive">
                            <table class="table table-bordered text-center table-sm small" id="constraint-grid">
                                <thead>
                                    <tr>
                                        <th style="width: 40px"></th>
                                        <th>å‘¨ä¸€</th>
                                        <th>å‘¨äºŒ</th>
                                        <th>å‘¨ä¸‰</th>
                                        <th>å‘¨å››</th>
                                        <th>å‘¨äº”</th>
                                    </tr>
                                </thead>
                                <tbody id="constraint-tbody">
                                    <!-- JSæ¸²æŸ“ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="saveSettings()">ä¿å­˜é…ç½®</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç»Ÿè®¡çœ‹æ¿æ¨¡æ€æ¡† -->
    <div class="modal fade" id="statisticsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ğŸ“Š è¯¾è¡¨ç»Ÿè®¡åˆ†æ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="statsTabs">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab"
                                data-bs-target="#tab-workload">å·¥ä½œé‡å¯¹æ¯”</button>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="tab-workload">
                            <div style="height: 400px;">
                                <canvas id="workloadChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let globalSchedule = {};
        let globalTeachers = []; // å­˜å‚¨è€å¸ˆåˆ—è¡¨
        let currentView = 'class'; // å½“å‰è§†å›¾æ¨¡å¼: 'class' æˆ– 'teacher'
        let leaveRequests = [];
        const DAYS = ["å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”"];
        let globalConstraints = { teacher_unavailable: {} }; // å­˜å‚¨é«˜çº§è®¾ç½®
        // ç»Ÿè®¡æ¨¡å—å˜é‡
        let currentStats = null;
        let statsModalVar = null;
        let workloadChart = null;

        // ============ ç»Ÿè®¡çœ‹æ¿é€»è¾‘ ============
        function openStatistics() {
            if (!statsModalVar) {
                statsModalVar = new bootstrap.Modal(document.getElementById('statisticsModal'));
            }
            statsModalVar.show();
            // å»¶è¿Ÿæ¸²æŸ“
            setTimeout(renderCharts, 300);
        }

        function renderCharts() {
            if (!currentStats) return;
            const ctx = document.getElementById('workloadChart').getContext('2d');
            if (workloadChart) workloadChart.destroy();

            const labels = Object.keys(currentStats).sort();
            const data = labels.map(n => currentStats[n].total);

            workloadChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å‘¨è¯¾æ—¶æ€»æ•°',
                        data: data,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // ============ é«˜çº§è®¾ç½®é€»è¾‘ ============
        let constraintModalVar = null;

        function openSettings() {
            if (!constraintModalVar) {
                constraintModalVar = new bootstrap.Modal(document.getElementById('constraintModal'));
            }

            // å¡«å……è€å¸ˆä¸‹æ‹‰æ¡†
            const select = document.getElementById('constraint-teacher-select');
            // ä¿æŒç¬¬ä¸€ä¸ªé€‰é¡¹
            select.innerHTML = '<option value="">è¯·é€‰æ‹©...</option>';

            if (globalTeachers && globalTeachers.length > 0) {
                // ä½¿ç”¨å·²ç”Ÿæˆçš„è€å¸ˆæ•°æ®
                globalTeachers.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t.name;
                    opt.innerText = `${t.name} (${t.subject})`;
                    select.appendChild(opt);
                });
            } else {
                // å¦‚æœè¿˜æ²¡ç”Ÿæˆè¿‡è€å¸ˆï¼Œå°è¯•ä»é…ç½®ä¸­è§£æï¼ˆå…¼å®¹æ€§å¤„ç†ï¼‰
                if (config.courses) {
                    let names = new Set();
                    config.courses.forEach(c => {
                        if (c.teachers) {
                            c.teachers.split(/[,ï¼Œ\s]+/).forEach(n => {
                                if (n) names.add(n);
                            });
                        }
                    });
                    names.forEach(n => {
                        const opt = document.createElement('option');
                        opt.value = n;
                        opt.innerText = n;
                        select.appendChild(opt);
                    });
                }
            }

            // æ¸…ç©ºç½‘æ ¼
            document.getElementById('constraint-tbody').innerHTML = '';

            constraintModalVar.show();
        }

        function renderConstraintGrid() {
            const tbody = document.getElementById('constraint-tbody');
            const teacherName = document.getElementById('constraint-teacher-select').value;
            tbody.innerHTML = '';

            if (!teacherName) return;

            // è·å–è¯¥è€å¸ˆç°æœ‰çš„ç¦æ’è®¾ç½®
            const unavailable = globalConstraints.teacher_unavailable[teacherName] || [];

            // è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥æ˜¯å¦è¢«ç¦ç”¨
            const isUnavailable = (d, p) => unavailable.some(u => u[0] === d && u[1] === p);

            for (let p = 0; p < 9; p++) {
                const tr = document.createElement('tr');
                const th = document.createElement('th');
                th.innerText = p + 1;
                tr.appendChild(th);

                for (let d = 0; d < 5; d++) {
                    const td = document.createElement('td');
                    td.className = 'constraint-cell';
                    if (isUnavailable(d, p)) {
                        td.classList.add('unavailable');
                    }
                    td.onclick = () => toggleConstraint(teacherName, d, p, td);
                    tr.appendChild(td);
                }
                tbody.appendChild(tr);
            }
        }

        function toggleConstraint(teacherName, day, period, td) {
            if (!globalConstraints.teacher_unavailable[teacherName]) {
                globalConstraints.teacher_unavailable[teacherName] = [];
            }

            const list = globalConstraints.teacher_unavailable[teacherName];
            const index = list.findIndex(u => u[0] === day && u[1] === period);

            if (index >= 0) {
                // ç§»é™¤
                list.splice(index, 1);
                td.classList.remove('unavailable');
            } else {
                // æ·»åŠ 
                list.push([day, period]);
                td.classList.add('unavailable');
            }
        }

        function saveSettings() {
            constraintModalVar.hide();
        }

        // é»˜è®¤é…ç½®
        let config = {
            num_classes: 4,
            courses: [
                { name: "è¯­æ–‡", count: 6, teachers: "å¼ ä¼Ÿ, æå¨œ" },
                { name: "æ•°å­¦", count: 5, teachers: "ç‹å†›" },
                { name: "è‹±è¯­", count: 4, teachers: "Miss Li" },
                { name: "ä½“è‚²", count: 3, teachers: "" },
                { name: "ç¾æœ¯", count: 2, teachers: "" },
                { name: "éŸ³ä¹", count: 2, teachers: "" },
                { name: "ç§‘å­¦", count: 2, teachers: "" }
            ]
        };

        window.onload = function () {
            renderSettings();
            updateTotalHours();
        };

        function renderSettings() {
            document.getElementById('setting-num-classes').value = config.num_classes;
            const tbody = document.getElementById('course-settings-body');
            tbody.innerHTML = '';

            config.courses.forEach((c) => {
                addCourseRow(c.name, c.count, c.teachers);
            });
        }

        function addCourseRow(name = "", count = 2, teachers = "") {
            const tbody = document.getElementById('course-settings-body');
            const tr = document.createElement('tr');
            tr.innerHTML = `
            <td><input type="text" class="form-control form-control-sm course-name" value="${name}" placeholder="ç§‘ç›®"></td>
            <td><input type="number" class="form-control form-control-sm course-count" value="${count}" onchange="updateTotalHours()"></td>
            <td><input type="text" class="form-control form-control-sm course-teachers" value="${teachers}" placeholder="ä¾‹å¦‚: å¼ ä¸‰, æå››"></td>
            <td><button class="btn btn-sm btn-outline-danger" onclick="removeCourseRow(this)">åˆ é™¤</button></td>
        `;
            tbody.appendChild(tr);
            updateTotalHours();
        }

        function removeCourseRow(btn) {
            btn.closest('tr').remove();
            updateTotalHours();
        }

        function updateTotalHours() {
            const rows = document.querySelectorAll('#course-settings-body tr');
            let total = 0;
            rows.forEach(row => {
                const count = parseInt(row.querySelector('.course-count').value) || 0;
                total += count;
            });
            const el = document.getElementById('total-hours');
            el.innerText = total;
            el.className = total > 45 ? "fw-bold text-danger" : "fw-bold text-primary";
        }

        function saveSettingsAndInit() {
            // 1. è¯»å–è®¾ç½®
            config.num_classes = parseInt(document.getElementById('setting-num-classes').value);
            const rows = document.querySelectorAll('#course-settings-body tr');

            let newCourses = [];
            let coursesDict = {};
            let teacherNamesDict = {};
            let total = 0;

            rows.forEach(row => {
                const name = row.querySelector('.course-name').value.trim();
                const count = parseInt(row.querySelector('.course-count').value);
                const teacherStr = row.querySelector('.course-teachers').value.trim();

                if (name && count > 0) {
                    // ä¿å­˜åˆ°æœ¬åœ° config ç”¨äºå›æ˜¾
                    newCourses.push({ name, count, teachers: teacherStr });

                    // å‡†å¤‡å‘ç»™åç«¯çš„æ ¼å¼
                    coursesDict[name] = count;
                    total += count;

                    if (teacherStr) {
                        // å…¼å®¹ä¸­æ–‡é€—å·å’Œç©ºæ ¼
                        const names = teacherStr.split(/[,ï¼Œ\s]+/).filter(n => n.length > 0);
                        if (names.length > 0) {
                            teacherNamesDict[name] = names;
                        }
                    }
                }
            });

            config.courses = newCourses;

            if (total > 45) {
                alert(`âš ï¸ æ³¨æ„ï¼šæ€»è¯¾æ—¶ (${total}) è¶…è¿‡äº†æ¯å‘¨å®¹é‡ (45)ï¼\nå¤šå‡ºçš„è¯¾ç¨‹å¯èƒ½æ— æ³•å®‰æ’ã€‚`);
            }

            // 2. å‘èµ·è¯·æ±‚
            const payload = {
                num_classes: config.num_classes,
                courses: coursesDict,
                teacher_names: teacherNamesDict
            };

            initSystem(payload);
        }

        async function initSystem(customPayload = null) {
            const btn = document.getElementById('btn-init');
            const spinner = document.getElementById('init-spinner');
            const status = document.getElementById('system-status');

            btn.disabled = true;
            spinner.classList.remove('d-none');
            status.innerText = "è®¡ç®—ä¸­...";

            let payload = customPayload;
            if (!payload) {
                // å¦‚æœç‚¹å‡»çš„æ˜¯åˆå§‹åŒ–æŒ‰é’®è€Œä¸æ˜¯ä¿å­˜æŒ‰é’®ï¼Œä½¿ç”¨å½“å‰é»˜è®¤é…ç½®æ„é€  payload
                let cDict = {};
                let tDict = {};
                config.courses.forEach(c => {
                    cDict[c.name] = c.count;
                    if (c.teachers) tDict[c.name] = c.teachers.split(/[,ï¼Œ\s]+/).filter(n => n);
                });
                payload = {
                    num_classes: config.num_classes,
                    courses: cDict,
                    teacher_names: tDict
                };
            }

            // æ·»åŠ é«˜çº§çº¦æŸ
            payload.constraints = globalConstraints;

            try {
                const response = await fetch('/api/init', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();

                if (data.status === 'success') {
                    updateUI(data);
                    status.innerText = "âœ… æ’è¯¾æˆåŠŸ";
                    status.className = "text-center text-success fw-bold mb-3";
                    clearErrorAlert(); // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯æç¤º
                } else {
                    // æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤º
                    showErrorAlert(data);
                    status.innerText = "âŒ å¤±è´¥";
                    status.className = "text-center text-danger fw-bold mb-3";
                }
            } catch (e) {
                console.error(e);
                showErrorAlert({
                    error_type: "network_error",
                    message: "ç½‘ç»œè¯·æ±‚å¤±è´¥",
                    suggestions: ["è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥", "åˆ·æ–°é¡µé¢é‡è¯•"]
                });
                status.innerText = "âŒ ç½‘ç»œé”™è¯¯";
            } finally {
                btn.disabled = false;
                spinner.classList.add('d-none');
            }
        }

        function updateUI(data) {
            // ä¿å­˜ç»Ÿè®¡æ•°æ®å¹¶å¯ç”¨çœ‹æ¿æŒ‰é’®
            if (data.stats) {
                currentStats = data.stats;
                document.getElementById('btn-stats').disabled = false;
            }

            // ä¿å­˜è€å¸ˆåˆ—è¡¨åˆ°å…¨å±€å˜é‡
            globalTeachers = data.teachers || [];

            // æ›´æ–°è€å¸ˆä¸‹æ‹‰æ¡†ï¼ˆè¯·å‡ç®¡ç†ç”¨ï¼‰
            const teacherSelect = document.getElementById('teacher-select');
            teacherSelect.innerHTML = '';
            globalTeachers.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.name;
                opt.innerText = t.name;
                teacherSelect.appendChild(opt);
            });

            // æ›´æ–°è€å¸ˆè§†å›¾ä¸‹æ‹‰æ¡†
            const teacherViewSelect = document.getElementById('teacher-view-select');
            teacherViewSelect.innerHTML = '';
            globalTeachers.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.name;
                opt.innerText = t.name;
                teacherViewSelect.appendChild(opt);
            });

            // æ›´æ–°ç­çº§ä¸‹æ‹‰æ¡†
            const classSelect = document.getElementById('class-select');
            classSelect.innerHTML = '';
            Object.keys(data.schedule).forEach(cid => {
                const opt = document.createElement('option');
                opt.value = cid;
                opt.innerText = cid + " ç­";
                classSelect.appendChild(opt);
            });

            globalSchedule = data.schedule;
            renderCurrentClass();

            // å¯ç”¨æ‰€æœ‰æŒ‰é’®
            teacherSelect.disabled = false;
            document.getElementById('btn-add-leave').disabled = false;
            document.getElementById('btn-apply').disabled = false;
            document.getElementById('btn-save').disabled = false;
            document.getElementById('btn-export-current').disabled = false;
            document.getElementById('btn-export-all').disabled = false;
            document.getElementById('btn-view-teacher').disabled = false; // å¯ç”¨è€å¸ˆè§†å›¾æŒ‰é’®
        }

        // --- æ¸²æŸ“ä¸è¯·å‡é€»è¾‘ ---
        function renderCurrentClass() {
            const classId = document.getElementById('class-select').value;
            const tbody = document.getElementById('schedule-body');
            const title = document.getElementById('class-title');

            if (!classId || !globalSchedule[classId]) return;
            title.innerText = `${classId} ç­ è¯¾è¡¨`;
            tbody.innerHTML = '';

            const classData = globalSchedule[classId];
            for (let p = 0; p < 9; p++) {
                const tr = document.createElement('tr');
                const th = document.createElement('th'); th.innerText = `ç¬¬ ${p + 1} èŠ‚`; tr.appendChild(th);
                for (let d = 0; d < 5; d++) {
                    const td = document.createElement('td');
                    td.className = "draggable-cell"; // æ·»åŠ åŸºç¡€ç±»

                    // æ·»åŠ æ‹–æ‹½äº‹ä»¶
                    td.setAttribute('draggable', 'true');
                    td.setAttribute('ondragstart', `handleDragStart(event, ${p}, ${d})`);
                    td.setAttribute('ondragover', 'handleDragOver(event)');
                    td.setAttribute('ondrop', `handleDrop(event, ${p}, ${d})`);
                    td.setAttribute('ondragleave', 'handleDragLeave(event)');
                    td.setAttribute('ondragend', 'handleDragEnd(event)');

                    const info = classData[p][d];
                    if (info) {
                        if (info.is_sub) {
                            td.classList.add(info.teacher_name === "ã€è‡ªä¹ ã€‘" ? "status-empty" : "status-sub");
                        }
                        td.innerHTML = `<div class="course-cell">${info.subject}</div><span class="teacher-name">${info.teacher_name}</span>`;
                    }
                    tr.appendChild(td);
                }
                tbody.appendChild(tr);
            }
        }

        // ============ æ‹–æ‹½è°ƒè¯¾é€»è¾‘ ============
        let draggedSource = null;

        function handleDragStart(e, period, day) {
            draggedSource = { period, day };
            e.target.classList.add('drag-source');
            // è®¾ç½®æ•°æ®ï¼ˆè™½ç„¶æˆ‘ä»¬ç”¨å…¨å±€å˜é‡ï¼Œä½†ä¸ºäº†å…¼å®¹æ€§è¿˜æ˜¯è®¾ç½®ä¸€ä¸‹ï¼‰
            e.dataTransfer.setData('text/plain', JSON.stringify({ period, day }));
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            e.preventDefault(); // å…è®¸æ”¾ç½®
            e.dataTransfer.dropEffect = 'move';

            // æ‰¾åˆ°æœ€è¿‘çš„ td ç¥–å…ˆ
            const td = e.target.closest('td');
            if (td && !td.classList.contains('drag-source')) {
                td.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            const td = e.target.closest('td');
            if (td) {
                td.classList.remove('drag-over');
            }
        }

        function handleDragEnd(e) {
            e.target.classList.remove('drag-source');
            // æ¸…ç†æ‰€æœ‰é«˜äº®
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        }

        async function handleDrop(e, targetPeriod, targetDay) {
            e.preventDefault();
            handleDragEnd(e); // æ¸…ç†æ ·å¼

            if (!draggedSource) return;

            const sourcePeriod = draggedSource.period;
            const sourceDay = draggedSource.day;

            // å¦‚æœä½ç½®æ²¡å˜ï¼Œç›´æ¥è¿”å›
            if (sourcePeriod === targetPeriod && sourceDay === targetDay) return;

            const classId = document.getElementById('class-select').value;

            // è°ƒç”¨åç«¯API
            try {
                const response = await fetch('/api/schedule/move', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        class_id: classId,
                        from_slot: [sourceDay, sourcePeriod], // åç«¯æ ¼å¼ (day, period)
                        to_slot: [targetDay, targetPeriod]
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    // æ›´æ–°å…¨å±€è¯¾è¡¨
                    globalSchedule = data.schedule;
                    renderCurrentClass();

                    // æ˜¾ç¤ºç®€å•çš„æˆåŠŸæç¤º
                    // å¯ä»¥è€ƒè™‘ç”¨ toastï¼Œè¿™é‡Œç®€å•ç”¨ console
                    console.log(`è°ƒè¯¾æˆåŠŸ: ${data.message}`);

                    // å¦‚æœæœ‰ä»£è¯¾æ—¥å¿—åŠŸèƒ½ï¼Œä¹Ÿå¯ä»¥æ˜¾ç¤ºä¸€æ¡æ—¥å¿—
                    // showGenericLog("è°ƒè¯¾", data.message); 
                } else {
                    alert(`è°ƒè¯¾å¤±è´¥: ${data.message}`);
                }
            } catch (err) {
                console.error(err);
                alert('ç³»ç»Ÿé”™è¯¯: ' + err.message);
            }

            draggedSource = null;
        }

        function addLeave() {
            const name = document.getElementById('teacher-select').value;
            const start = document.getElementById('start-day').value;
            const end = document.getElementById('end-day').value;
            const map = { "å‘¨ä¸€": 0, "å‘¨äºŒ": 1, "å‘¨ä¸‰": 2, "å‘¨å››": 3, "å‘¨äº”": 4 };

            if (map[start] > map[end]) { alert("æ—¥æœŸé¡ºåºé”™è¯¯"); return; }

            const days = [];
            for (let i = map[start]; i <= map[end]; i++) days.push(DAYS[i]);
            leaveRequests.push({ name, days });
            renderLeaveList();
        }

        function renderLeaveList() {
            const list = document.getElementById('leave-list');
            list.innerHTML = '';
            leaveRequests.forEach((req, idx) => {
                list.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center">
                <span>${req.name} <small class="text-muted">(${req.days.join(',')})</small></span>
                <button class="btn btn-sm btn-outline-danger" onclick="leaveRequests.splice(${idx},1);renderLeaveList()">Ã—</button>
            </li>`;
            });
        }

        async function applySubstitutions() {
            const btn = document.getElementById('btn-apply');
            btn.disabled = true; btn.innerText = "è®¡ç®—ä¸­...";
            try {
                const resp = await fetch('/api/substitute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ leaves: leaveRequests })
                });
                const data = await resp.json();
                if (data.status === 'success') {
                    globalSchedule = data.schedule;
                    renderCurrentClass();
                    alert("ä»£è¯¾å®‰æ’å®Œæˆï¼");
                } else {
                    alert("é”™è¯¯: " + data.message);
                }
            } finally {
                btn.disabled = false; btn.innerText = "ğŸ”„ æ‰§è¡Œæ™ºèƒ½ä»£è¯¾";
            }
        }

        // ============ è¯¾è¡¨æ–¹æ¡ˆç®¡ç†åŠŸèƒ½ ============

        // é¡µé¢åŠ è½½æ—¶è·å–å·²ä¿å­˜æ–¹æ¡ˆåˆ—è¡¨
        window.addEventListener('DOMContentLoaded', function () {
            loadSavedList();
        });

        async function loadSavedList() {
            try {
                const resp = await fetch('/api/list');
                const data = await resp.json();

                const listEl = document.getElementById('saved-list');

                if (data.status === 'success' && data.schedules && data.schedules.length > 0) {
                    listEl.innerHTML = '';
                    data.schedules.forEach(s => {
                        const item = document.createElement('div');
                        item.className = 'list-group-item d-flex justify-content-between align-items-start p-2';
                        item.innerHTML = `
                            <div class="flex-grow-1" style="cursor: pointer;" onclick="loadSchedule('${s.name}')">
                                <strong>${s.name}</strong>
                                <div class="text-muted" style="font-size: 0.75rem;">${s.created_at}</div>
                            </div>
                            <button class="btn btn-sm btn-outline-danger py-0 px-1" onclick="deleteSchedule('${s.name}', event)" title="åˆ é™¤">Ã—</button>
                        `;
                        listEl.appendChild(item);
                    });
                } else {
                    listEl.innerHTML = '<div class="text-center text-muted py-2">æš‚æ— ä¿å­˜æ–¹æ¡ˆ</div>';
                }
            } catch (e) {
                console.error('åŠ è½½æ–¹æ¡ˆåˆ—è¡¨å¤±è´¥:', e);
            }
        }

        async function saveCurrentSchedule() {
            const name = document.getElementById('save-name').value.trim();

            if (!name) {
                alert('è¯·è¾“å…¥æ–¹æ¡ˆåç§°');
                return;
            }

            if (!globalSchedule || Object.keys(globalSchedule).length === 0) {
                alert('æ²¡æœ‰å¯ä¿å­˜çš„è¯¾è¡¨');
                return;
            }

            try {
                const resp = await fetch('/api/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        config: config
                    })
                });

                const data = await resp.json();

                if (data.status === 'success') {
                    alert(`âœ… ${data.message}`);
                    document.getElementById('save-name').value = '';
                    loadSavedList(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    alert(`âŒ ${data.message}`);
                }
            } catch (e) {
                alert('ä¿å­˜å¤±è´¥: ' + e.message);
            }
        }

        async function loadSchedule(name) {
            if (!confirm(`ç¡®å®šè¦åŠ è½½æ–¹æ¡ˆ"${name}"å—ï¼Ÿå½“å‰è¯¾è¡¨å°†è¢«æ›¿æ¢ã€‚`)) {
                return;
            }

            try {
                const resp = await fetch('/api/load', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name })
                });

                const data = await resp.json();

                if (data.status === 'success') {
                    // æ›´æ–°å…¨å±€æ•°æ®
                    globalSchedule = data.schedule;

                    // æ›´æ–°UI
                    updateUIAfterLoad(data);

                    alert(`âœ… å·²åŠ è½½æ–¹æ¡ˆ"${name}"`);
                } else {
                    alert(`âŒ ${data.message}`);
                }
            } catch (e) {
                alert('åŠ è½½å¤±è´¥: ' + e.message);
            }
        }

        function updateUIAfterLoad(data) {
            // æ›´æ–°ç­çº§ä¸‹æ‹‰æ¡†
            const classSelect = document.getElementById('class-select');
            classSelect.innerHTML = '';
            Object.keys(data.schedule).forEach(cid => {
                const opt = document.createElement('option');
                opt.value = cid;
                opt.innerText = cid + " ç­";
                classSelect.appendChild(opt);
            });

            // æ›´æ–°è€å¸ˆä¸‹æ‹‰æ¡†
            const teacherSelect = document.getElementById('teacher-select');
            teacherSelect.innerHTML = '';
            if (data.teachers && data.teachers.length > 0) {
                data.teachers.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t.name;
                    opt.innerText = t.name;
                    teacherSelect.appendChild(opt);
                });
            }

            // æ¸²æŸ“è¯¾è¡¨
            renderCurrentClass();

            // å¯ç”¨åŠŸèƒ½æŒ‰é’®
            teacherSelect.disabled = false;
            document.getElementById('btn-add-leave').disabled = false;
            document.getElementById('btn-apply').disabled = false;
            document.getElementById('btn-save').disabled = false;
            document.getElementById('btn-export-current').disabled = false;
            document.getElementById('btn-export-all').disabled = false;

            // æ›´æ–°çŠ¶æ€
            const status = document.getElementById('system-status');
            status.innerText = `âœ… å·²åŠ è½½ (${data.created_at || ''})`;
            status.className = "text-center text-info fw-bold mb-3";
        }

        async function deleteSchedule(name, event) {
            event.stopPropagation(); // é˜²æ­¢è§¦å‘åŠ è½½äº‹ä»¶

            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ–¹æ¡ˆ"${name}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
                return;
            }

            try {
                const resp = await fetch('/api/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name })
                });

                const data = await resp.json();

                if (data.status === 'success') {
                    alert(`âœ… ${data.message}`);
                    loadSavedList(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    alert(`âŒ ${data.message}`);
                }
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥: ' + e.message);
            }
        }

        // ============ Excelå¯¼å‡ºåŠŸèƒ½ ============

        function exportCurrentClass() {
            const classId = document.getElementById('class-select').value;

            if (!classId) {
                alert('è¯·å…ˆé€‰æ‹©è¦å¯¼å‡ºçš„ç­çº§');
                return;
            }

            // ç›´æ¥æ‰“å¼€ä¸‹è½½é“¾æ¥
            window.location.href = `/api/export/class/${classId}`;
        }

        function exportAllClasses() {
            if (!confirm('ç¡®å®šè¦å¯¼å‡ºæ‰€æœ‰ç­çº§çš„è¯¾è¡¨å—ï¼Ÿ')) {
                return;
            }
            // ç›´æ¥æ‰“å¼€ä¸‹è½½é“¾æ¥
            window.location.href = '/api/export/all_classes';
        }

        // ============ è€å¸ˆè§†å›¾åŠŸèƒ½ ============

        function switchView(mode) {
            currentView = mode;

            const classBtn = document.getElementById('btn-view-class');
            const teacherBtn = document.getElementById('btn-view-teacher');
            const classSelector = document.getElementById('class-selector-group');
            const teacherSelector = document.getElementById('teacher-selector-group');
            const title = document.getElementById('class-title');

            if (mode === 'class') {
                // åˆ‡æ¢åˆ°ç­çº§è§†å›¾
                classBtn.classList.add('active');
                teacherBtn.classList.remove('active');
                classSelector.style.display = 'flex';
                teacherSelector.style.display = 'none';
                title.innerText = 'ç­çº§è¯¾è¡¨';
                renderCurrentClass();
            } else if (mode === 'teacher') {
                // åˆ‡æ¢åˆ°è€å¸ˆè§†å›¾
                classBtn.classList.remove('active');
                teacherBtn.classList.add('active');
                classSelector.style.display = 'none';
                teacherSelector.style.display = 'flex';
                title.innerText = 'è€å¸ˆè¯¾è¡¨';
                renderCurrentTeacher();
            }
        }

        async function renderCurrentTeacher() {
            const teacherName = document.getElementById('teacher-view-select').value;

            if (!teacherName) {
                return;
            }

            try {
                const resp = await fetch('/api/teacher_view', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ teacher_name: teacherName })
                });

                const data = await resp.json();

                if (data.status === 'success') {
                    renderTeacherSchedule(data.schedule);
                } else {
                    alert(`é”™è¯¯: ${data.message}`);
                }
            } catch (e) {
                alert('è·å–è€å¸ˆè¯¾è¡¨å¤±è´¥: ' + e.message);
            }
        }

        function renderTeacherSchedule(schedule) {
            const tbody = document.getElementById('schedule-body');
            tbody.innerHTML = '';

            for (let p = 0; p < 9; p++) {
                const tr = document.createElement('tr');
                const th = document.createElement('th');
                th.innerText = `ç¬¬ ${p + 1} èŠ‚`;
                tr.appendChild(th);

                for (let d = 0; d < 5; d++) {
                    const td = document.createElement('td');
                    const periodData = schedule[p];
                    const info = periodData ? periodData[d] : null;

                    if (info) {
                        // æ˜¾ç¤ºç­çº§å’Œç§‘ç›®
                        td.className = info.is_sub ? 'status-sub' : '';
                        td.innerHTML = `<div class="course-cell">${info.class_id}ç­</div><span class="teacher-name">${info.subject}</span>`;
                    }

                    tr.appendChild(td);
                }

                tbody.appendChild(tr);
            }
        }

        // ============ é”™è¯¯æç¤ºåŠŸèƒ½ ============

        function showErrorAlert(errorData) {
            const container = document.getElementById('error-alert-container');

            // ç¡®å®šé”™è¯¯ç±»å‹å¯¹åº”çš„æ ·å¼
            let alertClass = 'alert-warning';
            let icon = 'âš ï¸';

            if (errorData.error_type === 'system_error' || errorData.error_type === 'network_error') {
                alertClass = 'alert-danger';
                icon = 'âŒ';
            } else if (errorData.error_type === 'schedule_overload') {
                alertClass = 'alert-warning';
                icon = 'âš ï¸';
            }

            // æ„å»ºå»ºè®®åˆ—è¡¨HTML
            let suggestionsHTML = '';
            if (errorData.suggestions && errorData.suggestions.length > 0) {
                suggestionsHTML = '<div class="mt-2"><strong>ğŸ’¡ å»ºè®®ï¼š</strong><ul class="mb-0 mt-1">';
                errorData.suggestions.forEach(suggestion => {
                    suggestionsHTML += `<li>${suggestion}</li>`;
                });
                suggestionsHTML += '</ul></div>';
            }

            // åˆ›å»ºé”™è¯¯æç¤ºæ¡†
            container.innerHTML = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    <h6 class="alert-heading">${icon} ${errorData.message || 'æ’è¯¾å¤±è´¥'}</h6>
                    ${suggestionsHTML}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }

        function clearErrorAlert() {
            const container = document.getElementById('error-alert-container');
            container.innerHTML = '';
        }

        // ============ ä»£è¯¾æ—¥å¿—æ˜¾ç¤ºåŠŸèƒ½ ============

        function showSubstitutionLogs(stats, logs) {
            // æ˜¾ç¤ºæ—¥å¿—å®¹å™¨
            const container = document.getElementById('substitution-logs-container');
            container.style.display = 'block';

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            document.getElementById('stat-direct').textContent = stats.direct || 0;
            document.getElementById('stat-swap').textContent = stats.swap || 0;
            document.getElementById('stat-self').textContent = stats.self_study || 0;

            // è®¡ç®—æ€»æ‰°åŠ¨åº¦
            const totalScore = (stats.direct || 0) * 0 + (stats.swap || 0) * 1 + (stats.self_study || 0) * 999;
            document.getElementById('stat-score').textContent = totalScore;

            // æ˜¾ç¤ºè¯¦ç»†æ—¥å¿—
            const logsContainer = document.getElementById('sub-logs');
            if (logs && logs.length > 0) {
                logsContainer.innerHTML = logs.map(log => {
                    const colorClass = log.type === 'self_study' ? 'text-danger' : 'text-success';
                    return `<div class="${colorClass}" style="margin-bottom: 4px;">${log.message}</div>`;
                }).join('');
            } else {
                logsContainer.innerHTML = '<div class="text-muted text-center">æš‚æ— æ—¥å¿—</div>';
            }

            // æ»šåŠ¨åˆ°å®¹å™¨
            setTimeout(() => container.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 100);
        }

        window.showSubstitutionLogs = showSubstitutionLogs;

        // ============ è¯·å‡ç®¡ç†åŠŸèƒ½ ============

        function addLeave() {
            const teacherSelect = document.getElementById('teacher-select');
            const startDaySelect = document.getElementById('start-day');
            const endDaySelect = document.getElementById('end-day');

            const teacherName = teacherSelect.value;
            const startDay = startDaySelect.value;
            const endDay = endDaySelect.value;

            if (!teacherName) {
                alert('è¯·é€‰æ‹©è€å¸ˆ');
                return;
            }

            if (!startDay || !endDay) {
                alert('è¯·é€‰æ‹©è¯·å‡æ—¶é—´èŒƒå›´');
                return;
            }

            // æ„å»ºæ—¥æœŸèŒƒå›´æ•°ç»„
            const dayOrder = ["å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”"];
            const startIndex = dayOrder.indexOf(startDay);
            const endIndex = dayOrder.indexOf(endDay);

            if (startIndex > endIndex) {
                alert('èµ·å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ');
                return;
            }

            const selectedDays = dayOrder.slice(startIndex, endIndex + 1);

            // æ·»åŠ è¯·å‡è®°å½•
            leaveRequests.push({
                name: teacherName,
                days: selectedDays
            });

            // æ›´æ–°æ˜¾ç¤º
            updateLeaveList();
        }

        function updateLeaveList() {
            const list = document.getElementById('leave-list');

            if (leaveRequests.length === 0) {
                list.innerHTML = '';
                return;
            }

            list.innerHTML = leaveRequests.map((req, index) => `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>
                        <strong>${req.name}</strong>
                        <br>
                        <small class="text-muted">${req.days.join(', ')}</small>
                    </span>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeLeave(${index})">Ã—</button>
                </li>
            `).join('');
        }

        function removeLeave(index) {
            leaveRequests.splice(index, 1);
            updateLeaveList();
        }

        async function applySubstitutions() {
            if (leaveRequests.length === 0) {
                alert('è¯·å…ˆæ·»åŠ è¯·å‡æ¡');
                return;
            }

            if (!globalSchedule || Object.keys(globalSchedule).length === 0) {
                alert('è¯·å…ˆç”Ÿæˆè¯¾è¡¨');
                return;
            }

            const btn = document.getElementById('btn-apply');
            btn.disabled = true;
            btn.innerHTML = 'â³ å¤„ç†ä¸­...';

            try {
                const response = await fetch('/api/substitute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ leaves: leaveRequests })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    // æ›´æ–°è¯¾è¡¨
                    globalSchedule = data.schedule;
                    renderCurrentClass();

                    // æ˜¾ç¤ºæ—¥å¿— â­ å…³é”®é›†æˆç‚¹
                    if (data.stats && data.logs) {
                        showSubstitutionLogs(data.stats, data.logs);
                    }

                    alert('âœ… ä»£è¯¾å¤„ç†å®Œæˆï¼');

                    // æ¸…ç©ºè¯·å‡åˆ—è¡¨
                    leaveRequests = [];
                    updateLeaveList();
                } else {
                    alert(`âŒ ä»£è¯¾å¤±è´¥: ${data.message}`);
                }
            } catch (e) {
                console.error(e);
                alert('å¤„ç†å¤±è´¥: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ğŸ”„ æ‰§è¡Œæ™ºèƒ½ä»£è¯¾';
            }
        }

    </script>
</body>

</html>